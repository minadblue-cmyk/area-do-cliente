<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Carregamento de Agentes</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #1a1a1a; color: #fff; }
        .container { max-width: 1000px; margin: 0 auto; }
        .section { background: #2a2a2a; padding: 20px; margin: 10px 0; border-radius: 8px; }
        .success { color: #4ade80; }
        .error { color: #f87171; }
        .warning { color: #fbbf24; }
        .info { color: #60a5fa; }
        button { background: #3b82f6; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #2563eb; }
        pre { background: #1e1e1e; padding: 15px; border-radius: 5px; overflow-x: auto; }
        .agent-card { background: #1e1e1e; padding: 15px; margin: 10px 0; border-radius: 5px; border-left: 4px solid #3b82f6; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Debug Carregamento de Agentes</h1>
        
        <div class="section">
            <h2>1. Testar Webhook list-agentes</h2>
            <button onclick="testarWebhookListAgentes()">Testar Webhook</button>
            <div id="webhook"></div>
        </div>

        <div class="section">
            <h2>2. Simular Parsing da Resposta</h2>
            <button onclick="simularParsing()">Simular Parsing</button>
            <div id="parsing"></div>
        </div>

        <div class="section">
            <h2>3. Simular Filtro de Permiss√µes</h2>
            <button onclick="simularFiltro()">Simular Filtro</button>
            <div id="filtro"></div>
        </div>

        <div class="section">
            <h2>4. Verificar Console da Aplica√ß√£o</h2>
            <button onclick="verificarConsole()">Verificar Console</button>
            <div id="console"></div>
        </div>
    </div>

    <script>
        async function testarWebhookListAgentes() {
            const resultDiv = document.getElementById('webhook')
            resultDiv.innerHTML = '<p class="info">üîÑ Testando webhook list-agentes...</p>'
            
            try {
                const response = await fetch('https://n8n.code-iq.com.br/webhook/list-agentes', {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' }
                })
                
                const data = await response.json()
                console.log('üì° Resposta do webhook list-agentes:', data)
                
                resultDiv.innerHTML = `
                    <h3 class="info">üìä Resposta do Webhook list-agentes</h3>
                    <p><strong>Status:</strong> ${response.status}</p>
                    <p><strong>Tipo da resposta:</strong> ${typeof data}</p>
                    <p><strong>√â array:</strong> ${Array.isArray(data)}</p>
                    <p><strong>Primeiro item success:</strong> ${data[0]?.success || 'N/A'}</p>
                    <p><strong>Primeiro item data length:</strong> ${data[0]?.data?.length || 'N/A'}</p>
                    
                    <h4>Resposta completa:</h4>
                    <pre>${JSON.stringify(data, null, 2)}</pre>
                `
                
            } catch (error) {
                console.error('‚ùå Erro no webhook:', error)
                resultDiv.innerHTML = `<p class="error">‚ùå Erro: ${error.message}</p>`
            }
        }

        function simularParsing() {
            const resultDiv = document.getElementById('parsing')
            
            // Simular resposta do webhook (baseado no que vimos antes)
            const responseData = [
                {
                    "success": true,
                    "message": "Agentes encontrados",
                    "data": [
                        {
                            "id": 68,
                            "nome": "Joana",
                            "usuario_id": 5,
                            "ativo": true
                        },
                        {
                            "id": 65,
                            "nome": "Jo√£o",
                            "usuario_id": 6,
                            "ativo": true
                        },
                        {
                            "id": 74,
                            "nome": "Zeca",
                            "usuario_id": 5,
                            "ativo": true
                        }
                    ],
                    "total": 3
                }
            ]
            
            // Simular l√≥gica de parsing da aplica√ß√£o
            let agentesList = []
            if (Array.isArray(responseData)) {
                agentesList = responseData
            } else if (responseData.data && Array.isArray(responseData.data)) {
                agentesList = responseData.data
            } else if (responseData.success && responseData.data) {
                agentesList = responseData.data
            }
            
            // Extrair agentes do formato correto
            let agentes = []
            if (Array.isArray(agentesList) && agentesList.length > 0 && agentesList[0].success && Array.isArray(agentesList[0].data)) {
                agentes = agentesList[0].data
            } else if (agentesList.success && Array.isArray(agentesList.data)) {
                agentes = agentesList.data
            }
            
            resultDiv.innerHTML = `
                <h3 class="info">üîß Simula√ß√£o de Parsing</h3>
                <p><strong>Resposta original:</strong> Array com ${responseData.length} item(s)</p>
                <p><strong>agentesList extra√≠do:</strong> Array com ${agentesList.length} item(s)</p>
                <p><strong>agentes finais:</strong> Array com ${agentes.length} item(s)</p>
                
                <h4>Agentes extra√≠dos:</h4>
                ${agentes.map(agente => `
                    <div class="agent-card">
                        <strong>${agente.nome}</strong> (ID: ${agente.id})
                        <br>Usu√°rio ID: ${agente.usuario_id}
                        <br>Ativo: ${agente.ativo ? 'Sim' : 'N√£o'}
                    </div>
                `).join('')}
                
                <p class="${agentes.length === 3 ? 'success' : 'error'}">
                    ${agentes.length === 3 ? '‚úÖ Parsing funcionando' : '‚ùå Parsing com problema'}
                </p>
            `
        }

        function simularFiltro() {
            const resultDiv = document.getElementById('filtro')
            
            // Simular agentes
            const agentes = [
                { id: 68, nome: "Joana", usuario_id: 5, ativo: true },
                { id: 65, nome: "Jo√£o", usuario_id: 6, ativo: true },
                { id: 74, nome: "Zeca", usuario_id: 5, ativo: true }
            ]
            
            // Simular permiss√µes de admin
            const agentPermissions = {
                canViewAll: true,
                canManage: true,
                canViewOwn: false,
                canAssignAgents: false
            }
            
            const userData = { id: "5" }
            
            // Simular l√≥gica de filtro
            const agentesFiltrados = agentes.filter((agente) => {
                console.log(`üîç Filtrando agente: ${agente.nome} (usuario_id: ${agente.usuario_id})`)
                console.log(`üîç Permiss√µes: canViewAll=${agentPermissions.canViewAll}, canManage=${agentPermissions.canManage}`)
                
                // REGRA PRINCIPAL: Se √© administrador, sempre mostrar todos os agentes
                if (agentPermissions.canViewAll || agentPermissions.canManage) {
                    console.log(`‚úÖ ${agente.nome}: Mostrando (ADMIN - v√™ todos)`)
                    return true
                }
                
                // Para usu√°rios n√£o-admin: verificar apenas se o agente est√° atribu√≠do para eles
                const userId = parseInt(userData.id)
                
                // Se o agente est√° atribu√≠do para o usu√°rio atual, mostrar
                if (agente.atribuido_para_usuario === userId) {
                    console.log(`‚úÖ ${agente.nome}: Mostrando (atribu√≠do para o usu√°rio)`)
                    return true
                }
                
                // Caso contr√°rio, n√£o mostrar
                console.log(`‚ùå ${agente.nome}: Ocultando (n√£o atribu√≠do para o usu√°rio)`)
                return false
            })
            
            resultDiv.innerHTML = `
                <h3 class="info">üîß Simula√ß√£o de Filtro</h3>
                <p><strong>Total de agentes:</strong> ${agentes.length}</p>
                <p><strong>Agentes filtrados:</strong> ${agentesFiltrados.length}</p>
                <p><strong>Permiss√µes do admin:</strong> canViewAll=${agentPermissions.canViewAll}, canManage=${agentPermissions.canManage}</p>
                
                <h4>Agentes que passaram no filtro:</h4>
                ${agentesFiltrados.map(agente => `
                    <div class="agent-card">
                        <strong>${agente.nome}</strong> (ID: ${agente.id})
                        <br>Usu√°rio ID: ${agente.usuario_id}
                        <br>Motivo: ADMIN - v√™ todos
                    </div>
                `).join('')}
                
                <p class="${agentesFiltrados.length === 3 ? 'success' : 'error'}">
                    ${agentesFiltrados.length === 3 ? '‚úÖ Filtro funcionando' : '‚ùå Filtro com problema'}
                </p>
            `
        }

        function verificarConsole() {
            const resultDiv = document.getElementById('console')
            
            resultDiv.innerHTML = `
                <h3 class="info">üîç Verifica√ß√£o do Console</h3>
                
                <div class="agent-card">
                    <h4>Mensagens esperadas no console:</h4>
                    <ul>
                        <li><code>üîç Listando agentes...</code></li>
                        <li><code>üì• Resposta do webhook: {...}</code></li>
                        <li><code>‚úÖ Agentes encontrados: 3</code></li>
                        <li><code>üîç Filtrando agente: Joana (usuario_id: 5)</code></li>
                        <li><code>‚úÖ Joana: Mostrando (ADMIN - v√™ todos)</code></li>
                        <li><code>üîç Agentes filtrados: 3 de 3</code></li>
                    </ul>
                </div>
                
                <div class="agent-card">
                    <h4>Poss√≠veis problemas:</h4>
                    <ul>
                        <li>‚ùå <code>useAgentPermissions</code> retornando permiss√µes incorretas</li>
                        <li>‚ùå <code>userData</code> n√£o dispon√≠vel</li>
                        <li>‚ùå Webhook retornando erro</li>
                        <li>‚ùå Parsing da resposta falhando</li>
                    </ul>
                </div>
                
                <div class="agent-card">
                    <h4>Pr√≥ximos passos:</h4>
                    <ol>
                        <li>Abra o console da aplica√ß√£o (F12)</li>
                        <li>Recarregue a p√°gina</li>
                        <li>Verifique se as mensagens aparecem</li>
                        <li>Se n√£o aparecer, verifique se <code>listarAgentes()</code> est√° sendo chamado</li>
                    </ol>
                </div>
            `
        }

        // Auto-executar
        window.onload = function() {
            testarWebhookListAgentes()
            simularParsing()
            simularFiltro()
            verificarConsole()
        }
    </script>
</body>
</html>
