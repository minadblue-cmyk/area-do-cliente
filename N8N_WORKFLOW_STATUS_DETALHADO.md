# üîß Workflow n8n: Status do Agente - Configura√ß√£o Node a Node

## üìã Vis√£o Geral do Workflow

Este workflow permite consultar o status de execu√ß√£o de agentes no banco de dados PostgreSQL, buscando por `usuario_id`, `workflow_id` e opcionalmente `status`.

---

## üéØ Node 1: Webhook Trigger

### üìç **Localiza√ß√£o**: Primeiro node do workflow
### üîß **Tipo**: Webhook
### üìù **Nome**: `Status Agente`

#### ‚öôÔ∏è **Configura√ß√µes Detalhadas:**

**1. HTTP Method:**
```
GET
```

**2. Path:**
```
/webhook/status-agente1
```

**3. Response Mode:**
```
On Received
```

**4. Options (Configura√ß√µes Avan√ßadas):**
```json
{
  "responseMode": "onReceived",
  "responseData": "allIncomingItems",
  "responseHeaders": {
    "Content-Type": "application/json",
    "Access-Control-Allow-Origin": "*",
    "Access-Control-Allow-Methods": "GET, POST, OPTIONS",
    "Access-Control-Allow-Headers": "Content-Type, Authorization"
  }
}
```

#### üì• **Dados de Entrada Esperados:**
```
GET /webhook/status-agente1?usuario_id=5&workflow_id=agente-prospeccao-quente&status=running&logged_user_id=5&logged_user_name=Administrator&logged_user_email=admin@code-iq.com.br
```

#### üì§ **Dados de Sa√≠da:**
```json
{
  "query": {
    "usuario_id": "5",
    "workflow_id": "agente-prospeccao-quente",
    "status": "running",
    "logged_user_id": "5",
    "logged_user_name": "Administrator",
    "logged_user_email": "admin@code-iq.com.br"
  },
  "headers": {
    "host": "n8n.code-iq.com.br",
    "user-agent": "Mozilla/5.0...",
    "accept": "application/json"
  },
  "body": {}
}
```

#### üîç **Valida√ß√£o de Entrada:**
- ‚úÖ `usuario_id`: Obrigat√≥rio (integer)
- ‚úÖ `workflow_id`: Obrigat√≥rio (string)
- ‚ö†Ô∏è `status`: Opcional (string: running, stopped, completed, error)
- ‚ö†Ô∏è `logged_user_*`: Opcional (para auditoria)

---

## üéØ Node 2: Set (Normaliza√ß√£o)

### üìç **Localiza√ß√£o**: Segundo node do workflow
### üîß **Tipo**: Set
### üìù **Nome**: `Normalizar Dados`

#### ‚öôÔ∏è **Configura√ß√µes Detalhadas:**

**1. Mode:**
```
Manual
```

**2. Values (Campos Configurados):**

| Campo | Valor | Tipo | Descri√ß√£o |
|-------|-------|------|-----------|
| `usuario_id` | `{{ $json.query.usuario_id }}` | Integer | ID do usu√°rio (obrigat√≥rio) |
| `workflow_id` | `{{ $json.query.workflow_id }}` | String | ID do workflow do agente |
| `status` | `{{ $json.query.status }}` | String | Status do agente (opcional) |
| `logged_user_id` | `{{ $json.query.logged_user_id }}` | Integer | ID do usu√°rio logado |
| `logged_user_name` | `{{ $json.query.logged_user_name }}` | String | Nome do usu√°rio logado |
| `logged_user_email` | `{{ $json.query.logged_user_email }}` | String | Email do usu√°rio logado |
| `timestamp` | `{{ $now }}` | DateTime | Timestamp da consulta |
| `request_id` | `{{ $json.headers['x-request-id'] || $runId }}` | String | ID √∫nico da requisi√ß√£o |

#### üì• **Dados de Entrada:**
```json
{
  "query": {
    "usuario_id": "5",
    "workflow_id": "agente-prospeccao-quente",
    "status": "running"
  }
}
```

#### üì§ **Dados de Sa√≠da:**
```json
{
  "usuario_id": 5,
  "workflow_id": "agente-prospeccao-quente",
  "status": "running",
  "logged_user_id": 5,
  "logged_user_name": "Administrator",
  "logged_user_email": "admin@code-iq.com.br",
  "timestamp": "2024-01-15T10:30:00.000Z",
  "request_id": "run_123456789"
}
```

#### üîç **Valida√ß√£o e Sanitiza√ß√£o:**
- ‚úÖ Converte `usuario_id` para integer
- ‚úÖ Valida `workflow_id` n√£o vazio
- ‚úÖ Trata `status` como opcional (pode ser null)
- ‚úÖ Gera timestamp da consulta
- ‚úÖ Cria ID √∫nico para rastreamento

---

## üéØ Node 3: PostgreSQL (Consulta)

### üìç **Localiza√ß√£o**: Terceiro node do workflow
### üîß **Tipo**: PostgreSQL
### üìù **Nome**: `Buscar Status Agente`

#### ‚öôÔ∏è **Configura√ß√µes Detalhadas:**

**1. Operation:**
```
Execute Query
```

**2. Query (SQL):**
```sql
SELECT 
    id,
    execution_id,
    workflow_id,
    usuario_id,
    usuario_nome,
    usuario_email,
    status,
    iniciado_em,
    parado_em,
    payload_inicial,
    payload_parada,
    CASE 
        WHEN status = 'running' THEN 'Agente em execu√ß√£o'
        WHEN status = 'stopped' THEN 'Agente parado'
        WHEN status = 'error' THEN 'Agente com erro'
        WHEN status = 'completed' THEN 'Agente conclu√≠do'
        ELSE 'Status desconhecido'
    END as message,
    EXTRACT(EPOCH FROM (NOW() - iniciado_em)) as tempo_execucao_segundos,
    CASE 
        WHEN status = 'running' THEN 
            EXTRACT(EPOCH FROM (NOW() - iniciado_em))::INTEGER
        ELSE 
            EXTRACT(EPOCH FROM (parado_em - iniciado_em))::INTEGER
    END as duracao_segundos
FROM agente_execucoes 
WHERE usuario_id = $1 
  AND workflow_id = $2
  AND ($3 IS NULL OR status = $3)
ORDER BY iniciado_em DESC
LIMIT 10;
```

**3. Parameters (Par√¢metros):**
```json
[
  "{{ $json.usuario_id }}",
  "{{ $json.workflow_id }}",
  "{{ $json.status }}"
]
```

**4. Options (Configura√ß√µes Avan√ßadas):**
```json
{
  "queryTimeout": 30000,
  "maxReturnedRows": 100,
  "connectionTimeout": 10000
}
```

#### üì• **Dados de Entrada:**
```json
{
  "usuario_id": 5,
  "workflow_id": "agente-prospeccao-quente",
  "status": "running"
}
```

#### üì§ **Dados de Sa√≠da (Exemplo):**
```json
[
  {
    "id": 123,
    "execution_id": "44117",
    "workflow_id": "agente-prospeccao-quente",
    "usuario_id": 5,
    "usuario_nome": "Administrator",
    "usuario_email": "admin@code-iq.com.br",
    "status": "running",
    "iniciado_em": "2024-01-15T10:00:00.000Z",
    "parado_em": null,
    "payload_inicial": {
      "usuario_id": 5,
      "action": "start"
    },
    "payload_parada": null,
    "message": "Agente em execu√ß√£o",
    "tempo_execucao_segundos": 1800,
    "duracao_segundos": 1800
  }
]
```

#### üîç **L√≥gica da Query:**
- ‚úÖ **Filtro Principal**: `usuario_id = $1 AND workflow_id = $2`
- ‚úÖ **Filtro Opcional**: `status = $3` (se fornecido)
- ‚úÖ **Ordena√ß√£o**: Por `iniciado_em DESC` (mais recente primeiro)
- ‚úÖ **Limite**: M√°ximo 10 registros
- ‚úÖ **Campos Calculados**: Tempo de execu√ß√£o e dura√ß√£o
- ‚úÖ **Mensagem Descritiva**: Status em portugu√™s

#### ‚ö†Ô∏è **Tratamento de Erros:**
- **Timeout**: 30 segundos
- **Sem Resultados**: Retorna array vazio `[]`
- **Erro de Conex√£o**: Falha no workflow
- **SQL Inv√°lido**: Falha no workflow

---

## üéØ Node 4: Set (Formata√ß√£o)

### üìç **Localiza√ß√£o**: Quarto node do workflow
### üîß **Tipo**: Set
### üìù **Nome**: `Formatar Resposta`

#### ‚öôÔ∏è **Configura√ß√µes Detalhadas:**

**1. Mode:**
```
Manual
```

**2. Values (Campos Configurados):**

| Campo | Valor | Tipo | Descri√ß√£o |
|-------|-------|------|-----------|
| `success` | `{{ $json.length > 0 }}` | Boolean | Indica se encontrou resultados |
| `count` | `{{ $json.length }}` | Integer | Quantidade de execu√ß√µes encontradas |
| `usuario_id` | `{{ $('Normalizar Dados').item.json.usuario_id }}` | Integer | ID do usu√°rio consultado |
| `workflow_id` | `{{ $('Normalizar Dados').item.json.workflow_id }}` | String | ID do workflow consultado |
| `status_filter` | `{{ $('Normalizar Dados').item.json.status }}` | String | Status filtrado (se aplic√°vel) |
| `executions` | `{{ $json }}` | Array | Lista de execu√ß√µes encontradas |
| `timestamp` | `{{ $now }}` | DateTime | Timestamp da resposta |
| `request_id` | `{{ $('Normalizar Dados').item.json.request_id }}` | String | ID da requisi√ß√£o |

#### üì• **Dados de Entrada:**
```json
[
  {
    "id": 123,
    "execution_id": "44117",
    "status": "running",
    "message": "Agente em execu√ß√£o"
  }
]
```

#### üì§ **Dados de Sa√≠da:**
```json
{
  "success": true,
  "count": 1,
  "usuario_id": 5,
  "workflow_id": "agente-prospeccao-quente",
  "status_filter": "running",
  "executions": [
    {
      "id": 123,
      "execution_id": "44117",
      "status": "running",
      "message": "Agente em execu√ß√£o"
    }
  ],
  "timestamp": "2024-01-15T10:30:00.000Z",
  "request_id": "run_123456789"
}
```

#### üîç **L√≥gica de Formata√ß√£o:**
- ‚úÖ **Success**: `true` se encontrou resultados, `false` se n√£o
- ‚úÖ **Count**: Quantidade de execu√ß√µes retornadas
- ‚úÖ **Metadados**: Preserva informa√ß√µes da consulta original
- ‚úÖ **Executions**: Array com os dados das execu√ß√µes
- ‚úÖ **Timestamp**: Momento da resposta
- ‚úÖ **Request ID**: Para rastreamento

---

## üéØ Node 5: Response (Resposta HTTP)

### üìç **Localiza√ß√£o**: Quinto node do workflow
### üîß **Tipo**: Respond to Webhook
### üìù **Nome**: `Resposta Final`

#### ‚öôÔ∏è **Configura√ß√µes Detalhadas:**

**1. Response Code:**
```
200
```

**2. Response Headers:**
```json
{
  "Content-Type": "application/json",
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Methods": "GET, POST, OPTIONS",
  "Access-Control-Allow-Headers": "Content-Type, Authorization",
  "X-Request-ID": "{{ $json.request_id }}",
  "X-Timestamp": "{{ $json.timestamp }}"
}
```

**3. Response Body:**
```json
{
  "success": "{{ $json.success }}",
  "message": "{{ $json.success ? 'Consulta realizada com sucesso' : 'Nenhuma execu√ß√£o encontrada' }}",
  "data": {
    "usuario_id": "{{ $json.usuario_id }}",
    "workflow_id": "{{ $json.workflow_id }}",
    "status_filter": "{{ $json.status_filter }}",
    "count": "{{ $json.count }}",
    "executions": "{{ $json.executions }}"
  },
  "metadata": {
    "timestamp": "{{ $json.timestamp }}",
    "request_id": "{{ $json.request_id }}",
    "workflow_version": "1.0.0"
  }
}
```

#### üì• **Dados de Entrada:**
```json
{
  "success": true,
  "count": 1,
  "executions": [...]
}
```

#### üì§ **Resposta HTTP Final:**
```json
{
  "success": true,
  "message": "Consulta realizada com sucesso",
  "data": {
    "usuario_id": 5,
    "workflow_id": "agente-prospeccao-quente",
    "status_filter": "running",
    "count": 1,
    "executions": [
      {
        "id": 123,
        "execution_id": "44117",
        "status": "running",
        "message": "Agente em execu√ß√£o"
      }
    ]
  },
  "metadata": {
    "timestamp": "2024-01-15T10:30:00.000Z",
    "request_id": "run_123456789",
    "workflow_version": "1.0.0"
  }
}
```

#### üîç **Caracter√≠sticas da Resposta:**
- ‚úÖ **Status Code**: 200 (sucesso)
- ‚úÖ **Headers CORS**: Configurados para permitir requisi√ß√µes
- ‚úÖ **Estrutura Consistente**: Sempre retorna o mesmo formato
- ‚úÖ **Metadados**: Informa√ß√µes de rastreamento
- ‚úÖ **Mensagem Descritiva**: Indica sucesso ou falha
- ‚úÖ **Dados Estruturados**: Organizados em se√ß√µes l√≥gicas

---

## üîÑ Fluxo Completo do Workflow

### üìä **Diagrama de Fluxo:**
```
[Webhook] ‚Üí [Set] ‚Üí [PostgreSQL] ‚Üí [Set] ‚Üí [Response]
    ‚Üì         ‚Üì         ‚Üì           ‚Üì         ‚Üì
  GET      Normaliza  Consulta   Formata  HTTP 200
  Query    Dados      Banco      Resposta  JSON
```

### ‚è±Ô∏è **Tempo de Execu√ß√£o Estimado:**
- **Webhook**: ~50ms
- **Set (Normaliza√ß√£o)**: ~10ms
- **PostgreSQL**: ~100-500ms
- **Set (Formata√ß√£o)**: ~10ms
- **Response**: ~20ms
- **Total**: ~200-600ms

### üéØ **Cen√°rios de Uso:**

#### 1. **Buscar Agente Espec√≠fico**
```
GET /webhook/status-agente1?usuario_id=5&workflow_id=agente-prospeccao-quente
```

#### 2. **Buscar Agente com Status Espec√≠fico**
```
GET /webhook/status-agente1?usuario_id=5&workflow_id=agente-prospeccao-quente&status=running
```

#### 3. **Buscar Todas as Execu√ß√µes do Usu√°rio**
```
GET /webhook/status-agente1?usuario_id=5&workflow_id=agente-prospeccao-quente&status=
```

### üö® **Tratamento de Erros:**

#### **Erro 400 - Bad Request**
```json
{
  "success": false,
  "message": "Par√¢metros obrigat√≥rios ausentes",
  "error": "usuario_id e workflow_id s√£o obrigat√≥rios"
}
```

#### **Erro 500 - Internal Server Error**
```json
{
  "success": false,
  "message": "Erro interno do servidor",
  "error": "Falha na conex√£o com o banco de dados"
}
```

#### **Sucesso sem Resultados**
```json
{
  "success": true,
  "message": "Nenhuma execu√ß√£o encontrada",
  "data": {
    "count": 0,
    "executions": []
  }
}
```

---

## üéØ **Configura√ß√£o Final Recomendada**

### üìã **Checklist de Implementa√ß√£o:**

- [ ] **Webhook Trigger** configurado com m√©todo GET
- [ ] **Set Node** normalizando par√¢metros de entrada
- [ ] **PostgreSQL Node** com query otimizada
- [ ] **Set Node** formatando resposta
- [ ] **Response Node** com headers CORS
- [ ] **√çndices** criados no banco de dados
- [ ] **Testes** realizados com diferentes par√¢metros
- [ ] **Monitoramento** configurado para performance

### üîß **Configura√ß√µes de Produ√ß√£o:**

1. **Timeout**: 30 segundos
2. **Retry**: 3 tentativas
3. **Rate Limiting**: 100 req/min por usu√°rio
4. **Logging**: Ativado para auditoria
5. **Monitoring**: Alertas para falhas

---

## üéâ **Resultado Final**

Este workflow fornece uma **API robusta e eficiente** para consultar o status de agentes, com:

- ‚úÖ **Performance otimizada** com √≠ndices espec√≠ficos
- ‚úÖ **Flexibilidade** para diferentes tipos de consulta
- ‚úÖ **Rastreabilidade** completa com request IDs
- ‚úÖ **Tratamento de erros** abrangente
- ‚úÖ **Resposta consistente** e bem estruturada
- ‚úÖ **CORS configurado** para integra√ß√£o frontend
- ‚úÖ **Metadados ricos** para debugging e monitoramento

**O workflow est√° pronto para produ√ß√£o!** üöÄ
