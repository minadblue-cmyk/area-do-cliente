<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configurar Timezone Global N8N</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #1a1a1a; color: #fff; }
        .container { max-width: 1200px; margin: 0 auto; }
        .section { background: #2a2a2a; padding: 20px; margin: 10px 0; border-radius: 8px; }
        .success { color: #4ade80; }
        .error { color: #f87171; }
        .warning { color: #fbbf24; }
        .info { color: #60a5fa; }
        button { background: #3b82f6; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #2563eb; }
        pre { background: #1e1e1e; padding: 15px; border-radius: 5px; overflow-x: auto; }
        .code-block { background: #1e1e1e; padding: 15px; border-radius: 5px; margin: 10px 0; }
        .step { background: #333; padding: 15px; margin: 10px 0; border-radius: 5px; border-left: 4px solid #3b82f6; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üåç Configurar Timezone Global N8N</h1>
        
        <div class="section">
            <h2>1. Verificar Configura√ß√£o Atual</h2>
            <button onclick="verificarConfiguracaoAtual()">Verificar Configura√ß√£o Atual</button>
            <div id="config-result"></div>
        </div>

        <div class="section">
            <h2>2. Configura√ß√µes Recomendadas</h2>
            
            <div class="step">
                <h3>üìã Passo 1: Vari√°vel de Ambiente</h3>
                <p class="info">Adicione esta vari√°vel no seu arquivo de configura√ß√£o do n8n:</p>
                <div class="code-block">
                    <pre># No arquivo .env do n8n
N8N_DEFAULT_TIMEZONE=America/Sao_Paulo

# Ou se estiver usando Docker
-e N8N_DEFAULT_TIMEZONE=America/Sao_Paulo</pre>
                </div>
            </div>

            <div class="step">
                <h3>üìã Passo 2: Configura√ß√£o no n8n.conf</h3>
                <p class="info">Adicione estas configura√ß√µes no arquivo de configura√ß√£o:</p>
                <div class="code-block">
                    <pre>{
  "timezone": "America/Sao_Paulo",
  "defaultTimezone": "America/Sao_Paulo",
  "execution": {
    "timezone": "America/Sao_Paulo"
  }
}</pre>
                </div>
            </div>

            <div class="step">
                <h3>üìã Passo 3: Docker Compose (se aplic√°vel)</h3>
                <p class="info">Se estiver usando Docker Compose:</p>
                <div class="code-block">
                    <pre>version: '3.8'
services:
  n8n:
    image: n8nio/n8n
    environment:
      - N8N_DEFAULT_TIMEZONE=America/Sao_Paulo
      - TZ=America/Sao_Paulo
    volumes:
      - n8n_data:/home/node/.n8n
    ports:
      - "5678:5678"</pre>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>3. Testar Configura√ß√£o</h2>
            <button onclick="testarTimezoneGlobal()">Testar Timezone Global</button>
            <div id="teste-result"></div>
        </div>

        <div class="section">
            <h2>4. Verificar Workflows Existentes</h2>
            <button onclick="verificarWorkflowsExistentes()">Verificar Workflows</button>
            <div id="workflows-result"></div>
        </div>

        <div class="section">
            <h2>5. Script de Migra√ß√£o (Opcional)</h2>
            <p class="info">Se precisar atualizar workflows existentes:</p>
            <button onclick="gerarScriptMigracao()">Gerar Script de Migra√ß√£o</button>
            <div id="migracao-result"></div>
        </div>
    </div>

    <script>
        async function verificarConfiguracaoAtual() {
            const resultDiv = document.getElementById('config-result');
            resultDiv.innerHTML = '<p class="info">üîç Verificando configura√ß√£o atual do n8n...</p>';

            try {
                // Verificar se conseguimos acessar informa√ß√µes do n8n
                const response = await fetch('https://n8n.code-iq.com.br/api/v1/workflows', {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (response.ok) {
                    const workflows = await response.json();
                    
                    resultDiv.innerHTML = `
                        <p class="success">‚úÖ N8N acess√≠vel!</p>
                        <p class="info">üìä Total de workflows: ${workflows.data?.length || 0}</p>
                        <p class="info">üåç Timezone atual do navegador: ${Intl.DateTimeFormat().resolvedOptions().timeZone}</p>
                        <p class="info">‚è∞ Hora atual: ${new Date().toLocaleString()}</p>
                        <p class="warning">‚ö†Ô∏è Para verificar timezone do n8n, voc√™ precisa acessar as configura√ß√µes do servidor</p>
                    `;
                } else {
                    resultDiv.innerHTML = `<p class="error">‚ùå Erro ao acessar n8n: ${response.status}</p>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">‚ùå Erro: ${error.message}</p>`;
            }
        }

        async function testarTimezoneGlobal() {
            const resultDiv = document.getElementById('teste-result');
            resultDiv.innerHTML = '<p class="info">üîç Testando timezone global...</p>';

            try {
                const timezones = [
                    'America/Sao_Paulo',
                    'America/New_York', 
                    'UTC',
                    'Europe/London'
                ];

                let resultado = '<p class="success">‚úÖ Compara√ß√£o de Timezones:</p>';
                
                timezones.forEach(tz => {
                    const now = new Date();
                    const tzTime = new Date(now.toLocaleString("en-US", {timeZone: tz}));
                    const offset = tzTime.getTimezoneOffset() / -60;
                    
                    resultado += `
                        <p class="info">üåç ${tz}: ${tzTime.toLocaleString()} (UTC${offset >= 0 ? '+' : ''}${offset})</p>
                    `;
                });

                resultado += `
                    <hr>
                    <p class="warning">‚ö†Ô∏è Para aplicar globalmente, reinicie o n8n ap√≥s configurar a vari√°vel de ambiente</p>
                `;

                resultDiv.innerHTML = resultado;
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">‚ùå Erro: ${error.message}</p>`;
            }
        }

        async function verificarWorkflowsExistentes() {
            const resultDiv = document.getElementById('workflows-result');
            resultDiv.innerHTML = '<p class="info">üîç Verificando workflows existentes...</p>';

            try {
                const response = await fetch('https://n8n.code-iq.com.br/api/v1/workflows', {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (response.ok) {
                    const workflows = await response.json();
                    const agentWorkflows = workflows.data?.filter(w => 
                        w.name?.includes('Agente SDR') || 
                        w.name?.includes('Start-') || 
                        w.name?.includes('Status-') ||
                        w.name?.includes('Lista-') ||
                        w.name?.includes('Stop-')
                    ) || [];

                    let resultado = `
                        <p class="success">‚úÖ Workflows encontrados!</p>
                        <p class="info">üìä Total de workflows: ${workflows.data?.length || 0}</p>
                        <p class="info">ü§ñ Workflows de agentes: ${agentWorkflows.length}</p>
                        <hr>
                    `;

                    if (agentWorkflows.length > 0) {
                        resultado += '<p class="info">üìã Workflows de agentes encontrados:</p>';
                        agentWorkflows.forEach(workflow => {
                            resultado += `<p>‚Ä¢ ${workflow.name} (ID: ${workflow.id})</p>`;
                        });
                    }

                    resultado += `
                        <hr>
                        <p class="warning">‚ö†Ô∏è Ap√≥s configurar o timezone global, estes workflows usar√£o automaticamente America/Sao_Paulo</p>
                    `;

                    resultDiv.innerHTML = resultado;
                } else {
                    resultDiv.innerHTML = `<p class="error">‚ùå Erro ao acessar workflows: ${response.status}</p>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">‚ùå Erro: ${error.message}</p>`;
            }
        }

        function gerarScriptMigracao() {
            const resultDiv = document.getElementById('migracao-result');
            
            const script = `
// Script para atualizar timezone em workflows existentes
const workflows = await fetch('https://n8n.code-iq.com.br/api/v1/workflows').then(r => r.json());

for (const workflow of workflows.data) {
  if (workflow.name?.includes('Agente SDR')) {
    // Atualizar configura√ß√µes do workflow
    const updatedWorkflow = {
      ...workflow,
      settings: {
        ...workflow.settings,
        timezone: 'America/Sao_Paulo',
        executionOrder: 'v1'
      }
    };
    
    // Salvar workflow atualizado
    await fetch(\`https://n8n.code-iq.com.br/api/v1/workflows/\${workflow.id}\`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(updatedWorkflow)
    });
    
    console.log(\`‚úÖ Workflow \${workflow.name} atualizado\`);
  }
}
            `;

            resultDiv.innerHTML = `
                <p class="success">‚úÖ Script de migra√ß√£o gerado!</p>
                <div class="code-block">
                    <pre>${script}</pre>
                </div>
                <p class="warning">‚ö†Ô∏è Execute este script no console do navegador ap√≥s fazer login no n8n</p>
            `;
        }
    </script>
</body>
</html>
