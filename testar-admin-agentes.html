<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Admin - Ver Todos os Agentes</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background: #0056b3; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Teste Admin - Ver Todos os Agentes</h1>
        
        <div class="test-section info">
            <h3>üìã Cen√°rios de Teste</h3>
            <ul>
                <li><strong>Usu√°rio Normal:</strong> Deve ver apenas seus pr√≥prios agentes</li>
                <li><strong>Administrador:</strong> Deve ver TODOS os agentes</li>
                <li><strong>Valida√ß√£o:</strong> Verificar se `canViewAll` e `canManage` funcionam</li>
            </ul>
        </div>

        <div class="test-section">
            <h3>üîß Teste Usu√°rio Normal (ID 6)</h3>
            <button onclick="testarUsuarioNormal()">Testar Usu√°rio Normal</button>
            <div id="resultadoNormal"></div>
        </div>

        <div class="test-section">
            <h3>üîß Teste Administrador (ID 5)</h3>
            <button onclick="testarAdministrador()">Testar Administrador</button>
            <div id="resultadoAdmin"></div>
        </div>

        <div class="test-section">
            <h3>üìä Logs Detalhados</h3>
            <div id="logs"></div>
        </div>
    </div>

    <script>
        // Dados de teste (simulando syncedAgents)
        const syncedAgents = {
            "65": {
                "id": 65,
                "nome": "Jo√£o",
                "descricao": "",
                "icone": "ü§ñ",
                "cor": "bg-pink-500",
                "ativo": true,
                "usuario_id": 6,
                "status_atual": "stopped"
            },
            "68": {
                "id": 68,
                "nome": "Joana",
                "descricao": "joana",
                "icone": "üéØ",
                "cor": "bg-yellow-500",
                "ativo": true,
                "usuario_id": 5,
                "status_atual": "stopped"
            },
            "69": {
                "id": 69,
                "nome": "Teste Agente",
                "descricao": "Agente de teste",
                "icone": "ü§ñ",
                "cor": "bg-blue-500",
                "ativo": true,
                "usuario_id": 6,
                "status_atual": "stopped"
            }
        }

        function log(message) {
            const logsDiv = document.getElementById('logs')
            const timestamp = new Date().toLocaleTimeString()
            logsDiv.innerHTML += `<div>[${timestamp}] ${message}</div>`
        }

        function testarFiltro(userData, agentPermissions, tipoUsuario) {
            log(`üîç Testando filtro para ${tipoUsuario}...`)
            
            const newAgentTypes = {}
            
            Object.entries(syncedAgents).forEach(([agentId, agentData]) => {
                log(`üîç Processando agente: ${agentData.nome} (usuario_id: ${agentData.usuario_id})`)
                log(`üîç Permiss√µes: canViewAll=${agentPermissions.canViewAll}, canManage=${agentPermissions.canManage}, canViewOwn=${agentPermissions.canViewOwn}`)
                
                // Aplicar filtro de permiss√µes (l√≥gica do frontend)
                const shouldShowAgent = (() => {
                    // Se pode ver todos os agentes, mostrar todos
                    if (agentPermissions.canViewAll || agentPermissions.canManage) {
                        log(`‚úÖ ${agentData.nome}: Mostrando (canViewAll/canManage)`)
                        return true
                    }
                    
                    // Se pode ver apenas seus pr√≥prios agentes, filtrar por user_id
                    if (agentPermissions.canViewOwn) {
                        const userId = parseInt(userData.id)
                        const matches = agentData.user_id === userId || agentData.usuario_id === userId
                        log(`üîç ${agentData.nome}: Comparando ${agentData.usuario_id} === ${userId} = ${matches}`)
                        return matches
                    }
                    
                    // Se n√£o tem permiss√£o espec√≠fica, n√£o mostrar nenhum
                    log(`‚ùå ${agentData.nome}: Sem permiss√£o espec√≠fica`)
                    return false
                })()
                
                if (shouldShowAgent) {
                    newAgentTypes[agentId] = {
                        id: agentId,
                        name: agentData.nome,
                        description: agentData.descricao || 'Agente de prospec√ß√£o',
                        icon: agentData.icone || 'ü§ñ',
                        color: agentData.cor || 'bg-blue-500',
                        webhook: 'webhook-generic'
                    }
                    log(`‚úÖ ${agentData.nome}: Adicionado ao dynamicAgentTypes`)
                } else {
                    log(`‚ùå ${agentData.nome}: Filtrado`)
                }
            })
            
            log(`üîç Agentes filtrados para ${tipoUsuario}: ${Object.keys(newAgentTypes).length} de ${Object.keys(syncedAgents).length}`)
            
            return {
                agentTypes: newAgentTypes,
                count: Object.keys(newAgentTypes).length,
                total: Object.keys(syncedAgents).length
            }
        }

        function testarUsuarioNormal() {
            log('üîç Testando usu√°rio normal (ID 6)...')
            
            // Simular usu√°rio normal
            const userData = { id: "6", name: "Teste de Dashboard" }
            
            // Simular permiss√µes de usu√°rio normal
            const agentPermissions = {
                canViewAll: false,  // N√£o √© admin
                canManage: false,   // N√£o pode gerenciar todos
                canViewOwn: true    // Pode ver seus pr√≥prios
            }
            
            const resultado = testarFiltro(userData, agentPermissions, "Usu√°rio Normal")
            
            const resultadoDiv = document.getElementById('resultadoNormal')
            resultadoDiv.innerHTML = `
                <h4>üìä Resultado Usu√°rio Normal:</h4>
                <p><strong>Permiss√µes:</strong> canViewAll=${agentPermissions.canViewAll}, canManage=${agentPermissions.canManage}, canViewOwn=${agentPermissions.canViewOwn}</p>
                <p><strong>Agentes filtrados:</strong> ${resultado.count} de ${resultado.total}</p>
                <p><strong>Agentes que devem aparecer:</strong></p>
                <ul>
                    ${Object.values(resultado.agentTypes).map(agent => 
                        `<li>‚úÖ ${agent.name} (ID: ${agent.id})</li>`
                    ).join('')}
                </ul>
                <p><strong>Resultado esperado:</strong> Apenas agentes do usu√°rio 6 (Jo√£o e Teste Agente)</p>
                <p><strong>Status:</strong> ${resultado.count === 2 ? '‚úÖ CORRETO' : '‚ùå INCORRETO'}</p>
            `
            
            if (resultado.count === 2) {
                resultadoDiv.className = 'test-section success'
            } else {
                resultadoDiv.className = 'test-section error'
            }
        }

        function testarAdministrador() {
            log('üîç Testando administrador (ID 5)...')
            
            // Simular administrador
            const userData = { id: "5", name: "Administrator Code-IQ" }
            
            // Simular permiss√µes de administrador
            const agentPermissions = {
                canViewAll: true,   // Admin pode ver todos
                canManage: true,    // Admin pode gerenciar todos
                canViewOwn: true    // Admin tamb√©m pode ver seus pr√≥prios
            }
            
            const resultado = testarFiltro(userData, agentPermissions, "Administrador")
            
            const resultadoDiv = document.getElementById('resultadoAdmin')
            resultadoDiv.innerHTML = `
                <h4>üìä Resultado Administrador:</h4>
                <p><strong>Permiss√µes:</strong> canViewAll=${agentPermissions.canViewAll}, canManage=${agentPermissions.canManage}, canViewOwn=${agentPermissions.canViewOwn}</p>
                <p><strong>Agentes filtrados:</strong> ${resultado.count} de ${resultado.total}</p>
                <p><strong>Agentes que devem aparecer:</strong></p>
                <ul>
                    ${Object.values(resultado.agentTypes).map(agent => 
                        `<li>‚úÖ ${agent.name} (ID: ${agent.id}, usuario_id: ${syncedAgents[agent.id].usuario_id})</li>`
                    ).join('')}
                </ul>
                <p><strong>Resultado esperado:</strong> TODOS os agentes (Jo√£o, Joana e Teste Agente)</p>
                <p><strong>Status:</strong> ${resultado.count === 3 ? '‚úÖ CORRETO' : '‚ùå INCORRETO'}</p>
            `
            
            if (resultado.count === 3) {
                resultadoDiv.className = 'test-section success'
            } else {
                resultadoDiv.className = 'test-section error'
            }
        }

        // Executar teste automaticamente
        window.onload = function() {
            log('üìã P√°gina carregada. Clique nos bot√µes para testar os cen√°rios.')
        }
    </script>
</body>
</html>
