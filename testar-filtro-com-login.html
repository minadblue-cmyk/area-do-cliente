<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Testar Filtro com Login</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #1a1a1a; color: #fff; }
        .container { max-width: 1000px; margin: 0 auto; }
        .section { background: #2a2a2a; padding: 20px; margin: 10px 0; border-radius: 8px; }
        .success { color: #4ade80; }
        .error { color: #f87171; }
        .warning { color: #fbbf24; }
        .info { color: #60a5fa; }
        button { background: #3b82f6; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #2563eb; }
        pre { background: #1e1e1e; padding: 15px; border-radius: 5px; overflow-x: auto; }
        .user-card { background: #1e1e1e; padding: 15px; margin: 10px 0; border-radius: 5px; border-left: 4px solid #3b82f6; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîí Testar Filtro de Permiss√µes com Login</h1>
        
        <div class="section">
            <h2>1. Simular Login de Diferentes Usu√°rios</h2>
            <div class="user-card">
                <h3>üë§ Usu√°rio Padr√£o (ID: 5)</h3>
                <p>Deve ver apenas agentes com usuario_id = 5</p>
                <button onclick="simularLogin(5, 'Usu√°rio Padr√£o', 'rmacedo2005@hotmail.com', 32, 'Perfil de Padr√£o de Usu√°rio Elleve Consorsios')">Login como Usu√°rio Padr√£o</button>
            </div>
            
            <div class="user-card">
                <h3>üë§ Supervisor (ID: 6)</h3>
                <p>Deve ver apenas agentes com usuario_id = 6</p>
                <button onclick="simularLogin(6, 'Supervisor Elleve Cons√≥rcios', 'supervisor@teste.com', 42, 'Supervisor Elleve Cons√≥rcios')">Login como Supervisor</button>
            </div>
            
            <div class="user-card">
                <h3>üë§ Administrador (ID: 28)</h3>
                <p>Deve ver todos os agentes (se tiver permiss√£o canViewAll)</p>
                <button onclick="simularLogin(28, 'Administrador', 'admin@teste.com', 1, 'Administrador')">Login como Administrador</button>
            </div>
        </div>

        <div class="section">
            <h2>2. Usu√°rio Atual</h2>
            <button onclick="verificarUsuario()">Verificar Usu√°rio</button>
            <div id="usuario"></div>
        </div>

        <div class="section">
            <h2>3. Testar Filtro de Agentes</h2>
            <button onclick="testarFiltro()">Testar Filtro</button>
            <div id="filtro"></div>
        </div>

        <div class="section">
            <h2>4. Testar na Aplica√ß√£o</h2>
            <button onclick="testarAplicacao()">Ir para Upload</button>
            <div id="aplicacao"></div>
        </div>
    </div>

    <script>
        function simularLogin(id, nome, email, perfilId, perfil) {
            // Simular dados de login
            const userData = {
                id: id.toString(),
                name: nome,
                email: email,
                perfil_id: perfilId,
                perfil: perfil,
                permissions: []
            }
            
            const authData = {
                token: 'simulated-token-' + id,
                user: userData
            }
            
            // Salvar no localStorage
            localStorage.setItem('userData', JSON.stringify(userData))
            localStorage.setItem('authData', JSON.stringify(authData))
            
            console.log('‚úÖ Login simulado:', userData)
            
            // Atualizar exibi√ß√£o
            verificarUsuario()
            
            // Testar filtro automaticamente
            setTimeout(() => {
                testarFiltro()
            }, 500)
        }

        function verificarUsuario() {
            const resultDiv = document.getElementById('usuario')
            
            const userData = JSON.parse(localStorage.getItem('userData') || '{}')
            const authData = JSON.parse(localStorage.getItem('authData') || '{}')
            
            if (!userData.id) {
                resultDiv.innerHTML = '<p class="warning">‚ö†Ô∏è Nenhum usu√°rio logado. Use os bot√µes acima para simular login.</p>'
                return
            }
            
            resultDiv.innerHTML = `
                <h3 class="success">‚úÖ Usu√°rio Logado</h3>
                <p><strong>ID:</strong> ${userData.id}</p>
                <p><strong>Nome:</strong> ${userData.name}</p>
                <p><strong>Email:</strong> ${userData.email}</p>
                <p><strong>Perfil ID:</strong> ${userData.perfil_id}</p>
                <p><strong>Perfil:</strong> ${userData.perfil}</p>
                
                <h4>Dados completos:</h4>
                <pre>${JSON.stringify(userData, null, 2)}</pre>
            `
        }

        async function testarFiltro() {
            const resultDiv = document.getElementById('filtro')
            resultDiv.innerHTML = '<p class="info">üîÑ Testando filtro de agentes...</p>'
            
            try {
                // 1. Buscar agentes
                const response = await fetch('https://n8n.code-iq.com.br/webhook/list-agentes', {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' }
                })
                
                const data = await response.json()
                const agentes = data.data || []
                
                // 2. Verificar usu√°rio atual
                const userData = JSON.parse(localStorage.getItem('userData') || '{}')
                const userId = parseInt(userData.id || '0')
                
                if (userId === 0) {
                    resultDiv.innerHTML = '<p class="error">‚ùå Nenhum usu√°rio logado. Simule um login primeiro.</p>'
                    return
                }
                
                // 3. Aplicar filtro baseado no perfil
                let agentesFiltrados = []
                let motivoFiltro = ''
                
                if (userData.perfil_id === 1) {
                    // Administrador - pode ver todos
                    agentesFiltrados = agentes
                    motivoFiltro = 'Administrador - v√™ todos os agentes'
                } else {
                    // Usu√°rio normal - apenas seus agentes
                    agentesFiltrados = agentes.filter(agente => agente.usuario_id === userId)
                    motivoFiltro = `Usu√°rio normal - apenas agentes com usuario_id = ${userId}`
                }
                
                resultDiv.innerHTML = `
                    <h3 class="info">üîç Resultado do Filtro</h3>
                    <p><strong>Usu√°rio:</strong> ${userData.name} (ID: ${userId}, Perfil: ${userData.perfil_id})</p>
                    <p><strong>Motivo do filtro:</strong> ${motivoFiltro}</p>
                    <p><strong>Total de agentes:</strong> ${agentes.length}</p>
                    <p><strong>Agentes vis√≠veis:</strong> ${agentesFiltrados.length}</p>
                    
                    <h4>Agentes dispon√≠veis no sistema:</h4>
                    <ul>
                        ${agentes.map(agente => `
                            <li>
                                <strong>${agente.nome}</strong> (ID: ${agente.id})
                                <br>Usu√°rio ID: ${agente.usuario_id}
                                <br>Status: ${agente.usuario_id === userId ? '‚úÖ Seu agente' : '‚ùå De outro usu√°rio'}
                            </li>
                        `).join('')}
                    </ul>
                    
                    <h4>Agentes que este usu√°rio deve ver:</h4>
                    <ul>
                        ${agentesFiltrados.map(agente => `
                            <li>
                                <strong>${agente.nome}</strong> (ID: ${agente.id})
                                <br>Usu√°rio ID: ${agente.usuario_id}
                            </li>
                        `).join('')}
                    </ul>
                    
                    <h4>Verifica√ß√£o:</h4>
                    <p class="${agentesFiltrados.length > 0 ? 'success' : 'warning'}">
                        ${agentesFiltrados.length > 0 ? '‚úÖ Usu√°rio tem agentes para ver' : '‚ö†Ô∏è Usu√°rio n√£o tem agentes pr√≥prios'}
                    </p>
                `
                
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">‚ùå Erro: ${error.message}</p>`
            }
        }

        function testarAplicacao() {
            const resultDiv = document.getElementById('aplicacao')
            
            const userData = JSON.parse(localStorage.getItem('userData') || '{}')
            
            if (!userData.id) {
                resultDiv.innerHTML = '<p class="error">‚ùå Nenhum usu√°rio logado. Simule um login primeiro.</p>'
                return
            }
            
            resultDiv.innerHTML = `
                <h3 class="info">üîÑ Redirecionando para Upload</h3>
                <p><strong>Usu√°rio:</strong> ${userData.name} (ID: ${userData.id})</p>
                <p>Agora o usu√°rio deve ver apenas os agentes atribu√≠dos a ele.</p>
                <p>Se ainda estiver vendo agentes de outros usu√°rios, h√° um problema na l√≥gica de filtragem.</p>
            `
            
            // Redirecionar para upload
            setTimeout(() => {
                window.location.href = '/upload'
            }, 2000)
        }

        // Auto-executar verifica√ß√£o
        window.onload = function() {
            verificarUsuario()
        }
    </script>
</body>
</html>
