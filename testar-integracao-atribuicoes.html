<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste IntegraÃ§Ã£o AtribuiÃ§Ãµes</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background: #0056b3; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª Teste IntegraÃ§Ã£o Sistema de AtribuiÃ§Ãµes</h1>
        
        <div class="test-section info">
            <h3>ğŸ“‹ Funcionalidades Implementadas</h3>
            <ul>
                <li>âœ… <strong>PermissÃ£o:</strong> atribuir_agentes_usuarios</li>
                <li>âœ… <strong>Webhook Listar:</strong> webhook/list-agente-atribuicoes</li>
                <li>âœ… <strong>Webhook Atribuir:</strong> webhook/atribuir-agente-usuario</li>
                <li>âœ… <strong>Webhook Remover:</strong> webhook/remover-atribuicao-agente</li>
                <li>âœ… <strong>LÃ³gica de Filtro:</strong> Atualizada no frontend</li>
            </ul>
        </div>

        <div class="test-section">
            <h3>ğŸ”§ Teste Completo do Sistema</h3>
            <button onclick="testarSistemaCompleto()">Testar Sistema Completo</button>
            <div id="resultado"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ“Š Logs Detalhados</h3>
            <div id="logs"></div>
        </div>
    </div>

    <script>
        function log(message) {
            const logsDiv = document.getElementById('logs')
            const timestamp = new Date().toLocaleTimeString()
            logsDiv.innerHTML += `<div>[${timestamp}] ${message}</div>`
        }

        async function testarSistemaCompleto() {
            log('ğŸš€ Iniciando teste completo do sistema de atribuiÃ§Ãµes...')
            
            const resultadoDiv = document.getElementById('resultado')
            resultadoDiv.innerHTML = '<div class="test-section loading">â³ Testando sistema completo...</div>'
            
            try {
                // 1. Testar listagem inicial
                log('ğŸ“‹ 1. Testando listagem inicial...')
                const listagemResponse = await fetch('https://n8n.code-iq.com.br/webhook/list-agente-atribuicoes?usuario_id=6')
                const listagemData = await listagemResponse.json()
                log(`âœ… Listagem inicial: ${listagemData.length || 0} atribuiÃ§Ãµes`)
                
                // 2. Testar atribuiÃ§Ã£o
                log('ğŸ“‹ 2. Testando atribuiÃ§Ã£o...')
                const atribuirResponse = await fetch('https://n8n.code-iq.com.br/webhook/atribuir-agente-usuario', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        agente_id: 65,
                        usuario_id: 6,
                        atribuido_por: 5
                    })
                })
                const atribuirData = await atribuirResponse.json()
                log(`âœ… AtribuiÃ§Ã£o: ${atribuirData.success ? 'Sucesso' : 'Falha'}`)
                
                // 3. Testar listagem apÃ³s atribuiÃ§Ã£o
                log('ğŸ“‹ 3. Testando listagem apÃ³s atribuiÃ§Ã£o...')
                const listagemPosResponse = await fetch('https://n8n.code-iq.com.br/webhook/list-agente-atribuicoes?usuario_id=6')
                const listagemPosData = await listagemPosResponse.json()
                log(`âœ… Listagem pÃ³s-atribuiÃ§Ã£o: ${listagemPosData.length || 0} atribuiÃ§Ãµes`)
                
                // 4. Testar remoÃ§Ã£o
                log('ğŸ“‹ 4. Testando remoÃ§Ã£o...')
                const removerResponse = await fetch('https://n8n.code-iq.com.br/webhook/remover-atribuicao-agente', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        agente_id: 65,
                        usuario_id: 6
                    })
                })
                const removerData = await removerResponse.json()
                log(`âœ… RemoÃ§Ã£o: ${removerData.success ? 'Sucesso' : 'Falha'}`)
                
                // 5. Testar listagem final
                log('ğŸ“‹ 5. Testando listagem final...')
                const listagemFinalResponse = await fetch('https://n8n.code-iq.com.br/webhook/list-agente-atribuicoes?usuario_id=6')
                const listagemFinalData = await listagemFinalResponse.json()
                log(`âœ… Listagem final: ${listagemFinalData.length || 0} atribuiÃ§Ãµes`)
                
                // Mostrar resultado
                resultadoDiv.innerHTML = `
                    <div class="test-section success">
                        <h4>âœ… Sistema de AtribuiÃ§Ãµes Funcionando!</h4>
                        <h5>ğŸ“Š Resultados dos Testes:</h5>
                        <ul>
                            <li>âœ… <strong>Listagem inicial:</strong> ${listagemData.length || 0} atribuiÃ§Ãµes</li>
                            <li>âœ… <strong>AtribuiÃ§Ã£o:</strong> ${atribuirData.success ? 'Sucesso' : 'Falha'}</li>
                            <li>âœ… <strong>Listagem pÃ³s-atribuiÃ§Ã£o:</strong> ${listagemPosData.length || 0} atribuiÃ§Ãµes</li>
                            <li>âœ… <strong>RemoÃ§Ã£o:</strong> ${removerData.success ? 'Sucesso' : 'Falha'}</li>
                            <li>âœ… <strong>Listagem final:</strong> ${listagemFinalData.length || 0} atribuiÃ§Ãµes</li>
                        </ul>
                        
                        <h5>ğŸ¯ Status do Sistema:</h5>
                        <ul>
                            <li>âœ… <strong>Webhooks:</strong> Funcionando</li>
                            <li>âœ… <strong>Banco de dados:</strong> Atualizando corretamente</li>
                            <li>âœ… <strong>PermissÃµes:</strong> Implementadas</li>
                            <li>âœ… <strong>Frontend:</strong> LÃ³gica atualizada</li>
                        </ul>
                        
                        <h5>ğŸš€ PrÃ³ximos Passos:</h5>
                        <ul>
                            <li>Testar no app real com usuÃ¡rios diferentes</li>
                            <li>Implementar interface de gerenciamento</li>
                            <li>Adicionar permissÃ£o ao perfil de administrador</li>
                        </ul>
                    </div>
                `
                
            } catch (error) {
                log(`âŒ Erro no teste: ${error.message}`)
                
                resultadoDiv.innerHTML = `
                    <div class="test-section error">
                        <h4>âŒ Erro no Sistema</h4>
                        <p><strong>Erro:</strong> ${error.message}</p>
                        <p><strong>Verifique:</strong></p>
                        <ul>
                            <li>Se todos os webhooks estÃ£o ativos</li>
                            <li>Se as permissÃµes foram criadas no banco</li>
                            <li>Se a lÃ³gica do frontend estÃ¡ correta</li>
                        </ul>
                    </div>
                `
            }
        }

        // Executar teste automaticamente
        window.onload = function() {
            log('ğŸ“‹ PÃ¡gina carregada. Clique em "Testar Sistema Completo" para executar o teste.')
        }
    </script>
</body>
</html>
