<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Integração Atribuições</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background: #0056b3; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🧪 Teste Integração Sistema de Atribuições</h1>
        
        <div class="test-section info">
            <h3>📋 Funcionalidades Implementadas</h3>
            <ul>
                <li>✅ <strong>Permissão:</strong> atribuir_agentes_usuarios</li>
                <li>✅ <strong>Webhook Listar:</strong> webhook/list-agente-atribuicoes</li>
                <li>✅ <strong>Webhook Atribuir:</strong> webhook/atribuir-agente-usuario</li>
                <li>✅ <strong>Webhook Remover:</strong> webhook/remover-atribuicao-agente</li>
                <li>✅ <strong>Lógica de Filtro:</strong> Atualizada no frontend</li>
            </ul>
        </div>

        <div class="test-section">
            <h3>🔧 Teste Completo do Sistema</h3>
            <button onclick="testarSistemaCompleto()">Testar Sistema Completo</button>
            <div id="resultado"></div>
        </div>

        <div class="test-section">
            <h3>📊 Logs Detalhados</h3>
            <div id="logs"></div>
        </div>
    </div>

    <script>
        function log(message) {
            const logsDiv = document.getElementById('logs')
            const timestamp = new Date().toLocaleTimeString()
            logsDiv.innerHTML += `<div>[${timestamp}] ${message}</div>`
        }

        async function testarSistemaCompleto() {
            log('🚀 Iniciando teste completo do sistema de atribuições...')
            
            const resultadoDiv = document.getElementById('resultado')
            resultadoDiv.innerHTML = '<div class="test-section loading">⏳ Testando sistema completo...</div>'
            
            try {
                // 1. Testar listagem inicial
                log('📋 1. Testando listagem inicial...')
                const listagemResponse = await fetch('https://n8n.code-iq.com.br/webhook/list-agente-atribuicoes?usuario_id=6')
                const listagemData = await listagemResponse.json()
                log(`✅ Listagem inicial: ${listagemData.length || 0} atribuições`)
                
                // 2. Testar atribuição
                log('📋 2. Testando atribuição...')
                const atribuirResponse = await fetch('https://n8n.code-iq.com.br/webhook/atribuir-agente-usuario', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        agente_id: 65,
                        usuario_id: 6,
                        atribuido_por: 5
                    })
                })
                const atribuirData = await atribuirResponse.json()
                log(`✅ Atribuição: ${atribuirData.success ? 'Sucesso' : 'Falha'}`)
                
                // 3. Testar listagem após atribuição
                log('📋 3. Testando listagem após atribuição...')
                const listagemPosResponse = await fetch('https://n8n.code-iq.com.br/webhook/list-agente-atribuicoes?usuario_id=6')
                const listagemPosData = await listagemPosResponse.json()
                log(`✅ Listagem pós-atribuição: ${listagemPosData.length || 0} atribuições`)
                
                // 4. Testar remoção
                log('📋 4. Testando remoção...')
                const removerResponse = await fetch('https://n8n.code-iq.com.br/webhook/remover-atribuicao-agente', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        agente_id: 65,
                        usuario_id: 6
                    })
                })
                const removerData = await removerResponse.json()
                log(`✅ Remoção: ${removerData.success ? 'Sucesso' : 'Falha'}`)
                
                // 5. Testar listagem final
                log('📋 5. Testando listagem final...')
                const listagemFinalResponse = await fetch('https://n8n.code-iq.com.br/webhook/list-agente-atribuicoes?usuario_id=6')
                const listagemFinalData = await listagemFinalResponse.json()
                log(`✅ Listagem final: ${listagemFinalData.length || 0} atribuições`)
                
                // Mostrar resultado
                resultadoDiv.innerHTML = `
                    <div class="test-section success">
                        <h4>✅ Sistema de Atribuições Funcionando!</h4>
                        <h5>📊 Resultados dos Testes:</h5>
                        <ul>
                            <li>✅ <strong>Listagem inicial:</strong> ${listagemData.length || 0} atribuições</li>
                            <li>✅ <strong>Atribuição:</strong> ${atribuirData.success ? 'Sucesso' : 'Falha'}</li>
                            <li>✅ <strong>Listagem pós-atribuição:</strong> ${listagemPosData.length || 0} atribuições</li>
                            <li>✅ <strong>Remoção:</strong> ${removerData.success ? 'Sucesso' : 'Falha'}</li>
                            <li>✅ <strong>Listagem final:</strong> ${listagemFinalData.length || 0} atribuições</li>
                        </ul>
                        
                        <h5>🎯 Status do Sistema:</h5>
                        <ul>
                            <li>✅ <strong>Webhooks:</strong> Funcionando</li>
                            <li>✅ <strong>Banco de dados:</strong> Atualizando corretamente</li>
                            <li>✅ <strong>Permissões:</strong> Implementadas</li>
                            <li>✅ <strong>Frontend:</strong> Lógica atualizada</li>
                        </ul>
                        
                        <h5>🚀 Próximos Passos:</h5>
                        <ul>
                            <li>Testar no app real com usuários diferentes</li>
                            <li>Implementar interface de gerenciamento</li>
                            <li>Adicionar permissão ao perfil de administrador</li>
                        </ul>
                    </div>
                `
                
            } catch (error) {
                log(`❌ Erro no teste: ${error.message}`)
                
                resultadoDiv.innerHTML = `
                    <div class="test-section error">
                        <h4>❌ Erro no Sistema</h4>
                        <p><strong>Erro:</strong> ${error.message}</p>
                        <p><strong>Verifique:</strong></p>
                        <ul>
                            <li>Se todos os webhooks estão ativos</li>
                            <li>Se as permissões foram criadas no banco</li>
                            <li>Se a lógica do frontend está correta</li>
                        </ul>
                    </div>
                `
            }
        }

        // Executar teste automaticamente
        window.onload = function() {
            log('📋 Página carregada. Clique em "Testar Sistema Completo" para executar o teste.')
        }
    </script>
</body>
</html>
