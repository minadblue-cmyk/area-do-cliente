import{u as C,a as T,r as m,j as s,k as j}from"./index-CJnD_gLK.js";import{u as P}from"./useAgentPermissions-jwp_a9Ir.js";function L(){const{userData:l}=C(),x=T(e=>e.push),N=P(),[c,f]=m.useState([]),[h,w]=m.useState(!1),[p,b]=m.useState(null),[$,y]=m.useState(!1),[u,_]=m.useState({}),[g,k]=m.useState({}),A=async()=>{if(l){if(!N.canAccess){console.log("❌ Usuário não tem permissão para acessar agentes"),x({kind:"error",message:"Você não tem permissão para acessar agentes"});return}w(!0);try{console.log("🔍 Listando agentes...");const e=N.canViewAll||N.canManage,r=await j("webhook/list-agentes",{method:"GET",params:{usuario_id:l.id,list_all:e}});if(console.log("📥 Resposta do webhook:",r),r&&r.data){let a=[];Array.isArray(r.data)?a=r.data:(r.data.data&&Array.isArray(r.data.data)||r.data.success&&r.data.data)&&(a=r.data.data),console.log("✅ Agentes encontrados:",a.length),f(t=>{console.log("🔄 Estado anterior dos agentes:",t),console.log("🔄 Novos agentes do banco:",a);const o=a.map(n=>{const d=t.find(i=>i.id===n.id);return d?(console.log(`🔄 Preservando estado para ${n.nome}:`,{status_atual:d.status_atual,execution_id_ativo:d.execution_id_ativo}),{...n,status_atual:d.status_atual||n.status_atual,execution_id_ativo:d.execution_id_ativo!==void 0?d.execution_id_ativo:n.execution_id_ativo||null,updated_at:d.updated_at||n.updated_at}):n});return console.log("🔄 Agentes atualizados preservando estado:",o.length),console.log("🔄 Estado final dos agentes:",o),o})}else console.log("⚠️ Nenhum agente encontrado"),f([]),x({kind:"warning",message:"Nenhum agente encontrado"})}catch(e){console.error("❌ Erro ao listar agentes:",e),x({kind:"error",message:"Erro ao carregar agentes: "+e.message})}finally{w(!1)}}},I=async e=>{if(l){b(e.id);try{console.log(`🛑 Parando agente ${e.nome}...`),console.log("🔍 DEBUG AGENTE COMPLETO:",e),console.log("🔍 execution_id_ativo:",e.execution_id_ativo),console.log("🔍 execution_id:",e.execution_id),console.log("🔍 status_atual:",e.status_atual);const r=e.execution_id_ativo||e.execution_id||null;console.log("🔍 Execution ID final para envio:",r);const a={action:"stop",agent_type:e.id,workflow_id:e.id,timestamp:new Date().toISOString(),usuario_id:l.id,execution_id:r};console.log("📦 Payload enviado:",a);const t=e.webhook_stop_url;if(!t){console.warn(`⚠️ Agente ${e.nome} não tem webhook_stop_url configurado`),x({kind:"error",message:`Agente ${e.nome} não tem webhook de parada configurado`});return}console.log(`🔍 Usando webhook: ${t}`);const o=await j(t,{method:"POST",data:a});if(console.log("📥 Resposta do webhook stop:",o),o&&o.status===200){const n=Array.isArray(o.data)?o.data[0]:o.data;n?.success||n?.message?.includes("sucesso")?(f(d=>d.map(i=>i.id===e.id?{...i,status_atual:"stopped",execution_id_ativo:null,updated_at:new Date().toISOString()}:i)),console.log(`✅ ${e.nome} parado - Execution ID: ${e.execution_id_ativo}`)):(x({kind:"error",message:"Falha ao parar agente - resposta inválida"}),console.error("❌ Resposta inválida do webhook stop:",n))}else x({kind:"error",message:"Falha ao parar agente - erro de comunicação"}),console.error("❌ Erro de comunicação com webhook stop:",o)}catch(r){console.error("❌ Erro ao parar agente:",r),x({kind:"error",message:"Erro ao parar agente: "+r.message})}finally{b(null)}}},E=async(e,r=!1)=>{if(l){r||b(e.id);try{console.log(`🔍 Verificando status do agente ${e.nome}...`);const a=e.webhook_status_url;if(!a){console.warn(`⚠️ Agente ${e.nome} não tem webhook_status_url configurado`);return}console.log(`🔍 Usando webhook: ${a}`);const t=await j(a,{method:"GET",params:{workflow_id:e.id,usuario_id:l.id}});if(console.log("📥 Resposta do webhook status:",t),t&&t.status===200){let o="stopped",n=null;if(t.data&&t.data!==""){const d=Array.isArray(t.data)?t.data[0]:t.data;console.log("🔍 Dados do webhook status:",d);const i=d?.status_atual||d?.status||"stopped";i==="completed"||i==="finished"||i==="success"?o="stopped":i==="running"||i==="active"||i==="in_progress"?o="running":o="stopped",n=d?.execution_id_ativo||d?.execution_id||d?.executionId||null,console.log("🔍 Status original:",i,"→ Status mapeado:",o),console.log("🔍 Execution ID capturado:",n)}else e.execution_id_ativo&&(o="running",n=e.execution_id_ativo);f(d=>d.map(i=>i.id===e.id?{...i,status_atual:o,execution_id_ativo:n,updated_at:new Date().toISOString()}:i)),console.log(`✅ Status do ${e.nome} atualizado: ${o}`)}}catch(a){console.error("❌ Erro ao verificar status:",a),x({kind:"error",message:"Erro ao verificar status: "+a.message})}finally{r||b(null)}}},S=async()=>{if(!(!l||c.length===0)){console.log("🔄 Verificando status de todos os agentes...");for(const e of c)try{await E(e,!0),await new Promise(r=>setTimeout(r,500))}catch(r){console.error(`❌ Erro ao verificar status do agente ${e.nome}:`,r)}console.log("✅ Verificação de status concluída")}},v=async(e,r=!1)=>{if(l){k(a=>({...a,[e.id]:!0}));try{console.log(`📊 ${r?"Auto-atualizando":"Carregando"} dados da tabela para ${e.nome}...`);const a=e.webhook_lista_url;if(!a){console.warn(`⚠️ Agente ${e.nome} não tem webhook_lista_url configurado`);return}console.log(`🔍 Usando webhook: ${a}`);const t=await j(a,{method:"GET",params:{workflow_id:e.id,usuario_id:l.id}});if(console.log("📥 Resposta do webhook lista:",t),t&&t.status===200&&t.data){let o=[];Array.isArray(t.data)?o=t.data:(t.data.data&&Array.isArray(t.data.data)||t.data.success&&t.data.data)&&(o=t.data.data),_(n=>({...n,[e.id]:o})),console.log(`✅ ${o.length} itens carregados para ${e.nome}`)}else console.log(`⚠️ Nenhum dado encontrado para ${e.nome}`),_(o=>({...o,[e.id]:[]}))}catch(a){console.error(`❌ Erro ao carregar dados da tabela para ${e.nome}:`,a),_(t=>({...t,[e.id]:[]}))}finally{k(a=>({...a,[e.id]:!1}))}}},D=async e=>{if(l){b(e.id);try{console.log(`🚀 Iniciando agente ${e.nome}...`);const r={action:"start",agent_type:e.id,workflow_id:e.id,timestamp:new Date().toISOString(),usuario_id:l.id,logged_user:{id:l.id,name:l.name,email:l.mail}};console.log("📦 Payload enviado:",r);const a=e.webhook_start_url;if(!a){console.warn(`⚠️ Agente ${e.nome} não tem webhook_start_url configurado`),x({kind:"error",message:`Agente ${e.nome} não tem webhook de início configurado`});return}console.log(`🔍 Usando webhook: ${a}`);const t=await j(a,{method:"POST",data:r});console.log("📥 Resposta do webhook start:",t);const o=Array.isArray(t.data)?t.data[0]:t.data,n=o?.execution_id||o?.executionId||o?.id;console.log("🔍 Dados processados do start:",o),console.log("🔍 Execution ID extraído:",n),t&&t.status===200&&n?(f(d=>d.map(i=>i.id===e.id?{...i,status_atual:"running",execution_id_ativo:n,updated_at:new Date().toISOString()}:i)),console.log(`✅ ${e.nome} iniciado - Execution ID: ${n||"N/A"}`)):(x({kind:"error",message:"Falha ao iniciar agente - resposta inválida"}),console.error("❌ Resposta inválida do webhook start:",t))}catch(r){console.error("❌ Erro ao iniciar agente:",r),x({kind:"error",message:"Erro ao iniciar agente: "+r.message})}finally{b(null)}}};return m.useEffect(()=>{l&&A()},[l]),m.useEffect(()=>{if(l&&c.length>0){console.log("📊 Carregando dados da tabela automaticamente para todos os agentes...");const e=setTimeout(()=>{c.forEach(r=>{console.log(`🔄 Carregando dados da tabela para ${r.nome}`),v(r,!0)})},1e3);return()=>clearTimeout(e)}},[l,c.length]),m.useEffect(()=>{if(!l||c.length===0){y(!1);return}console.log("⏰ Iniciando refresh automático a cada 15 segundos"),y(!0);const e=setInterval(()=>{S()},15e3);return()=>{console.log("⏹️ Parando refresh automático"),y(!1),clearInterval(e)}},[l,c.length]),m.useEffect(()=>{if(!l||c.length===0)return;console.log("📊 Iniciando auto-refresh da tabela a cada 5 segundos");const e=setInterval(()=>{c.forEach(r=>{u[r.id]!==void 0&&(console.log(`🔄 Auto-atualizando dados da tabela para ${r.nome}`),v(r,!0))})},5e3);return()=>{console.log("⏹️ Parando auto-refresh da tabela"),clearInterval(e)}},[l,c.length,u]),s.jsxs("div",{className:"container mx-auto p-6 space-y-6",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{children:[s.jsx("h1",{className:"text-2xl font-bold",children:"Teste de Agente"}),s.jsx("p",{className:"text-muted-foreground",children:"Teste isolado das funcionalidades de agente"}),$&&s.jsxs("div",{className:"flex items-center gap-2 mt-2",children:[s.jsx("div",{className:"w-2 h-2 bg-green-500 rounded-full animate-pulse"}),s.jsx("span",{className:"text-sm text-green-600 font-medium",children:"Auto-refresh ativo (15s)"})]})]}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsxs("button",{onClick:A,disabled:h,className:"btn btn-primary flex items-center gap-2",children:[s.jsx("div",{className:`w-4 h-4 ${h?"animate-spin":""}`,children:"🔄"}),h?"Carregando...":"Listar Agentes"]}),s.jsxs("button",{onClick:()=>{c.forEach(e=>v(e))},disabled:h||c.length===0,className:"btn btn-secondary flex items-center gap-2",children:[s.jsx("span",{children:"📊"}),"Carregar Dados"]})]})]}),s.jsxs("div",{className:"card",children:[s.jsx("div",{className:"card-header",children:s.jsx("h2",{className:"text-lg font-semibold",children:"Status do Teste"})}),s.jsx("div",{className:"card-content",children:s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[s.jsxs("div",{className:"text-center p-4 bg-muted rounded-lg",children:[s.jsx("div",{className:"text-2xl font-bold text-primary",children:c.length}),s.jsx("div",{className:"text-sm text-muted-foreground",children:"Agentes Encontrados"})]}),s.jsxs("div",{className:"text-center p-4 bg-muted rounded-lg",children:[s.jsx("div",{className:"text-2xl font-bold text-green-600",children:c.filter(e=>e.ativo).length}),s.jsx("div",{className:"text-sm text-muted-foreground",children:"Agentes Ativos"})]}),s.jsxs("div",{className:"text-center p-4 bg-muted rounded-lg",children:[s.jsx("div",{className:"text-2xl font-bold text-blue-600",children:h?"...":"OK"}),s.jsx("div",{className:"text-sm text-muted-foreground",children:"Status"})]})]})})]}),s.jsxs("div",{className:"card",children:[s.jsx("div",{className:"card-header",children:s.jsx("h2",{className:"text-lg font-semibold",children:"Lista de Agentes"})}),s.jsx("div",{className:"card-content",children:h?s.jsxs("div",{className:"flex items-center justify-center py-8",children:[s.jsx("div",{className:"w-8 h-8 border-4 border-primary border-t-transparent rounded-full animate-spin"}),s.jsx("span",{className:"ml-2",children:"Carregando agentes..."})]}):c.length>0?s.jsx("div",{className:"space-y-4",children:c.map((e,r)=>s.jsxs("div",{className:"border border-border rounded-lg p-4",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{className:"flex items-center gap-3",children:[s.jsx("div",{className:"text-2xl",children:e.icone||"🤖"}),s.jsxs("div",{children:[s.jsx("h3",{className:"font-semibold",children:e.nome}),s.jsx("p",{className:"text-sm text-muted-foreground",children:e.descricao})]})]}),s.jsxs("div",{className:"flex items-center gap-3",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("span",{className:`px-2 py-1 rounded-full text-xs font-medium ${e.ativo?"bg-green-100 text-green-800 dark:bg-green-900/20 dark:text-green-400":"bg-red-100 text-red-800 dark:bg-red-900/20 dark:text-red-400"}`,children:e.ativo?"Ativo":"Inativo"}),s.jsx("div",{className:`w-3 h-3 rounded-full ${e.ativo?"bg-green-500":"bg-red-500"}`})]}),s.jsxs("div",{className:"flex items-center gap-2",children:[e.status_atual==="running"?s.jsx("button",{onClick:()=>I(e),disabled:p===e.id,className:`px-3 py-1 rounded-full text-xs font-medium transition-colors ${p===e.id?"bg-yellow-100 text-yellow-800 dark:bg-yellow-900/20 dark:text-yellow-400 cursor-not-allowed":"bg-red-100 text-red-800 dark:bg-red-900/20 dark:text-red-400 hover:bg-red-200 dark:hover:bg-red-900/30"}`,title:p===e.id?"Parando agente...":"Parar agente",children:p===e.id?s.jsxs("span",{className:"flex items-center gap-1",children:[s.jsx("div",{className:"w-3 h-3 border-2 border-current border-t-transparent rounded-full animate-spin"}),"Parando..."]}):"Parar"}):s.jsx("button",{onClick:()=>D(e),disabled:p===e.id,className:`px-3 py-1 rounded-full text-xs font-medium transition-colors ${p===e.id?"bg-yellow-100 text-yellow-800 dark:bg-yellow-900/20 dark:text-yellow-400 cursor-not-allowed":"bg-blue-100 text-blue-800 dark:bg-blue-900/20 dark:text-blue-400 hover:bg-blue-200 dark:hover:bg-blue-900/30"}`,title:p===e.id?"Iniciando agente...":"Iniciar agente",children:p===e.id?s.jsxs("span",{className:"flex items-center gap-1",children:[s.jsx("div",{className:"w-3 h-3 border-2 border-current border-t-transparent rounded-full animate-spin"}),"Iniciando..."]}):"Iniciar"}),s.jsx("button",{onClick:()=>E(e),disabled:p===e.id,className:"px-3 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800 dark:bg-gray-900/20 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-900/30 transition-colors",title:"Verificar status atual",children:"🔍"}),s.jsx("button",{onClick:()=>v(e),disabled:g[e.id],className:`px-2 py-1 rounded-full text-xs font-medium transition-colors ${g[e.id]?"bg-gray-100 text-gray-500 dark:bg-gray-900/20 dark:text-gray-600 cursor-not-allowed":"bg-purple-100 text-purple-800 dark:bg-purple-900/20 dark:text-purple-400 hover:bg-purple-200 dark:hover:bg-purple-900/30"}`,title:g[e.id]?"Atualizando dados...":"Carregar dados da tabela",children:g[e.id]?"⏳":"📊"}),s.jsx("button",{onClick:()=>{console.log("🔍 DEBUG BOTÃO CLICADO - Agente completo:",e),console.log("🔍 execution_id_ativo:",e.execution_id_ativo),console.log("🔍 execution_id:",e.execution_id),console.log("🔍 status_atual:",e.status_atual)},className:"px-2 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800 dark:bg-yellow-900/20 dark:text-yellow-400 hover:bg-yellow-200 dark:hover:bg-yellow-900/30 transition-colors",title:"Debug - verificar dados do agente",children:"🐛"})]})]})]}),s.jsxs("div",{className:"mt-3 grid grid-cols-2 md:grid-cols-4 gap-4 text-sm",children:[s.jsxs("div",{children:[s.jsx("span",{className:"text-muted-foreground",children:"ID:"}),s.jsx("span",{className:"ml-1 font-mono",children:e.id})]}),s.jsxs("div",{children:[s.jsx("span",{className:"text-muted-foreground",children:"Status Real:"}),s.jsx("span",{className:`ml-1 px-2 py-1 rounded-full text-xs font-medium ${e.status_atual==="running"?"bg-green-100 text-green-800 dark:bg-green-900/20 dark:text-green-400":e.status_atual==="stopped"?"bg-red-100 text-red-800 dark:bg-red-900/20 dark:text-red-400":"bg-gray-100 text-gray-800 dark:bg-gray-900/20 dark:text-gray-400"}`,children:e.status_atual==="running"?"Executando":e.status_atual==="stopped"?"Parado":e.status_atual||"Desconhecido"})]}),s.jsxs("div",{children:[s.jsx("span",{className:"text-muted-foreground",children:"Criado:"}),s.jsx("span",{className:"ml-1",children:e.created_at?new Date(e.created_at).toLocaleDateString("pt-BR"):"N/A"})]}),s.jsxs("div",{children:[s.jsx("span",{className:"text-muted-foreground",children:"Atualizado:"}),s.jsx("span",{className:"ml-1",children:e.updated_at?new Date(e.updated_at).toLocaleDateString("pt-BR"):"N/A"})]})]}),e.execution_id_ativo&&s.jsxs("div",{className:"mt-3 pt-3 border-t border-border",children:[s.jsx("h4",{className:"text-sm font-medium text-muted-foreground mb-2",children:"Execução Ativa:"}),s.jsxs("div",{className:"text-xs font-mono bg-green-50 dark:bg-green-900/20 p-2 rounded",children:["ID: ",e.execution_id_ativo]})]}),u[e.id]&&u[e.id].length>0&&s.jsxs("div",{className:"mt-4 pt-4 border-t border-border",children:[s.jsxs("div",{className:"flex items-center justify-between mb-3",children:[s.jsxs("div",{children:[s.jsxs("h4",{className:"text-sm font-medium text-muted-foreground flex items-center gap-2",children:["Dados da Tabela (",u[e.id].filter(a=>{const t=a.status||a.estado||"desconhecido";return t==="prospectando"||t==="concluido"||t==="completo"}).length," itens filtrados de ",u[e.id].length," total)",g[e.id]&&s.jsxs("span",{className:"flex items-center gap-1 text-xs text-blue-600 dark:text-blue-400",children:[s.jsx("div",{className:"w-3 h-3 border-2 border-current border-t-transparent rounded-full animate-spin"}),"Auto-atualizando..."]})]}),s.jsxs("div",{className:"flex items-center gap-4 mt-1 text-xs text-muted-foreground",children:[s.jsxs("span",{className:"flex items-center gap-1",children:[s.jsx("span",{className:"w-2 h-2 bg-yellow-500 rounded-full"}),"Prospectando: ",u[e.id].filter(a=>(a.status||a.estado)==="prospectando").length]}),s.jsxs("span",{className:"flex items-center gap-1",children:[s.jsx("span",{className:"w-2 h-2 bg-green-500 rounded-full"}),"Completo: ",u[e.id].filter(a=>["concluido","completo"].includes(a.status||a.estado)).length]})]})]}),s.jsx("button",{onClick:()=>v(e),disabled:g[e.id],className:`px-3 py-1 text-xs rounded transition-colors ${g[e.id]?"bg-gray-100 text-gray-500 dark:bg-gray-900/20 dark:text-gray-600 cursor-not-allowed":"bg-blue-100 text-blue-800 dark:bg-blue-900/20 dark:text-blue-400 hover:bg-blue-200 dark:hover:bg-blue-900/30"}`,children:g[e.id]?s.jsxs("span",{className:"flex items-center gap-1",children:[s.jsx("div",{className:"w-3 h-3 border-2 border-current border-t-transparent rounded-full animate-spin"}),"Atualizando..."]}):"🔄 Atualizar"})]}),s.jsxs("div",{className:"overflow-x-auto",children:[s.jsx("div",{className:"max-h-80 overflow-y-auto border border-border rounded-lg",children:s.jsxs("table",{className:"w-full text-sm",children:[s.jsx("thead",{className:"bg-muted sticky top-0 z-10",children:s.jsxs("tr",{children:[s.jsx("th",{className:"px-4 py-3 text-left font-semibold border-b border-border",children:"Nome"}),s.jsx("th",{className:"px-4 py-3 text-left font-semibold border-b border-border",children:"Telefone"}),s.jsx("th",{className:"px-4 py-3 text-center font-semibold border-b border-border",children:"Status"})]})}),s.jsx("tbody",{children:u[e.id].filter(a=>{const t=a.status||a.estado||"desconhecido";return t==="prospectando"||t==="concluido"||t==="completo"}).sort((a,t)=>{const o=a.status||a.estado||"desconhecido",n=t.status||t.estado||"desconhecido";return o==="prospectando"&&n!=="prospectando"?-1:o!=="prospectando"&&n==="prospectando"?1:0}).slice(0,10).map((a,t)=>{const o=a.nome_cliente||a.nome||a.name||"N/A",n=a.telefone||a.phone||"N/A",d=a.status||a.estado||"desconhecido";return s.jsxs("tr",{className:"border-b border-border hover:bg-muted/50 transition-colors",children:[s.jsx("td",{className:"px-4 py-3 border-r border-border",children:s.jsx("div",{className:"font-medium text-foreground truncate max-w-48",title:o,children:o})}),s.jsx("td",{className:"px-4 py-3 border-r border-border",children:s.jsx("div",{className:"font-mono text-sm text-muted-foreground",title:n,children:n})}),s.jsx("td",{className:"px-4 py-3 text-center",children:s.jsxs("span",{className:`inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium ${d==="prospectando"?"bg-yellow-100 text-yellow-800 dark:bg-yellow-900/20 dark:text-yellow-400":d==="concluido"||d==="completo"?"bg-green-100 text-green-800 dark:bg-green-900/20 dark:text-green-400":"bg-gray-100 text-gray-800 dark:bg-gray-900/20 dark:text-gray-400"}`,children:[d==="prospectando"&&"🔄",d==="concluido"&&"✅",d==="completo"&&"✅",!["prospectando","concluido","completo"].includes(d)&&"❓",s.jsx("span",{className:"ml-1 capitalize",children:d==="concluido"?"Completo":d})]})})]},t)})})]})}),(()=>{const a=u[e.id].filter(t=>{const o=t.status||t.estado||"desconhecido";return o==="prospectando"||o==="concluido"||o==="completo"});return a.length>10&&s.jsxs("div",{className:"text-xs text-muted-foreground mt-3 text-center bg-muted/50 py-2 rounded-b-lg",children:["Mostrando 10 de ",a.length," itens filtrados"]})})()]})]}),(!u[e.id]||u[e.id].length===0)&&s.jsx("div",{className:"mt-4 pt-4 border-t border-border",children:s.jsxs("div",{className:"text-center py-4 text-muted-foreground",children:[s.jsx("div",{className:"text-2xl mb-2",children:"📊"}),s.jsx("p",{className:"text-sm",children:"Nenhum dado carregado"}),s.jsx("p",{className:"text-xs",children:"Clique no botão 📊 para carregar dados da tabela"})]})})]},e.id||r))}):s.jsxs("div",{className:"text-center py-8 text-muted-foreground",children:[s.jsx("div",{className:"text-4xl mb-2",children:"🤖"}),s.jsx("p",{children:"Nenhum agente encontrado"}),s.jsx("p",{className:"text-sm",children:'Clique em "Listar Agentes" para carregar'})]})})]})]})}export{L as default};
