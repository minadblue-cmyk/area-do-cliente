import{r as l,a as ge,k as R,j as e,S as q,X as ae,o as Z,U as fe,u as G}from"./index-CJnD_gLK.js";import{u as Ce}from"./useScrollLock-DQTMuiZ-.js";import{S as Ae}from"./save-D0EATYqx.js";import{P as ke}from"./plus-BHj-BRdV.js";import{S as De}from"./search-CgJIrsuZ.js";import{R as Ue}from"./refresh-cw-Co52wWG9.js";import{S as Ie}from"./square-pen-DwoAyZhr.js";import{T as Te}from"./trash-2-BWDTMKj5.js";function Re({userId:P,userName:C,currentProfiles:b,onClose:h,onUpdate:x}){const[y,U]=l.useState([]),[f,_]=l.useState([]),[I,S]=l.useState(!1),[A,Y]=l.useState(""),F=ge(r=>r.push);Ce(!0),l.useEffect(()=>{z()},[]),l.useEffect(()=>{b.length>0&&_(b.map(r=>Number(r.id)))},[b]);async function z(){try{S(!0);const{data:r}=await R("webhook/list-profile",{method:"GET"});r&&Array.isArray(r)&&U(r)}catch(r){console.error("Erro ao carregar perfis:",r),F({kind:"error",message:"Erro ao carregar perfis"})}finally{S(!1)}}function M(r){_(N=>N.includes(r)?N.filter(w=>w!==r):[...N,r])}function m(){const r=y.map(N=>Number(N.id));_(r)}function Q(){_([])}async function W(){try{S(!0),await R("webhook/assign-user-profiles",{method:"POST",data:{usuario_id:P,perfis:f}}),F({kind:"success",message:"Perfis salvos com sucesso!"}),x(),h()}catch(r){console.error("Erro ao salvar perfis:",r),F({kind:"error",message:"Erro ao salvar perfis"})}finally{S(!1)}}const V=y.filter(r=>r.nome_perfil.toLowerCase().includes(A.toLowerCase())||r.descricao&&r.descricao.toLowerCase().includes(A.toLowerCase()));return f.reduce((r,N)=>{const w=y.find(O=>Number(O.id)===N);return w&&w.permissoes&&w.permissoes.forEach(O=>{r.find(H=>H.id===O.id)||r.push(O)}),r},[]),e.jsx("div",{className:"fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-2 sm:p-4",onWheel:r=>r.stopPropagation(),onClick:r=>{r.target===r.currentTarget&&h()},children:e.jsxs("div",{className:"bg-card border border-border rounded-lg w-full h-full max-w-7xl max-h-[95vh] flex flex-col",onWheel:r=>r.stopPropagation(),children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b border-border",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(q,{className:"w-6 h-6 text-primary"}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-semibold text-foreground",children:"Perfis do Usuário"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:C})]})]}),e.jsx("button",{onClick:h,className:"text-muted-foreground hover:text-foreground p-2 rounded-lg hover:bg-muted transition-colors",children:e.jsx(ae,{className:"w-6 h-6"})})]}),e.jsx("div",{className:"flex-1 overflow-hidden p-4 sm:p-6",children:e.jsxs("form",{className:"h-full flex flex-col space-y-4",children:[e.jsxs("div",{children:[e.jsx("input",{type:"text",placeholder:"Buscar perfis por nome ou descrição...",value:A,onChange:r=>Y(r.target.value),className:"w-full px-4 py-2 border border-border rounded-lg bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-primary"}),A&&e.jsxs("div",{className:"mt-2 text-sm text-muted-foreground",children:[V.length," de ",y.length," perfis encontrados"]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-lg font-medium text-foreground",children:"Perfis Disponíveis"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{type:"button",onClick:()=>m(),className:"text-sm px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors",children:"Selecionar Todos"}),e.jsx("button",{type:"button",onClick:()=>Q(),className:"text-sm px-3 py-1 bg-gray-600 text-white rounded hover:bg-gray-700 transition-colors",children:"Limpar Todos"})]})]}),e.jsx("div",{className:"flex-1 min-h-0",children:e.jsx("div",{className:"h-full overflow-y-auto space-y-3",children:I?e.jsx("div",{className:"text-center py-4 text-muted-foreground",children:"Carregando perfis..."}):V.length===0?e.jsx("div",{className:"text-center py-4 text-muted-foreground",children:A?"Nenhum perfil encontrado para a busca":"Nenhum perfil disponível"}):e.jsx("div",{className:"space-y-3",children:V.map(r=>{const N=Number(r.id),w=f.includes(N);return e.jsxs("label",{className:Z("flex items-start gap-3 p-4 rounded-lg border cursor-pointer transition-colors",w?"border-primary bg-primary/10 border-2":"border-border hover:bg-accent/50 hover:border-primary/50"),children:[e.jsx("input",{type:"checkbox",checked:w,onChange:()=>M(N),className:"mt-1 w-4 h-4 text-primary bg-background border-border rounded focus:ring-primary focus:ring-2"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"font-semibold text-foreground mb-1",children:r.nome_perfil}),e.jsx("div",{className:"text-sm text-muted-foreground mb-2",children:r.descricao||"Sem descrição"}),r.permissoes&&e.jsxs("div",{className:"text-xs text-primary",children:[r.permissoes.length," permissões"]})]})]},r.id)})})})})]})}),e.jsxs("div",{className:"flex flex-col sm:flex-row items-center justify-between p-4 sm:p-6 border-t border-border gap-3",children:[e.jsxs("div",{className:"text-sm text-muted-foreground",children:[f.length," perfil(is) selecionado(s)"]}),e.jsxs("div",{className:"flex items-center gap-2 sm:gap-3 w-full sm:w-auto",children:[e.jsxs("button",{onClick:h,className:"flex-1 sm:flex-none px-4 sm:px-6 py-2 sm:py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-500 transition-colors flex items-center justify-center gap-2 text-sm",children:[e.jsx(ae,{className:"w-4 h-4"}),e.jsx("span",{className:"hidden sm:inline",children:"Cancelar"}),e.jsx("span",{className:"sm:hidden",children:"Cancelar"})]}),e.jsxs("button",{onClick:W,disabled:I,className:"flex-1 sm:flex-none px-4 sm:px-6 py-2 sm:py-3 bg-primary text-primary-foreground rounded-lg hover:bg-primary/90 transition-colors flex items-center justify-center gap-2 disabled:opacity-50 text-sm",children:[e.jsx(Ae,{className:"w-4 h-4"}),e.jsx("span",{className:"hidden sm:inline",children:I?"Salvando...":"Salvar Perfis"}),e.jsx("span",{className:"sm:hidden",children:I?"Salvando...":"Salvar"})]})]})]})]})})}function Oe({selectedProfiles:P,availableProfiles:C,onToggleProfile:b,onOpenSelector:h,disabled:x=!1}){return e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-foreground",children:"Perfis de Acesso"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:Z("input cursor-pointer hover:bg-accent/50 transition-colors",x&&"opacity-50 cursor-not-allowed"),onClick:x?void 0:h,children:P.length>0?e.jsx("div",{className:"flex flex-wrap gap-1",children:P.map((y,U)=>{const f=C.find(_=>_.id===y);return f?e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 bg-primary/20 text-primary text-xs rounded-full",children:[f.nome_perfil,e.jsx("button",{type:"button",onClick:_=>{_.stopPropagation(),b(y)},className:"ml-1 hover:text-destructive",disabled:x,children:"×"})]},`selected-profile-${y}-${U}`):null})}):e.jsx("span",{className:"text-muted-foreground",children:x?"Carregando perfis...":"Clique para selecionar perfis"})}),e.jsxs("button",{type:"button",onClick:h,disabled:x,className:"btn-secondary w-full flex items-center justify-center gap-2",children:[e.jsx(q,{className:"w-4 h-4"}),"Gerenciar Perfis (",P.length,")"]})]})]})}function Le({isOpen:P,onClose:C,selectedProfiles:b,availableProfiles:h,onToggleProfile:x,onSave:y,loading:U=!1}){return P?e.jsx("div",{className:"fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 overflow-y-auto",children:e.jsxs("div",{className:"bg-card border border-border rounded-lg w-full max-w-2xl max-h-[90vh] flex flex-col my-8",children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b border-border",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(q,{className:"w-6 h-6 text-primary"}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold text-foreground",children:"Selecionar Perfis"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Escolha os perfis de acesso para este usuário"})]})]}),e.jsx("button",{onClick:C,className:"p-2 rounded-lg hover:bg-accent transition-colors",children:e.jsx(ae,{className:"w-5 h-5"})})]}),e.jsx("div",{className:"p-6 overflow-y-auto flex-1",children:e.jsx("div",{className:"space-y-4",children:h.length===0?e.jsx("div",{className:"text-center py-8",children:e.jsx("p",{className:"text-muted-foreground",children:"Nenhum perfil disponível"})}):e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:h.map((f,_)=>(console.log("Perfil no modal:",f),e.jsxs("label",{className:Z("flex items-start gap-3 p-4 rounded-lg border cursor-pointer transition-colors",b.includes(f.id)?"border-primary bg-primary/10":"border-border hover:bg-accent/50"),children:[e.jsx("input",{type:"checkbox",checked:b.includes(f.id),onChange:()=>x(f.id),className:"mt-1 rounded"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"font-medium text-foreground",children:f.nome_perfil}),e.jsx("div",{className:"text-sm text-muted-foreground mt-1",children:f.descricao||f.description||"Sem descrição"})]})]},`profile-${f.id}-${_}`)))})})}),e.jsxs("div",{className:"flex items-center justify-between p-6 border-t border-border flex-shrink-0",children:[e.jsxs("div",{className:"text-sm text-muted-foreground",children:[b.length," perfil",b.length!==1?"s":""," selecionado",b.length!==1?"s":""]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:C,className:"btn-secondary px-4 py-2 min-w-[100px]",children:"Cancelar"}),e.jsxs("button",{onClick:y,disabled:U,className:"btn-primary flex items-center gap-2 px-4 py-2 min-w-[120px]",children:[e.jsx(q,{className:"w-4 h-4"}),U?"Salvando...":"Salvar Perfis"]})]})]})]})}):null}function Me(){const[P,C]=l.useState([]),[b,h]=l.useState(!0),[x,y]=l.useState(""),[U,f]=l.useState(!1),[_,I]=l.useState(!1),[S,A]=l.useState(null),[Y,F]=l.useState(!1),[z,M]=l.useState(null),[m,Q]=l.useState([]),[W,V]=l.useState(!1),[r,N]=l.useState([]),[w,O]=l.useState(!1),[H,he]=l.useState(!1),[xe,ie]=l.useState(new Date),[L,ve]=l.useState(!0),[le,ne]=l.useState(!1),[ee,te]=l.useState(!1),[a,g]=l.useState({email:"",senha:"",nome:"",ativo:!0,empresa_id:"",plano:"basico",perfil_id:""}),[j,X]=l.useState([]),[je,se]=l.useState(!1),v=ge(s=>s.push);console.log("Estado empresas no componente:",m),console.log("Quantidade de empresas:",m.length),console.log("🔍 DEBUG - Empresas para dropdown:",m),console.log("🔍 DEBUG - Empresas.length:",m.length),console.log("🔍 DEBUG - Empresas é array?",Array.isArray(m)),l.useEffect(()=>{console.log("🔄 FormData mudou:",a),console.log("🔄 FormData.empresa_id:",a.empresa_id),console.log("🔄 FormData.perfil_id:",a.perfil_id),console.log("🔄 FormData.ativo:",a.ativo),console.log("🔄 FormData.plano:",a.plano)},[a]),l.useEffect(()=>{console.log("🔄 SelectedProfiles mudou:",j)},[j]),l.useEffect(()=>{console.log("🔄 EditingUser mudou:",S)},[S]);async function $(s,o){h(!0);try{const{data:n}=await R("webhook/list-users",{method:"GET"});console.log("Resposta completa do webhook/list-users:",n);let p=[];if(Array.isArray(n))p=n;else if(n&&Array.isArray(n.usuarios))p=n.usuarios;else if(n&&Array.isArray(n.data))p=n.data;else if(n&&Array.isArray(n.users))p=n.users;else{console.warn("Resposta não é um array:",n),C([]);return}console.log("🔍 Usuários carregados do webhook:",p);const u=s||m,k=o||r;console.log("🔍 Estado empresas no loadUsuarios:",u),console.log("🔍 Quantidade de empresas disponíveis:",u.length),p.length>0&&(console.log("🔍 Estrutura completa do primeiro usuário:",p[0]),console.log("🔍 Campos disponíveis:",Object.keys(p[0])));const t=p.map(i=>{console.log("👤 Processando usuário:",i.nome),console.log("👤 Dados originais do webhook:",{empresa_id:i.empresa_id,perfil_id:i.perfil_id,empresa:i.empresa,perfil:i.perfil});const c=i.empresa_id,d=i.perfil_id;let E=null;c&&(E=u.find(D=>D.id===c||D.id===Number(c)),console.log("🏢 Empresa encontrada por ID:",c,"->",E)),!E&&i.empresa&&(E=u.find(D=>D.nome_empresa===i.empresa),console.log("🏢 Empresa encontrada por nome (fallback):",i.empresa,"->",E));const pe=E?E.nome_empresa:i.empresa||"Sem empresa";console.log("📝 Nome da empresa final:",pe);let T=null;d&&(T=k.find(D=>D.id===d||D.id===Number(d)),console.log("👤 Perfil encontrado por ID:",d,"->",T)),!T&&i.perfil&&(T=k.find(D=>D.nome_perfil===i.perfil),console.log("👤 Perfil encontrado por nome (fallback):",i.perfil,"->",T));let ue=[];T&&(ue=[{...T,id:Number(T.id)}]);const B={...i,empresa:pe,empresa_id:c,ativo:i.ativo===!0||i.ativo==="true"||i.ativo===1,perfis:ue,perfil_id:d};return console.log("✅ Usuário mapeado:",{nome:B.nome,empresa_id:B.empresa_id,perfil_id:B.perfil_id,empresa:B.empresa}),B});C(t)}catch(n){console.error("Erro ao carregar usuários:",n),v({kind:"error",message:"Erro ao carregar usuários."})}finally{h(!1)}}async function J(){V(!0);try{console.log("Iniciando carregamento de empresas..."),console.log("Chamando webhook: webhook/list-company");const{data:s}=await R("webhook/list-company",{});console.log("Resposta completa do webhook/list-company:",s),console.log("Tipo da resposta:",typeof s),console.log("É array?",Array.isArray(s));let o=[];if(Array.isArray(s))o=s;else if(s&&Array.isArray(s.empresas))o=s.empresas;else if(s&&Array.isArray(s.data))o=s.data;else if(s&&Array.isArray(s.companies))o=s.companies;else return console.warn("Resposta não é um array:",s),Q([]),[];return console.log("Empresas carregadas:",o),console.log("Quantidade de empresas:",o.length),Q(o),console.log("Estado empresas atualizado!"),setTimeout(()=>{console.log("Estado empresas após setEmpresas:",o)},100),o}catch(s){return console.error("Erro ao carregar empresas:",s),console.error("Detalhes do erro:",s.message),v({kind:"error",message:"Erro ao carregar empresas."}),[]}finally{V(!1)}}async function K(){O(!0);try{const{data:s}=await R("webhook/list-profile",{});console.log("Resposta completa do webhook/list-profile:",s);let o=[];if(Array.isArray(s))s.length>0&&Array.isArray(s[0])&&s[0].length>0&&s[0][0].profiles?(o=s[0][0].profiles,console.log("✅ Detectado formato array duplo com profiles")):o=s;else if(s&&Array.isArray(s.perfis))o=s.perfis;else if(s&&Array.isArray(s.data))o=s.data;else if(s&&Array.isArray(s.profiles))o=s.profiles;else return console.warn("Resposta não é um array:",s),N([]),[];return console.log("Perfis carregados:",o),console.log("Primeiro perfil:",o[0]),console.log("Campos do primeiro perfil:",o[0]?Object.keys(o[0]):"Nenhum perfil"),o[0]&&(console.log("Campo descricao:",o[0].descricao),console.log("Campo description:",o[0].description),console.log("Todos os campos:",o[0])),console.log("✅ Perfis carregados com sucesso:",o),console.log("✅ Quantidade de perfis:",o.length),console.log("✅ Primeiro perfil:",o[0]),console.log("✅ Todos os perfis:",o.map(n=>({id:n.id,nome:n.nome_perfil}))),N(o),o}catch(s){return console.error("Erro ao carregar perfis:",s),console.error("Detalhes do erro:",s.message),v({kind:"error",message:"Erro ao carregar perfis."}),[]}finally{O(!1)}}l.useEffect(()=>{(async()=>{console.log("🔄 Iniciando carregamento de dados..."),console.log("📊 Carregando empresas..."),await J(),console.log("👥 Carregando perfis..."),await K(),console.log("✅ Carregamento inicial concluído!")})()},[]),l.useEffect(()=>{m.length>0&&r.length>0&&!H&&(console.log("🎯 Empresas e perfis carregados, carregando usuários..."),console.log("🎯 Empresas disponíveis:",m.length),console.log("🎯 Perfis disponíveis:",r.length),$(m,r),he(!0))},[m,r,H]),l.useEffect(()=>{console.log("🔄 Estado empresas mudou:",m),console.log("📊 Quantidade de empresas no estado:",m.length),console.log("📊 Empresas são array?",Array.isArray(m)),console.log("📊 Primeira empresa:",m[0])},[m]),l.useEffect(()=>{console.log("🔄 Estado perfis mudou:",r),console.log("📊 Quantidade de perfis no estado:",r.length),console.log("📊 Perfis são array?",Array.isArray(r)),console.log("📊 Primeiro perfil:",r[0]),console.log("📊 Todos os perfis no estado:",r.map(s=>({id:s.id,nome:s.nome_perfil})))},[r]),l.useEffect(()=>{if(!L)return;const s=setInterval(async()=>{console.log("🔄 Refresh automático iniciado..."),ne(!0);try{const o=await J(),n=await K();await $(o,n),ie(new Date),console.log("✅ Refresh automático concluído"),v({kind:"info",message:"Dados atualizados automaticamente"})}catch(o){console.error("❌ Erro no refresh automático:",o)}finally{ne(!1)}},3e4);return()=>clearInterval(s)},[L]);const oe=async()=>{console.log("🔄 Refresh manual iniciado..."),te(!0),h(!0);try{const s=await J(),o=await K();await $(s,o),ie(new Date),v({kind:"success",message:"Dados atualizados com sucesso!"}),console.log("✅ Refresh manual concluído")}catch(s){console.error("❌ Erro no refresh manual:",s),v({kind:"error",message:"Erro ao atualizar dados."})}finally{h(!1),te(!1)}};async function be(s){s.preventDefault();try{h(!0);const o=r.find(i=>i.id.toString()===a.perfil_id);let p=o?o.nome_perfil:"";if(!p&&j.length>0){const i=r.find(c=>j.includes(c.id));p=i?i.nome_perfil:""}const u=m.find(i=>i.id.toString()===a.empresa_id),k=u?u.nome_empresa:"",t={email:a.email.trim()||"",senha:a.senha&&a.senha.trim()!==""?a.senha.trim():"",nome:a.nome.trim()||"",ativo:a.ativo.toString(),empresa:k||"",empresa_id:a.empresa_id&&a.empresa_id!==""?parseInt(a.empresa_id):null,plano:a.plano||"basico",perfil:p||"",perfil_id:a.perfil_id&&a.perfil_id!==""?parseInt(a.perfil_id):null,perfis:j.length>0?j:[]};console.log("📤 Payload de criação:",t),console.log("📤 Campos validados:"),console.log("  - email:",t.email||"VAZIO"),console.log("  - senha:",t.senha?"PREENCHIDA":"VAZIA"),console.log("  - nome:",t.nome||"VAZIO"),console.log("  - ativo:",t.ativo),console.log("  - empresa:",t.empresa||"VAZIA"),console.log("  - empresa_id:",t.empresa_id),console.log("  - plano:",t.plano),console.log("  - perfil:",t.perfil||"VAZIO"),console.log("  - perfil_id:",t.perfil_id),console.log("  - perfis:",t.perfis),console.log("Payload enviado para webhook-criar-usuario:",t),await R("webhook-criar-usuario",{method:"POST",data:t}),g({email:"",senha:"",nome:"",ativo:!0,empresa_id:"",plano:"basico",perfil_id:""}),f(!1),v({kind:"success",message:"Usuário criado com sucesso!"}),await oe()}catch(o){console.error("Erro ao criar usuário:",o),v({kind:"error",message:"Erro ao criar usuário."})}}async function de(s){console.log("🚀 EDITAR USUÁRIO - ID:",s);try{const o=P.find(c=>c.id.toString()===s);if(!o){v({kind:"error",message:"Usuário não encontrado."});return}if(console.log("✅ USUÁRIO ENCONTRADO:",o),console.log("🔍 DADOS COMPLETOS DO USUÁRIO:"),console.log("  - ID:",o.id),console.log("  - Nome:",o.nome),console.log("  - Email:",o.email),console.log("  - empresa_id:",o.empresa_id,"(tipo:",typeof o.empresa_id,")"),console.log("  - perfil_id:",o.perfil_id,"(tipo:",typeof o.perfil_id,")"),console.log("  - empresa:",o.empresa),console.log("  - perfil:",o.perfis?.[0]?.nome_perfil),console.log("  - perfis array:",o.perfis),console.log("🔍 Empresas disponíveis:",m.length),console.log("🔍 Perfis disponíveis:",r.length),m.length===0||r.length===0){console.log("⚠️ Empresas ou perfis não carregados ainda, aguardando..."),setTimeout(()=>de(s),500);return}let n="";if(console.log("🔍 userToEdit.empresa_id:",o.empresa_id,"Tipo:",typeof o.empresa_id),o.empresa_id&&o.empresa_id!==null&&o.empresa_id!==void 0){const c=m.find(d=>d.id===o.empresa_id||d.id===Number(o.empresa_id)||Number(d.id)===o.empresa_id);console.log("🔍 Empresa encontrada:",c),console.log("🔍 Comparação de tipos - userToEdit.empresa_id:",o.empresa_id,typeof o.empresa_id),console.log("🔍 Empresas disponíveis com tipos:",m.map(d=>({id:d.id,tipo:typeof d.id,nome:d.nome_empresa}))),c?(n=c.id.toString(),console.log("✅ Empresa encontrada por empresa_id:",n)):(console.log("⚠️ Empresa_id não encontrado nas empresas disponíveis:",o.empresa_id),console.log("🔍 Empresas disponíveis:",m.map(d=>({id:d.id,nome:d.nome_empresa}))))}else console.log("⚠️ Usuário sem empresa_id definido");let p="";if(console.log("🔍 userToEdit.perfil_id:",o.perfil_id,"Tipo:",typeof o.perfil_id),console.log("🔍 userToEdit.perfis:",o.perfis),o.perfil_id&&o.perfil_id!==null&&o.perfil_id!==void 0){const c=r.find(d=>d.id===o.perfil_id||d.id===Number(o.perfil_id)||Number(d.id)===o.perfil_id);console.log("🔍 Perfil encontrado:",c),console.log("🔍 Comparação de tipos - userToEdit.perfil_id:",o.perfil_id,typeof o.perfil_id),console.log("🔍 Perfis disponíveis com tipos:",r.map(d=>({id:d.id,tipo:typeof d.id,nome:d.nome_perfil}))),c?(p=c.id.toString(),console.log("✅ Perfil encontrado por perfil_id:",p)):(console.log("⚠️ Perfil_id não encontrado nos perfis disponíveis:",o.perfil_id),console.log("🔍 Perfis disponíveis:",r.map(d=>({id:d.id,nome:d.nome_perfil}))))}else if(o.perfis&&o.perfis.length>0){const c=o.perfis[0],d=r.find(E=>E.id===c.id||E.id===Number(c.id)||Number(E.id)===c.id);d&&(p=d.id.toString(),console.log("✅ Perfil encontrado pelo array perfis:",p))}else console.log("⚠️ Usuário sem perfil_id ou perfis definidos");const u={email:o.email||"",senha:"",nome:o.nome||"",ativo:!!o.ativo,empresa_id:n,plano:o.plano||"basico",perfil_id:p};console.log("📝 FormData definido:",u),console.log("📝 RESUMO DO FORM DATA:"),console.log("  - email:",u.email),console.log("  - nome:",u.nome),console.log("  - ativo:",u.ativo),console.log("  - empresa_id:",u.empresa_id,"(string:",typeof u.empresa_id,")"),console.log("  - plano:",u.plano),console.log("  - perfil_id:",u.perfil_id,"(string:",typeof u.perfil_id,")");const k=o.perfis||[],t=k.map(c=>c.id),i=t.filter(c=>r.some(d=>d.id===c)).map(c=>Number(c));console.log("🔍 Perfis selecionados do usuário:",i),console.log("🔍 userProfiles:",k),console.log("🔍 profileIds:",t),g(u),X(i),A(o),I(!0),f(!1),console.log("✅ Formulário de edição configurado com sucesso!"),console.log("✅ Estados definidos:"),console.log("  - formData:",u),console.log("  - selectedProfiles:",i),console.log("  - editingUser:",o.nome),console.log("  - showEditForm: true")}catch(o){console.error("❌ Erro ao carregar dados do usuário:",o),v({kind:"error",message:"Erro ao carregar dados do usuário."})}}async function Ne(s){if(s.preventDefault(),!!S)try{const o=r.find(i=>i.id.toString()===a.perfil_id);let p=o?o.nome_perfil:"";if(!p&&j.length>0){const i=r.find(c=>j.includes(c.id));p=i?i.nome_perfil:""}const u=m.find(i=>i.id.toString()===a.empresa_id),k=u?u.nome_empresa:"",t={id:S.id,email:a.email||"",senha:a.senha&&a.senha.trim()!==""?a.senha.trim():"",nome:a.nome||"",ativo:a.ativo.toString(),empresa:k||"",empresa_id:a.empresa_id&&a.empresa_id!==""?parseInt(a.empresa_id):null,plano:a.plano||"basico",perfil:p||"",perfil_id:a.perfil_id&&a.perfil_id!==""?parseInt(a.perfil_id):null,perfis:j.length>0?j:[]};console.log("📤 Payload completo:",t),console.log("📤 Campos validados:"),console.log("  - email:",t.email||"VAZIO"),console.log("  - senha:",t.senha?"PREENCHIDA":"VAZIA"),console.log("  - nome:",t.nome||"VAZIO"),console.log("  - ativo:",t.ativo),console.log("  - empresa:",t.empresa||"VAZIA"),console.log("  - empresa_id:",t.empresa_id),console.log("  - plano:",t.plano),console.log("  - perfil:",t.perfil||"VAZIO"),console.log("  - perfil_id:",t.perfil_id),console.log("  - perfis:",t.perfis),console.log("Payload enviado para webhook/edit-users:",t),await R("webhook/edit-users",{method:"POST",data:t}),v({kind:"success",message:"Usuário atualizado com sucesso!"}),g({email:"",senha:"",nome:"",ativo:!0,empresa_id:"",plano:"basico",perfil_id:""}),X([]),A(null),I(!1),await oe()}catch(o){console.error("Erro ao atualizar usuário:",o),v({kind:"error",message:"Erro ao atualizar usuário."})}}function ye(){A(null),I(!1),X([]),se(!1),g({email:"",senha:"",nome:"",ativo:!0,empresa_id:"",plano:"basico",perfil_id:""})}async function _e(s){const o=G.getState().userData;if(o&&o.id===s){v({kind:"error",message:"Você não pode deletar sua própria conta!"});return}try{await R("webhook/delete-users",{method:"POST",data:{usuario_id:parseInt(s)}}),v({kind:"success",message:"Usuário removido com sucesso!"});const n=await J(),p=await K();await $(n,p)}catch(n){console.error("Erro ao deletar usuário:",n),v({kind:"error",message:"Erro ao remover usuário."})}}function we(s){M(s),F(!0)}function Se(){M(null),F(!1)}async function Ee(){await $(m,r)}function ce(s){X(o=>o.includes(s)?o.filter(n=>n!==s):[...o,s])}function Pe(){se(!0)}function me(){se(!1)}const re=P.filter(s=>s.nome.toLowerCase().includes(x.toLowerCase())||s.email.toLowerCase().includes(x.toLowerCase())||s.empresa.toLowerCase().includes(x.toLowerCase())||s.plano.toLowerCase().includes(x.toLowerCase()));return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-foreground",children:"Usuários"}),e.jsx("p",{className:"text-muted-foreground",children:"Gerencie usuários do sistema"})]}),e.jsxs("button",{onClick:()=>f(!0),className:"btn btn-primary flex items-center gap-2",children:[e.jsx(ke,{className:"w-4 h-4"}),"Criar Usuário"]})]}),e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx(De,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-muted-foreground w-4 h-4"}),e.jsx("input",{type:"text",placeholder:"Buscar usuários...",value:x,onChange:s=>y(s.target.value),className:"input pl-10"})]}),e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsx("div",{className:`w-2 h-2 rounded-full ${L?le?"bg-yellow-500 animate-pulse":"bg-green-500":"bg-gray-400"}`}),e.jsxs("span",{children:["Auto-refresh: ",L?le?"Atualizando...":"Ativo":"Inativo"]}),e.jsx("span",{children:"•"}),e.jsxs("span",{children:["Última atualização: ",xe.toLocaleTimeString()]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>ve(!L),className:`btn btn-sm ${L?"btn-outline":"btn-secondary"}`,children:L?"Pausar Auto-refresh":"Ativar Auto-refresh"}),e.jsxs("button",{onClick:oe,disabled:ee,className:"btn btn-outline flex items-center gap-2",children:[e.jsx(Ue,{className:`w-4 h-4 ${ee?"animate-spin":""}`}),ee?"Atualizando...":"Atualizar"]})]})]}),U&&e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"card-header",children:"Criar Novo Usuário"}),e.jsx("div",{className:"card-content",children:e.jsxs("form",{onSubmit:be,className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{className:"text-sm font-medium text-foreground",children:["Email ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{className:"input",type:"email",placeholder:"Digite o email do usuário",value:a.email,onChange:s=>g({...a,email:s.target.value}),required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{className:"text-sm font-medium text-foreground",children:["Senha ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{className:"input",type:"password",placeholder:"Digite a senha do usuário",value:a.senha,onChange:s=>g({...a,senha:s.target.value}),required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-foreground",children:"Nome Completo"}),e.jsx("input",{className:"input",placeholder:"Digite o nome completo do usuário",value:a.nome,onChange:s=>g({...a,nome:s.target.value})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-foreground",children:"Status do Usuário"}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:a.ativo,onChange:s=>g({...a,ativo:s.target.checked}),className:"rounded border-border"}),e.jsx("span",{className:"text-sm",children:"Usuário ativo"})]})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{className:"text-sm font-medium text-foreground",children:["Empresa ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{className:"input",value:a.empresa_id,onChange:s=>g({...a,empresa_id:s.target.value}),disabled:W,required:!0,children:[e.jsx("option",{value:"",children:"Selecione uma empresa"}),m.map(s=>(console.log("Renderizando empresa no dropdown:",s),e.jsx("option",{value:s.id,children:s.nome_empresa},s.id)))]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-foreground",children:"Perfil de Acesso"}),e.jsxs("select",{className:"input",value:a.perfil_id,onChange:s=>g({...a,perfil_id:s.target.value}),disabled:w,children:[e.jsx("option",{value:"",children:"Selecione um perfil"}),r.map(s=>e.jsxs("option",{value:s.id,children:[s.nome_perfil," - ",s.descricao||s.description||"Sem descrição"]},s.id))]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-foreground",children:"Plano"}),e.jsxs("select",{className:"input",value:a.plano,onChange:s=>g({...a,plano:s.target.value}),children:[e.jsx("option",{value:"",children:"Selecione um plano"}),e.jsx("option",{value:"basico",children:"Básico"}),e.jsx("option",{value:"premium",children:"Premium"}),e.jsx("option",{value:"enterprise",children:"Enterprise"})]})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{type:"submit",className:"btn btn-primary",children:"Criar Usuário"}),e.jsx("button",{type:"button",onClick:()=>f(!1),className:"btn btn-outline",children:"Cancelar"})]})]})})]}),_&&S&&e.jsxs("div",{className:"card",children:[e.jsxs("div",{className:"card-header",children:["Editar Usuário: ",S.nome]}),e.jsx("div",{className:"card-content",children:e.jsxs("form",{onSubmit:Ne,className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{className:"text-sm font-medium text-foreground",children:["Email ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{className:"input",type:"email",placeholder:"Digite o email do usuário",value:a.email,onChange:s=>g({...a,email:s.target.value}),required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-foreground",children:"Nova Senha"}),e.jsx("input",{className:"input",type:"password",placeholder:"Deixe em branco para manter a senha atual",value:a.senha,onChange:s=>g({...a,senha:s.target.value})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-foreground",children:"Nome Completo"}),e.jsx("input",{className:"input",placeholder:"Digite o nome completo do usuário",value:a.nome,onChange:s=>g({...a,nome:s.target.value})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-foreground",children:"Status do Usuário"}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:a.ativo,onChange:s=>g({...a,ativo:s.target.checked}),className:"rounded border-border"}),e.jsx("span",{className:"text-sm",children:"Usuário ativo"})]})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{className:"text-sm font-medium text-foreground",children:["Empresa ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{className:"input",value:a.empresa_id,onChange:s=>g({...a,empresa_id:s.target.value}),disabled:W,required:!0,children:[e.jsx("option",{value:"",children:"Selecione uma empresa"}),m.map(s=>{console.log("Renderizando empresa no dropdown EDITION:",s);const o=s.id.toString()===a.empresa_id;return console.log(`Empresa ${s.id} (${s.nome_empresa}) - Selecionada: ${o}`),e.jsx("option",{value:s.id,children:s.nome_empresa},s.id)})]}),e.jsxs("div",{className:"text-xs text-muted-foreground",children:['Debug EDITION: Valor atual = "',a.empresa_id,'", Total empresas = ',m.length]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-foreground",children:"Perfis de Acesso"}),e.jsxs("div",{className:"text-xs text-muted-foreground",children:["Debug: ",r.length," perfis disponíveis, ",j.length," selecionados",e.jsx("br",{}),"IDs selecionados: ",j.join(", ")||"Nenhum"]}),e.jsx(Oe,{selectedProfiles:j,availableProfiles:r,onToggleProfile:ce,onOpenSelector:Pe,disabled:w})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-foreground",children:"Plano"}),e.jsxs("select",{className:"input",value:a.plano,onChange:s=>g({...a,plano:s.target.value}),children:[e.jsx("option",{value:"",children:"Selecione um plano"}),e.jsx("option",{value:"basico",children:"Básico"}),e.jsx("option",{value:"premium",children:"Premium"}),e.jsx("option",{value:"enterprise",children:"Enterprise"})]}),e.jsxs("div",{className:"text-xs text-muted-foreground",children:['Debug EDITION: Plano atual = "',a.plano,'"']})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{type:"submit",className:"btn btn-primary",children:"Atualizar Usuário"}),e.jsx("button",{type:"button",onClick:ye,className:"btn btn-outline",children:"Cancelar"})]})]})})]}),e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"card-header",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(fe,{className:"w-5 h-5"}),"Usuários (",re.length,")"]})}),e.jsx("div",{className:"card-content",children:b?e.jsxs("div",{className:"text-center py-8",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto"}),e.jsx("p",{className:"text-muted-foreground mt-2",children:"Carregando usuários..."})]}):re.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(fe,{className:"w-12 h-12 text-muted-foreground mx-auto mb-4"}),e.jsx("p",{className:"text-muted-foreground",children:"Nenhum usuário encontrado"})]}):e.jsx("div",{className:"space-y-4",children:re.map(s=>e.jsx("div",{className:"border border-border rounded-lg p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("h3",{className:"font-semibold text-foreground",children:s.nome}),e.jsx("span",{className:Z("px-2 py-1 text-xs rounded-full",s.ativo?"bg-green-500/20 text-green-400":"bg-red-500/20 text-red-400"),children:s.ativo?"Ativo":"Inativo"})]}),e.jsxs("div",{className:"text-sm text-muted-foreground space-y-1",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Email:"})," ",s.email]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Empresa:"})," ",s.empresa]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Plano:"})," ",s.plano]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Criado em:"})," ",new Date(s.created_at).toLocaleDateString("pt-BR")]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>de(s.id.toString()),className:"p-2 rounded hover:bg-muted/50 transition-colors",title:"Editar usuário",children:e.jsx(Ie,{className:"w-4 h-4 text-muted-foreground"})}),e.jsx("button",{onClick:()=>we(s),className:"p-2 rounded hover:bg-primary/20 transition-colors",title:"Gerenciar perfis do usuário",children:e.jsx(q,{className:"w-4 h-4 text-primary"})}),e.jsx("button",{onClick:()=>_e(s.id.toString()),disabled:G.getState().userData?.id===s.id.toString(),className:Z("p-2 rounded transition-colors",G.getState().userData?.id===s.id.toString()?"opacity-50 cursor-not-allowed":"hover:bg-destructive/20"),title:G.getState().userData?.id===s.id.toString()?"Você não pode deletar sua própria conta":"Excluir usuário",children:e.jsx(Te,{className:Z("w-4 h-4",G.getState().userData?.id===s.id.toString()?"text-muted-foreground":"text-destructive")})})]})]})},s.id))})})]}),Y&&z&&e.jsx(Re,{userId:z.id.toString(),userName:z.nome,currentProfiles:z.perfis||[],onClose:Se,onUpdate:Ee}),e.jsx(Le,{isOpen:je,onClose:me,selectedProfiles:j,availableProfiles:r,onToggleProfile:ce,onSave:me,loading:w})]})}export{Me as default};
