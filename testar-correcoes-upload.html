<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Corre√ß√µes Upload</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background: #0056b3; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Teste das Corre√ß√µes na P√°gina Upload</h1>
        
        <div class="test-section info">
            <h3>üìã Corre√ß√µes Implementadas</h3>
            <ul>
                <li>‚úÖ <strong>Sincroniza√ß√£o de Agentes:</strong> Ocultada para clientes (apenas admins veem)</li>
                <li>‚úÖ <strong>Filtro de Agentes:</strong> Aplicado aos syncedAgents com permiss√µes</li>
                <li>‚úÖ <strong>Seguran√ßa:</strong> Apenas agentes pr√≥prios s√£o exibidos</li>
            </ul>
        </div>

        <div class="test-section">
            <h3>üîß Teste de Filtro com syncedAgents</h3>
            <button onclick="testarFiltroSyncedAgents()">Testar Filtro syncedAgents</button>
            <div id="resultado"></div>
        </div>

        <div class="test-section">
            <h3>üìä Logs Detalhados</h3>
            <div id="logs"></div>
        </div>
    </div>

    <script>
        // Dados de teste (simulando syncedAgents)
        const syncedAgents = {
            "65": {
                "id": 65,
                "nome": "Jo√£o",
                "descricao": "",
                "icone": "ü§ñ",
                "cor": "bg-pink-500",
                "ativo": true,
                "usuario_id": 6,
                "status_atual": "stopped"
            },
            "68": {
                "id": 68,
                "nome": "Joana",
                "descricao": "joana",
                "icone": "üéØ",
                "cor": "bg-yellow-500",
                "ativo": true,
                "usuario_id": 5,
                "status_atual": "stopped"
            },
            "69": {
                "id": 69,
                "nome": "Teste Agente",
                "descricao": "Agente de teste",
                "icone": "ü§ñ",
                "cor": "bg-blue-500",
                "ativo": true,
                "usuario_id": 6,
                "status_atual": "stopped"
            }
        }

        // Simular dados do usu√°rio e permiss√µes
        const userData = {
            id: "6",
            name: "Teste de Dashboard",
            perfil_id: 32
        }

        const agentPermissions = {
            canViewAll: false,
            canManage: false,
            canViewOwn: true
        }

        function log(message) {
            const logsDiv = document.getElementById('logs')
            const timestamp = new Date().toLocaleTimeString()
            logsDiv.innerHTML += `<div>[${timestamp}] ${message}</div>`
        }

        function testarFiltroSyncedAgents() {
            log('üîç Testando filtro de syncedAgents...')
            
            const newAgentTypes = {}
            
            Object.entries(syncedAgents).forEach(([agentId, agentData]) => {
                log(`üîç Processando agente: ${agentData.nome} (usuario_id: ${agentData.usuario_id})`)
                
                // Aplicar filtro de permiss√µes (l√≥gica corrigida)
                const shouldShowAgent = (() => {
                    // Se pode ver todos os agentes, mostrar todos
                    if (agentPermissions.canViewAll || agentPermissions.canManage) {
                        log(`‚úÖ ${agentData.nome}: Mostrando (canViewAll/canManage)`)
                        return true
                    }
                    
                    // Se pode ver apenas seus pr√≥prios agentes, filtrar por user_id
                    if (agentPermissions.canViewOwn) {
                        const userId = parseInt(userData.id)
                        const matches = agentData.user_id === userId || agentData.usuario_id === userId
                        log(`üîç ${agentData.nome}: Comparando ${agentData.usuario_id} === ${userId} = ${matches}`)
                        return matches
                    }
                    
                    // Se n√£o tem permiss√£o espec√≠fica, n√£o mostrar nenhum
                    log(`‚ùå ${agentData.nome}: Sem permiss√£o espec√≠fica`)
                    return false
                })()
                
                if (shouldShowAgent) {
                    newAgentTypes[agentId] = {
                        id: agentId,
                        name: agentData.nome,
                        description: agentData.descricao || 'Agente de prospec√ß√£o',
                        icon: agentData.icone || 'ü§ñ',
                        color: agentData.cor || 'bg-blue-500',
                        webhook: 'webhook-generic'
                    }
                    log(`‚úÖ ${agentData.nome}: Adicionado ao dynamicAgentTypes`)
                } else {
                    log(`‚ùå ${agentData.nome}: Filtrado (n√£o pertence ao usu√°rio)`)
                }
            })
            
            log(`üîç Agentes filtrados por permiss√£o: ${Object.keys(newAgentTypes).length} de ${Object.keys(syncedAgents).length}`)
            
            // Mostrar resultado
            const resultadoDiv = document.getElementById('resultado')
            resultadoDiv.innerHTML = `
                <h4>üìä Resultado do Filtro syncedAgents:</h4>
                <p><strong>Total de agentes sincronizados:</strong> ${Object.keys(syncedAgents).length}</p>
                <p><strong>Agentes filtrados:</strong> ${Object.keys(newAgentTypes).length}</p>
                <p><strong>Agentes que devem aparecer:</strong></p>
                <ul>
                    ${Object.values(newAgentTypes).map(agent => 
                        `<li>‚úÖ ${agent.name} (ID: ${agent.id})</li>`
                    ).join('')}
                </ul>
                <p><strong>Agentes que N√ÉO devem aparecer:</strong></p>
                <ul>
                    ${Object.entries(syncedAgents)
                        .filter(([id, agent]) => !newAgentTypes[id])
                        .map(([id, agent]) => 
                            `<li>‚ùå ${agent.nome} (ID: ${id}, usuario_id: ${agent.usuario_id})</li>`
                        ).join('')}
                </ul>
            `
            
            // Verificar se o resultado est√° correto
            const expectedCount = 2 // Jo√£o e Teste Agente
            const actualCount = Object.keys(newAgentTypes).length
            
            if (actualCount === expectedCount) {
                log('üéâ SUCESSO: Filtro de syncedAgents funcionando corretamente!')
                resultadoDiv.className = 'test-section success'
            } else {
                log(`‚ùå ERRO: Esperado ${expectedCount} agentes, mas encontrado ${actualCount}`)
                resultadoDiv.className = 'test-section error'
            }
        }

        // Executar teste automaticamente
        window.onload = function() {
            log('üìã P√°gina carregada. Clique em "Testar Filtro syncedAgents" para executar o teste.')
        }
    </script>
</body>
</html>
