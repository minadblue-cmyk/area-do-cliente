<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Permiss√µes Admin Upload</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #1a1a1a; color: #fff; }
        .container { max-width: 1000px; margin: 0 auto; }
        .section { background: #2a2a2a; padding: 20px; margin: 10px 0; border-radius: 8px; }
        .success { color: #4ade80; }
        .error { color: #f87171; }
        .warning { color: #fbbf24; }
        .info { color: #60a5fa; }
        button { background: #3b82f6; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #2563eb; }
        pre { background: #1e1e1e; padding: 15px; border-radius: 5px; overflow-x: auto; }
        .agent-card { background: #1e1e1e; padding: 15px; margin: 10px 0; border-radius: 5px; border-left: 4px solid #3b82f6; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Debug Permiss√µes Admin Upload</h1>
        
        <div class="section">
            <h2>1. Simular Login do Admin</h2>
            <button onclick="simularLoginAdmin()">Simular Login Admin</button>
            <div id="login"></div>
        </div>

        <div class="section">
            <h2>2. Testar Permiss√µes do Admin</h2>
            <button onclick="testarPermissoes()">Testar Permiss√µes</button>
            <div id="permissoes"></div>
        </div>

        <div class="section">
            <h2>3. Simular Carregamento de Agentes</h2>
            <button onclick="simularCarregamento()">Simular Carregamento</button>
            <div id="carregamento"></div>
        </div>

        <div class="section">
            <h2>4. Verificar Console da Aplica√ß√£o Real</h2>
            <button onclick="verificarConsoleReal()">Verificar Console Real</button>
            <div id="console"></div>
        </div>
    </div>

    <script>
        async function simularLoginAdmin() {
            const resultDiv = document.getElementById('login')
            resultDiv.innerHTML = '<p class="info">üîÑ Simulando login do admin...</p>'
            
            try {
                // Simular dados do admin
                const adminData = {
                    id: "5",
                    name: "Administrator Code-IQ",
                    email: "admin@teste.com",
                    perfil_id: 1,
                    perfil: "Administrador",
                    permissions: [
                        "visualizar_dashboard",
                        "visualizar_pgina_de_upload",
                        "iniciar_agente",
                        "visualizar_status_do_agente",
                        "administrar_agente_de_outros_usu√°rios",
                        "atribuir_agentes_usuarios"
                    ]
                }
                
                resultDiv.innerHTML = `
                    <h3 class="info">üë§ Dados do Admin</h3>
                    <p><strong>ID:</strong> ${adminData.id}</p>
                    <p><strong>Nome:</strong> ${adminData.name}</p>
                    <p><strong>Email:</strong> ${adminData.email}</p>
                    <p><strong>Perfil ID:</strong> ${adminData.perfil_id}</p>
                    <p><strong>Perfil:</strong> ${adminData.perfil}</p>
                    <p><strong>Permiss√µes:</strong> ${adminData.permissions.length}</p>
                    
                    <h4>Permiss√µes:</h4>
                    <ul>
                        ${adminData.permissions.map(perm => `<li>${perm}</li>`).join('')}
                    </ul>
                    
                    <p class="success">‚úÖ Dados do admin simulados com sucesso</p>
                `
                
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">‚ùå Erro: ${error.message}</p>`
            }
        }

        function testarPermissoes() {
            const resultDiv = document.getElementById('permissoes')
            
            // Simular permiss√µes do admin
            const adminPermissions = {
                canViewAll: true,
                canManage: true,
                canViewOwn: true,
                canAssignAgents: true,
                canAccess: true
            }
            
            resultDiv.innerHTML = `
                <h3 class="info">üîê Permiss√µes do Admin</h3>
                
                <div class="agent-card">
                    <h4>Permiss√µes Calculadas:</h4>
                    <ul>
                        <li><strong>canViewAll:</strong> ${adminPermissions.canViewAll} ‚úÖ</li>
                        <li><strong>canManage:</strong> ${adminPermissions.canManage} ‚úÖ</li>
                        <li><strong>canViewOwn:</strong> ${adminPermissions.canViewOwn} ‚úÖ</li>
                        <li><strong>canAssignAgents:</strong> ${adminPermissions.canAssignAgents} ‚úÖ</li>
                        <li><strong>canAccess:</strong> ${adminPermissions.canAccess} ‚úÖ</li>
                    </ul>
                </div>
                
                <div class="agent-card">
                    <h4>L√≥gica de Filtro:</h4>
                    <p><strong>Se canViewAll ou canManage:</strong> Mostrar TODOS os agentes</p>
                    <p class="success">‚úÖ Admin deve ver todos os agentes</p>
                </div>
                
                <div class="agent-card">
                    <h4>Verifica√ß√£o de Acesso:</h4>
                    <p><strong>canAccess:</strong> ${adminPermissions.canAccess}</p>
                    <p class="${adminPermissions.canAccess ? 'success' : 'error'}">
                        ${adminPermissions.canAccess ? '‚úÖ Admin pode acessar agentes' : '‚ùå Admin n√£o pode acessar agentes'}
                    </p>
                </div>
            `
        }

        async function simularCarregamento() {
            const resultDiv = document.getElementById('carregamento')
            resultDiv.innerHTML = '<p class="info">üîÑ Simulando carregamento de agentes...</p>'
            
            try {
                // Simular chamada do webhook
                const response = await fetch('https://n8n.code-iq.com.br/webhook/list-agentes', {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' }
                })
                
                const data = await response.json()
                
                // Simular parsing
                let agentesList = []
                if (Array.isArray(data)) {
                    agentesList = data
                } else if (data.data && Array.isArray(data.data)) {
                    agentesList = data.data
                } else if (data.success && data.data) {
                    agentesList = data.data
                }
                
                // Extrair agentes
                let agentes = []
                if (Array.isArray(agentesList) && agentesList.length > 0 && agentesList[0].success && Array.isArray(agentesList[0].data)) {
                    agentes = agentesList[0].data
                }
                
                // Simular filtro
                const agentesFiltrados = agentes.filter((agente) => {
                    // Admin v√™ todos
                    return true
                })
                
                resultDiv.innerHTML = `
                    <h3 class="info">üîÑ Simula√ß√£o de Carregamento</h3>
                    
                    <div class="agent-card">
                        <h4>Passo 1: Webhook</h4>
                        <p><strong>Status:</strong> ${response.status}</p>
                        <p><strong>Agentes retornados:</strong> ${agentes.length}</p>
                    </div>
                    
                    <div class="agent-card">
                        <h4>Passo 2: Parsing</h4>
                        <p><strong>Agentes extra√≠dos:</strong> ${agentes.length}</p>
                        <p class="success">‚úÖ Parsing funcionando</p>
                    </div>
                    
                    <div class="agent-card">
                        <h4>Passo 3: Filtro</h4>
                        <p><strong>Agentes filtrados:</strong> ${agentesFiltrados.length}</p>
                        <p class="success">‚úÖ Filtro funcionando</p>
                    </div>
                    
                    <div class="agent-card">
                        <h4>Passo 4: Renderiza√ß√£o</h4>
                        <p><strong>Agentes para renderizar:</strong> ${agentesFiltrados.length}</p>
                        <p class="${agentesFiltrados.length === 3 ? 'success' : 'error'}">
                            ${agentesFiltrados.length === 3 ? '‚úÖ Deve mostrar 3 agentes' : '‚ùå Problema na renderiza√ß√£o'}
                        </p>
                    </div>
                    
                    <h4>Agentes que devem aparecer:</h4>
                    ${agentesFiltrados.map(agente => `
                        <div class="agent-card">
                            <strong>${agente.nome}</strong> (ID: ${agente.id})
                            <br>Usu√°rio ID: ${agente.usuario_id}
                            <br>Status: ${agente.status_atual || 'stopped'}
                        </div>
                    `).join('')}
                `
                
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">‚ùå Erro: ${error.message}</p>`
            }
        }

        function verificarConsoleReal() {
            const resultDiv = document.getElementById('console')
            
            resultDiv.innerHTML = `
                <h3 class="info">üîç Verifica√ß√£o do Console Real</h3>
                
                <div class="agent-card">
                    <h4>Mensagens que DEVEM aparecer:</h4>
                    <ol>
                        <li><code>UploadPage componente carregado</code></li>
                        <li><code>üîç Listando agentes...</code></li>
                        <li><code>üì• Resposta do webhook: {...}</code></li>
                        <li><code>‚úÖ Agentes encontrados: 3</code></li>
                        <li><code>üîç Filtrando agente: Joana (usuario_id: 5)</code></li>
                        <li><code>‚úÖ Joana: Mostrando (ADMIN - v√™ todos)</code></li>
                        <li><code>üîç Agentes filtrados: 3 de 3</code></li>
                    </ol>
                </div>
                
                <div class="agent-card">
                    <h4>Se N√ÉO aparecer as mensagens:</h4>
                    <ul>
                        <li>‚ùå <code>useEffect</code> n√£o est√° sendo executado</li>
                        <li>‚ùå <code>userData</code> n√£o est√° dispon√≠vel</li>
                        <li>‚ùå <code>listarAgentes()</code> n√£o est√° sendo chamado</li>
                        <li>‚ùå <code>agentPermissions</code> retornando valores incorretos</li>
                    </ul>
                </div>
                
                <div class="agent-card">
                    <h4>Pr√≥ximos passos:</h4>
                    <ol>
                        <li>Abra o console da aplica√ß√£o (F12)</li>
                        <li>Recarregue a p√°gina</li>
                        <li>Verifique se as mensagens aparecem</li>
                        <li>Se n√£o aparecer, verifique se o admin est√° logado</li>
                        <li>Verifique se as permiss√µes est√£o corretas</li>
                    </ol>
                </div>
            `
        }

        // Auto-executar
        window.onload = function() {
            simularLoginAdmin()
            testarPermissoes()
            simularCarregamento()
            verificarConsoleReal()
        }
    </script>
</body>
</html>
