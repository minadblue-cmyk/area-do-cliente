<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Permiss√µes Supervisor</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #1a1a1a; color: #fff; }
        .container { max-width: 1000px; margin: 0 auto; }
        .section { background: #2a2a2a; padding: 20px; margin: 10px 0; border-radius: 8px; }
        .success { color: #4ade80; }
        .error { color: #f87171; }
        .warning { color: #fbbf24; }
        .info { color: #60a5fa; }
        button { background: #3b82f6; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #2563eb; }
        pre { background: #1e1e1e; padding: 15px; border-radius: 5px; overflow-x: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Debug Permiss√µes do Supervisor</h1>
        
        <div class="section">
            <h2>1. Simular Login do Supervisor</h2>
            <button onclick="simularLoginSupervisor()">Login como Supervisor</button>
            <div id="login"></div>
        </div>

        <div class="section">
            <h2>2. Verificar Permiss√µes do Supervisor</h2>
            <button onclick="verificarPermissoes()">Verificar Permiss√µes</button>
            <div id="permissoes"></div>
        </div>

        <div class="section">
            <h2>3. Testar Filtro de Agentes</h2>
            <button onclick="testarFiltro()">Testar Filtro</button>
            <div id="filtro"></div>
        </div>

        <div class="section">
            <h2>4. Comparar com Aplica√ß√£o Real</h2>
            <button onclick="compararAplicacao()">Comparar com Aplica√ß√£o</button>
            <div id="comparacao"></div>
        </div>
    </div>

    <script>
        async function simularLoginSupervisor() {
            const resultDiv = document.getElementById('login')
            
            // Simular login do supervisor
            const userData = {
                id: "6",
                name: "Supervisor Elleve Cons√≥rcios",
                email: "supervisor@teste.com",
                perfil_id: 42,
                perfil: "Supervisor Elleve Cons√≥rcios",
                permissions: []
            }
            
            localStorage.setItem('userData', JSON.stringify(userData))
            
            resultDiv.innerHTML = `
                <h3 class="success">‚úÖ Login do Supervisor Simulado</h3>
                <p><strong>ID:</strong> ${userData.id}</p>
                <p><strong>Nome:</strong> ${userData.name}</p>
                <p><strong>Perfil ID:</strong> ${userData.perfil_id}</p>
                <p><strong>Perfil:</strong> ${userData.perfil}</p>
            `
        }

        async function verificarPermissoes() {
            const resultDiv = document.getElementById('permissoes')
            resultDiv.innerHTML = '<p class="info">üîÑ Verificando permiss√µes...</p>'
            
            try {
                // Buscar permiss√µes do perfil 42
                const response = await fetch('https://n8n-lavo-n8n.15gxno.easypanel.host/webhook/list-permission', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ perfil_id: 42 })
                })
                
                const data = await response.json()
                const permissoes = data.data || []
                
                // Buscar perfil 42
                const responsePerfil = await fetch('https://n8n-lavo-n8n.15gxno.easypanel.host/webhook/list-profile', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ perfil_id: 42 })
                })
                
                const dataPerfil = await responsePerfil.json()
                const perfil = dataPerfil.data || {}
                
                resultDiv.innerHTML = `
                    <h3 class="info">üîë Permiss√µes do Supervisor (Perfil ID: 42)</h3>
                    <p><strong>Perfil:</strong> ${perfil.nome_perfil || 'N/A'}</p>
                    <p><strong>Total de permiss√µes:</strong> ${permissoes.length}</p>
                    
                    <h4>Permiss√µes encontradas:</h4>
                    <ul>
                        ${permissoes.map(p => `
                            <li>
                                <strong>${p.nome_permissao}</strong> (ID: ${p.id})
                                <br>Descri√ß√£o: ${p.descricao || 'N/A'}
                            </li>
                        `).join('')}
                    </ul>
                    
                    <h4>Permiss√µes espec√≠ficas de agentes:</h4>
                    <ul>
                        <li><strong>visualizar_status_do_agente:</strong> ${permissoes.some(p => p.nome_permissao === 'visualizar_status_do_agente') ? '‚úÖ' : '‚ùå'}</li>
                        <li><strong>iniciar_agente:</strong> ${permissoes.some(p => p.nome_permissao === 'iniciar_agente') ? '‚úÖ' : '‚ùå'}</li>
                        <li><strong>parar_agente:</strong> ${permissoes.some(p => p.nome_permissao === 'parar_agente') ? '‚úÖ' : '‚ùå'}</li>
                        <li><strong>atribuir_agentes_usuarios:</strong> ${permissoes.some(p => p.nome_permissao === 'atribuir_agentes_usuarios') ? '‚úÖ' : '‚ùå'}</li>
                    </ul>
                `
                
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">‚ùå Erro: ${error.message}</p>`
            }
        }

        async function testarFiltro() {
            const resultDiv = document.getElementById('filtro')
            resultDiv.innerHTML = '<p class="info">üîÑ Testando filtro...</p>'
            
            try {
                // Buscar agentes
                const response = await fetch('https://n8n.code-iq.com.br/webhook/list-agentes', {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' }
                })
                
                const data = await response.json()
                const agentes = data.data || []
                
                // Simular l√≥gica de permiss√µes do supervisor
                const userData = JSON.parse(localStorage.getItem('userData') || '{}')
                const userId = parseInt(userData.id || '0')
                
                // Simular permiss√µes baseadas no que sabemos
                const agentPermissions = {
                    canViewAll: false,
                    canManage: false,
                    canViewOwn: true, // Supervisor tem iniciar_agente = true
                    canAssignAgents: false
                }
                
                // Aplicar filtro
                const agentesFiltrados = agentes.filter(agente => {
                    console.log(`üîç Filtrando agente: ${agente.nome} (usuario_id: ${agente.usuario_id})`)
                    
                    // Se pode ver todos os agentes, mostrar todos
                    if (agentPermissions.canViewAll || agentPermissions.canManage) {
                        console.log(`‚úÖ ${agente.nome}: Mostrando (canViewAll/canManage)`)
                        return true
                    }
                    
                    // Se pode ver apenas seus pr√≥prios agentes, filtrar por user_id
                    if (agentPermissions.canViewOwn) {
                        const matches = agente.usuario_id === userId
                        console.log(`üîç ${agente.nome}: Comparando ${agente.usuario_id} === ${userId} = ${matches}`)
                        return matches
                    }
                    
                    // Se tem permiss√£o de atribui√ß√£o, verificar atribui√ß√µes espec√≠ficas
                    if (agentPermissions.canAssignAgents) {
                        const matches = agente.atribuido_para_usuario || agente.usuario_id === userId
                        console.log(`üîç ${agente.nome}: Verificando atribui√ß√£o - atribuido_para_usuario=${agente.atribuido_para_usuario}, usuario_id=${agente.usuario_id}, userId=${userId} = ${matches}`)
                        return matches
                    }
                    
                    // Se n√£o tem permiss√£o espec√≠fica, n√£o mostrar nenhum
                    console.log(`‚ùå ${agente.nome}: Sem permiss√£o espec√≠fica`)
                    return false
                })
                
                resultDiv.innerHTML = `
                    <h3 class="info">üîç Resultado do Filtro</h3>
                    <p><strong>Usu√°rio:</strong> ${userData.name} (ID: ${userId})</p>
                    <p><strong>Permiss√µes simuladas:</strong></p>
                    <ul>
                        <li>canViewAll: ${agentPermissions.canViewAll}</li>
                        <li>canManage: ${agentPermissions.canManage}</li>
                        <li>canViewOwn: ${agentPermissions.canViewOwn}</li>
                        <li>canAssignAgents: ${agentPermissions.canAssignAgents}</li>
                    </ul>
                    <p><strong>Total de agentes:</strong> ${agentes.length}</p>
                    <p><strong>Agentes filtrados:</strong> ${agentesFiltrados.length}</p>
                    
                    <h4>Agentes dispon√≠veis:</h4>
                    <ul>
                        ${agentes.map(agente => `
                            <li>
                                <strong>${agente.nome}</strong> (ID: ${agente.id})
                                <br>Usu√°rio ID: ${agente.usuario_id}
                                <br>Status: ${agente.usuario_id === userId ? '‚úÖ Seu agente' : '‚ùå De outro usu√°rio'}
                            </li>
                        `).join('')}
                    </ul>
                    
                    <h4>Agentes que o supervisor deve ver:</h4>
                    <ul>
                        ${agentesFiltrados.map(agente => `
                            <li>
                                <strong>${agente.nome}</strong> (ID: ${agente.id})
                                <br>Usu√°rio ID: ${agente.usuario_id}
                            </li>
                        `).join('')}
                    </ul>
                `
                
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">‚ùå Erro: ${error.message}</p>`
            }
        }

        function compararAplicacao() {
            const resultDiv = document.getElementById('comparacao')
            
            resultDiv.innerHTML = `
                <h3 class="info">üîç Compara√ß√£o com Aplica√ß√£o Real</h3>
                <p><strong>Teste:</strong> Supervisor (ID: 6) deve ver apenas Jo√£o (usuario_id: 6)</p>
                <p><strong>Aplica√ß√£o real:</strong> Verificar se est√° mostrando apenas Jo√£o ou todos os agentes</p>
                
                <h4>Poss√≠veis causas da discrep√¢ncia:</h4>
                <ol>
                    <li><strong>Permiss√µes incorretas:</strong> Supervisor pode ter permiss√£o canViewAll ou canManage</li>
                    <li><strong>L√≥gica de filtro incorreta:</strong> Pode estar usando l√≥gica diferente</li>
                    <li><strong>Dados de permiss√£o incorretos:</strong> Banco pode ter permiss√µes diferentes</li>
                    <li><strong>Cache de permiss√µes:</strong> Pode estar usando dados em cache</li>
                </ol>
                
                <h4>Pr√≥ximos passos:</h4>
                <ol>
                    <li>Verificar permiss√µes reais do supervisor no banco</li>
                    <li>Verificar logs da aplica√ß√£o real</li>
                    <li>Comparar com o que est√° sendo mostrado na tela</li>
                </ol>
            `
        }

        // Auto-executar
        window.onload = function() {
            simularLoginSupervisor()
        }
    </script>
</body>
</html>
