<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Testar Regra do Administrador</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #1a1a1a; color: #fff; }
        .container { max-width: 1000px; margin: 0 auto; }
        .section { background: #2a2a2a; padding: 20px; margin: 10px 0; border-radius: 8px; }
        .success { color: #4ade80; }
        .error { color: #f87171; }
        .warning { color: #fbbf24; }
        .info { color: #60a5fa; }
        button { background: #3b82f6; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #2563eb; }
        pre { background: #1e1e1e; padding: 15px; border-radius: 5px; overflow-x: auto; }
        .agent-card { background: #1e1e1e; padding: 15px; margin: 10px 0; border-radius: 5px; border-left: 4px solid #3b82f6; }
        .agent-visible { border-left-color: #4ade80; }
        .agent-hidden { border-left-color: #f87171; }
        .admin-rule { background: #1e3a8a; padding: 15px; margin: 10px 0; border-radius: 5px; border-left: 4px solid #60a5fa; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üëë Testar Regra do Administrador</h1>
        
        <div class="admin-rule">
            <h2>üìã REGRA PRINCIPAL</h2>
            <p><strong>Administrador deve ver TODOS os agentes, independente de quem criou ou atribuiu.</strong></p>
            <p class="info">Esta √© uma regra de neg√≥cio que n√£o pode ser quebrada.</p>
        </div>

        <div class="section">
            <h2>1. Simular Dados dos Agentes</h2>
            <button onclick="simularDados()">Simular Dados</button>
            <div id="dados"></div>
        </div>

        <div class="section">
            <h2>2. Testar Filtro para Cada Usu√°rio</h2>
            <button onclick="testarFiltro()">Testar Filtro</button>
            <div id="filtro"></div>
        </div>

        <div class="section">
            <h2>3. Verificar Regra do Admin</h2>
            <div id="verificacao"></div>
        </div>
    </div>

    <script>
        let agentes = []
        let atribuicoes = []

        function simularDados() {
            const resultDiv = document.getElementById('dados')
            
            // Dados dos agentes (baseado na imagem)
            agentes = [
                {
                    id: 68,
                    nome: "Joana",
                    usuario_id: 5, // Admin
                    ativo: true,
                    descricao: "joana"
                },
                {
                    id: 65,
                    nome: "Jo√£o", 
                    usuario_id: 6, // Usu√°rio Padr√£o
                    ativo: true,
                    descricao: "Agente automatizado"
                },
                {
                    id: 74,
                    nome: "Zeca",
                    usuario_id: 5, // Admin
                    ativo: true,
                    descricao: "teste de agente"
                }
            ]

            // Dados das atribui√ß√µes (baseado na imagem - Zeca tem 1 usu√°rio atribu√≠do)
            atribuicoes = [
                {
                    agente_id: 74, // Zeca
                    usuario_id: 6, // Usu√°rio Padr√£o
                    nome_usuario: "Usu√°rio Elleve Padr√£o",
                    email: "rmacedo2005@hotmail.com"
                }
            ]

            resultDiv.innerHTML = `
                <h3 class="info">üìä Dados Simulados</h3>
                <h4>Agentes:</h4>
                ${agentes.map(agente => `
                    <div class="agent-card">
                        <strong>${agente.nome}</strong> (ID: ${agente.id})
                        <br>Criado por: Usu√°rio ID ${agente.usuario_id}
                        <br>Status: ${agente.ativo ? 'Ativo' : 'Inativo'}
                    </div>
                `).join('')}
                
                <h4>Atribui√ß√µes:</h4>
                ${atribuicoes.map(atrib => `
                    <div class="agent-card">
                        <strong>Agente ID ${atrib.agente_id}</strong> ‚Üí <strong>Usu√°rio ID ${atrib.usuario_id}</strong>
                        <br>Nome: ${atrib.nome_usuario}
                        <br>Email: ${atrib.email}
                    </div>
                `).join('')}
            `
        }

        function testarFiltro() {
            const resultDiv = document.getElementById('filtro')
            
            const usuarios = [
                { id: 5, nome: 'Administrator Code-IQ', perfil: 'Admin', isAdmin: true },
                { id: 6, nome: 'Usu√°rio Elleve Padr√£o', perfil: 'Usu√°rio Padr√£o', isAdmin: false },
                { id: 37, nome: 'Supervisor Elleve Cons√≥rcios', perfil: 'Supervisor', isAdmin: false }
            ]

            let resultado = '<h3 class="info">üîç Teste de Filtro por Usu√°rio</h3>'
            
            usuarios.forEach(usuario => {
                const agentesVisiveis = agentes.filter(agente => {
                    // REGRA PRINCIPAL: Se √© admin, sempre mostrar todos
                    if (usuario.isAdmin) {
                        return true
                    }
                    
                    // Para usu√°rios n√£o-admin: verificar se o agente pertence a eles
                    const criadoPeloUsuario = agente.usuario_id === usuario.id
                    const atribuidoParaUsuario = atribuicoes.some(atrib => 
                        atrib.agente_id === agente.id && atrib.usuario_id === usuario.id
                    )
                    
                    return criadoPeloUsuario || atribuidoParaUsuario
                })

                resultado += `
                    <div style="margin: 20px 0; padding: 20px; background: #1e1e1e; border-radius: 8px; border-left: 4px solid ${usuario.isAdmin ? '#60a5fa' : '#3b82f6'};">
                        <h4>${usuario.nome} (ID: ${usuario.id}) - ${usuario.perfil}</h4>
                        <p><strong>√â administrador:</strong> ${usuario.isAdmin ? 'Sim' : 'N√£o'}</p>
                        <p><strong>Agentes vis√≠veis:</strong> ${agentesVisiveis.length}</p>
                        
                        ${agentesVisiveis.length > 0 ? `
                            <ul>
                                ${agentesVisiveis.map(agente => {
                                    let motivo = ''
                                    if (usuario.isAdmin) {
                                        motivo = 'ADMIN - v√™ todos'
                                    } else {
                                        const criadoPeloUsuario = agente.usuario_id === usuario.id
                                        const atribuidoParaUsuario = atribuicoes.some(atrib => 
                                            atrib.agente_id === agente.id && atrib.usuario_id === usuario.id
                                        )
                                        
                                        if (criadoPeloUsuario && atribuidoParaUsuario) {
                                            motivo = 'Criado pelo usu√°rio + Atribu√≠do para o usu√°rio'
                                        } else if (criadoPeloUsuario) {
                                            motivo = 'Criado pelo usu√°rio'
                                        } else if (atribuidoParaUsuario) {
                                            motivo = 'Atribu√≠do para o usu√°rio'
                                        }
                                    }
                                    
                                    return `
                                        <li>
                                            <strong>${agente.nome}</strong> (ID: ${agente.id})
                                            <br><span class="info">Motivo: ${motivo}</span>
                                        </li>
                                    `
                                }).join('')}
                            </ul>
                        ` : '<p class="warning">Nenhum agente vis√≠vel</p>'}
                        
                        <p class="${agentesVisiveis.length > 0 ? 'success' : 'warning'}">
                            ${agentesVisiveis.length > 0 ? '‚úÖ Tem agentes para ver' : '‚ö†Ô∏è N√£o tem agentes para ver'}
                        </p>
                    </div>
                `
            })

            resultDiv.innerHTML = resultado
        }

        function verificarEsperado() {
            const resultDiv = document.getElementById('verificacao')
            
            resultDiv.innerHTML = `
                <h3 class="info">üìã Verifica√ß√£o da Regra do Admin</h3>
                
                <div class="admin-rule">
                    <h4>‚úÖ Administrador (ID: 5)</h4>
                    <p><strong>Deve ver:</strong> TODOS os agentes (Joana, Jo√£o, Zeca)</p>
                    <p><strong>Motivo:</strong> REGRA PRINCIPAL - Admin v√™ todos</p>
                    <p class="success">‚úÖ Esta regra N√ÉO pode ser quebrada</p>
                </div>
                
                <div class="agent-card">
                    <h4>Usu√°rio Padr√£o (ID: 6)</h4>
                    <p><strong>Deve ver:</strong> Zeca (atribu√≠do para ele)</p>
                    <p><strong>N√£o deve ver:</strong> Joana (criado pelo admin), Jo√£o (criado por ele, mas sem atribui√ß√£o)</p>
                    <p class="info">Motivo: Apenas agentes atribu√≠dos para ele</p>
                </div>
                
                <div class="agent-card">
                    <h4>Supervisor (ID: 37)</h4>
                    <p><strong>Deve ver:</strong> Nenhum</p>
                    <p class="info">Motivo: N√£o tem agentes pr√≥prios nem atribui√ß√µes</p>
                </div>
                
                <h4>Resumo da L√≥gica:</h4>
                <ol>
                    <li><strong>Se √© admin:</strong> Mostrar TODOS os agentes</li>
                    <li><strong>Se n√£o √© admin:</strong> Mostrar apenas agentes criados por ele OU atribu√≠dos para ele</li>
                </ol>
            `
        }

        // Auto-executar
        window.onload = function() {
            simularDados()
            testarFiltro()
            verificarEsperado()
        }
    </script>
</body>
</html>
