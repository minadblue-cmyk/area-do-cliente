<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Webhook Agentes</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #1a1a1a; color: #fff; }
        .container { max-width: 1000px; margin: 0 auto; }
        .section { background: #2a2a2a; padding: 20px; margin: 10px 0; border-radius: 8px; }
        .success { color: #4ade80; }
        .error { color: #f87171; }
        .warning { color: #fbbf24; }
        .info { color: #60a5fa; }
        button { background: #3b82f6; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #2563eb; }
        pre { background: #1e1e1e; padding: 15px; border-radius: 5px; overflow-x: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Debug Webhook de Agentes</h1>
        
        <div class="section">
            <h2>1. Testar Webhook Diretamente</h2>
            <button onclick="testarWebhook()">Testar Webhook</button>
            <div id="webhook"></div>
        </div>

        <div class="section">
            <h2>2. Verificar Estrutura da Resposta</h2>
            <button onclick="verificarEstrutura()">Verificar Estrutura</button>
            <div id="estrutura"></div>
        </div>

        <div class="section">
            <h2>3. Testar Diferentes URLs</h2>
            <button onclick="testarUrls()">Testar URLs</button>
            <div id="urls"></div>
        </div>

        <div class="section">
            <h2>4. Simular Dados de Agentes</h2>
            <button onclick="simularDados()">Simular Dados</button>
            <div id="simulacao"></div>
        </div>
    </div>

    <script>
        async function testarWebhook() {
            const resultDiv = document.getElementById('webhook')
            resultDiv.innerHTML = '<p class="info">üîÑ Testando webhook...</p>'
            
            try {
                const response = await fetch('https://n8n.code-iq.com.br/webhook/list-agentes', {
                    method: 'GET',
                    headers: { 
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                })
                
                console.log('Response status:', response.status)
                console.log('Response headers:', response.headers)
                
                const text = await response.text()
                console.log('Raw response:', text)
                
                let data
                try {
                    data = JSON.parse(text)
                } catch (e) {
                    resultDiv.innerHTML = `
                        <h3 class="error">‚ùå Erro ao parsear JSON</h3>
                        <p>Resposta n√£o √© JSON v√°lido:</p>
                        <pre>${text}</pre>
                    `
                    return
                }
                
                resultDiv.innerHTML = `
                    <h3 class="info">üìä Resposta do Webhook</h3>
                    <p><strong>Status:</strong> ${response.status}</p>
                    <p><strong>Status Text:</strong> ${response.statusText}</p>
                    <p><strong>Tipo da resposta:</strong> ${typeof data}</p>
                    <p><strong>√â array:</strong> ${Array.isArray(data)}</p>
                    <p><strong>Comprimento:</strong> ${Array.isArray(data) ? data.length : 'N/A'}</p>
                    
                    <h4>Resposta completa:</h4>
                    <pre>${JSON.stringify(data, null, 2)}</pre>
                `
                
            } catch (error) {
                resultDiv.innerHTML = `
                    <h3 class="error">‚ùå Erro na requisi√ß√£o</h3>
                    <p>${error.message}</p>
                `
            }
        }

        async function verificarEstrutura() {
            const resultDiv = document.getElementById('estrutura')
            resultDiv.innerHTML = '<p class="info">üîÑ Verificando estrutura...</p>'
            
            try {
                const response = await fetch('https://n8n.code-iq.com.br/webhook/list-agentes', {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' }
                })
                
                const data = await response.json()
                
                let agentes = []
                let estrutura = 'Desconhecida'
                
                if (Array.isArray(data)) {
                    if (data.length > 0 && data[0].data && Array.isArray(data[0].data)) {
                        agentes = data[0].data
                        estrutura = 'Array com objeto contendo propriedade data (array)'
                    } else if (data.length > 0 && Array.isArray(data[0])) {
                        agentes = data[0]
                        estrutura = 'Array com array interno'
                    } else {
                        agentes = data
                        estrutura = 'Array direto'
                    }
                } else if (data.data && Array.isArray(data.data)) {
                    agentes = data.data
                    estrutura = 'Objeto com propriedade data (array)'
                } else if (data.agentes && Array.isArray(data.agentes)) {
                    agentes = data.agentes
                    estrutura = 'Objeto com propriedade agentes (array)'
                }
                
                resultDiv.innerHTML = `
                    <h3 class="info">üîç An√°lise da Estrutura</h3>
                    <p><strong>Estrutura identificada:</strong> ${estrutura}</p>
                    <p><strong>Agentes encontrados:</strong> ${agentes.length}</p>
                    
                    ${agentes.length > 0 ? `
                        <h4>Primeiro agente:</h4>
                        <pre>${JSON.stringify(agentes[0], null, 2)}</pre>
                    ` : '<p class="warning">‚ö†Ô∏è Nenhum agente encontrado</p>'}
                    
                    <h4>Estrutura completa da resposta:</h4>
                    <pre>${JSON.stringify(data, null, 2)}</pre>
                `
                
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">‚ùå Erro: ${error.message}</p>`
            }
        }

        async function testarUrls() {
            const resultDiv = document.getElementById('urls')
            resultDiv.innerHTML = '<p class="info">üîÑ Testando diferentes URLs...</p>'
            
            const urls = [
                'https://n8n.code-iq.com.br/webhook/list-agentes',
                'https://n8n.code-iq.com.br/webhook/list-agentes/',
                'https://n8n.code-iq.com.br/webhook/list-agentes?method=GET'
            ]
            
            let resultados = []
            
            for (const url of urls) {
                try {
                    const response = await fetch(url, {
                        method: 'GET',
                        headers: { 'Accept': 'application/json' }
                    })
                    
                    const data = await response.json()
                    const agentes = data[0]?.data || data.data || data.agentes || data
                    
                    resultados.push({
                        url,
                        status: response.status,
                        agentes: Array.isArray(agentes) ? agentes.length : 0,
                        sucesso: response.ok
                    })
                    
                } catch (error) {
                    resultados.push({
                        url,
                        status: 'Erro',
                        agentes: 0,
                        sucesso: false,
                        erro: error.message
                    })
                }
            }
            
            resultDiv.innerHTML = `
                <h3 class="info">üåê Resultados das URLs</h3>
                <table style="width: 100%; border-collapse: collapse;">
                    <tr style="background: #1e1e1e;">
                        <th style="padding: 10px; border: 1px solid #444;">URL</th>
                        <th style="padding: 10px; border: 1px solid #444;">Status</th>
                        <th style="padding: 10px; border: 1px solid #444;">Agentes</th>
                        <th style="padding: 10px; border: 1px solid #444;">Sucesso</th>
                    </tr>
                    ${resultados.map(r => `
                        <tr>
                            <td style="padding: 10px; border: 1px solid #444; font-size: 12px;">${r.url}</td>
                            <td style="padding: 10px; border: 1px solid #444;">${r.status}</td>
                            <td style="padding: 10px; border: 1px solid #444;">${r.agentes}</td>
                            <td style="padding: 10px; border: 1px solid #444; color: ${r.sucesso ? '#4ade80' : '#f87171'}">${r.sucesso ? '‚úÖ' : '‚ùå'}</td>
                        </tr>
                    `).join('')}
                </table>
            `
        }

        function simularDados() {
            const resultDiv = document.getElementById('simulacao')
            
            // Dados simulados baseados no que vimos anteriormente
            const agentesSimulados = [
                {
                    id: 68,
                    nome: 'Joana',
                    workflow_id: 'workflow-joana',
                    webhook_url: 'https://n8n.code-iq.com.br/webhook/joana',
                    descricao: 'Agente de prospec√ß√£o Joana',
                    icone: 'üéØ',
                    cor: 'bg-yellow-500',
                    ativo: true,
                    usuario_id: 5,
                    status_atual: 'parado',
                    execution_id_ativo: null
                },
                {
                    id: 65,
                    nome: 'Jo√£o',
                    workflow_id: 'workflow-joao',
                    webhook_url: 'https://n8n.code-iq.com.br/webhook/joao',
                    descricao: 'Agente automatizado',
                    icone: 'ü§ñ',
                    cor: 'bg-pink-500',
                    ativo: true,
                    usuario_id: 6,
                    status_atual: 'parado',
                    execution_id_ativo: null
                },
                {
                    id: 70,
                    nome: 'Zeca',
                    workflow_id: 'workflow-zeca',
                    webhook_url: 'https://n8n.code-iq.com.br/webhook/zeca',
                    descricao: 'teste de agente',
                    icone: 'ü§ñ',
                    cor: 'bg-lime-500',
                    ativo: true,
                    usuario_id: 5,
                    status_atual: 'parado',
                    execution_id_ativo: null
                }
            ]
            
            resultDiv.innerHTML = `
                <h3 class="info">üß™ Dados Simulados</h3>
                <p><strong>Total de agentes simulados:</strong> ${agentesSimulados.length}</p>
                
                <h4>Agentes por usu√°rio:</h4>
                <ul>
                    <li><strong>Usu√°rio ID 5:</strong> ${agentesSimulados.filter(a => a.usuario_id === 5).map(a => a.nome).join(', ')}</li>
                    <li><strong>Usu√°rio ID 6:</strong> ${agentesSimulados.filter(a => a.usuario_id === 6).map(a => a.nome).join(', ')}</li>
                </ul>
                
                <h4>Dados completos:</h4>
                <pre>${JSON.stringify(agentesSimulados, null, 2)}</pre>
                
                <h4>Teste de filtragem:</h4>
                <p><strong>Usu√°rio ID 5 deve ver:</strong> ${agentesSimulados.filter(a => a.usuario_id === 5).map(a => a.nome).join(', ')}</p>
                <p><strong>Usu√°rio ID 6 deve ver:</strong> ${agentesSimulados.filter(a => a.usuario_id === 6).map(a => a.nome).join(', ')}</p>
            `
        }

        // Auto-executar
        window.onload = function() {
            testarWebhook()
        }
    </script>
</body>
</html>
