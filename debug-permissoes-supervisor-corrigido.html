<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Permiss√µes Supervisor - Corrigido</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #1a1a1a; color: #fff; }
        .container { max-width: 1000px; margin: 0 auto; }
        .section { background: #2a2a2a; padding: 20px; margin: 10px 0; border-radius: 8px; }
        .success { color: #4ade80; }
        .error { color: #f87171; }
        .warning { color: #fbbf24; }
        .info { color: #60a5fa; }
        button { background: #3b82f6; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #2563eb; }
        pre { background: #1e1e1e; padding: 15px; border-radius: 5px; overflow-x: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Debug Permiss√µes Supervisor - Corrigido</h1>
        
        <div class="section">
            <h2>1. Verificar Permiss√µes via Webhook Correto</h2>
            <button onclick="verificarPermissoes()">Verificar Permiss√µes</button>
            <div id="permissoes"></div>
        </div>

        <div class="section">
            <h2>2. Verificar Perfil via Webhook Correto</h2>
            <button onclick="verificarPerfil()">Verificar Perfil</button>
            <div id="perfil"></div>
        </div>

        <div class="section">
            <h2>3. Simular Login e Testar Filtro</h2>
            <button onclick="testarFiltroCompleto()">Testar Filtro Completo</button>
            <div id="filtro"></div>
        </div>

        <div class="section">
            <h2>4. Comparar com Aplica√ß√£o Real</h2>
            <button onclick="compararAplicacao()">Comparar com Aplica√ß√£o</button>
            <div id="comparacao"></div>
        </div>
    </div>

    <script>
        async function verificarPermissoes() {
            const resultDiv = document.getElementById('permissoes')
            resultDiv.innerHTML = '<p class="info">üîÑ Verificando permiss√µes...</p>'
            
            try {
                // Usar webhook que sabemos que funciona
                const response = await fetch('https://n8n-lavo-n8n.15gxno.easypanel.host/webhook/list-permission', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ perfil_id: 42 })
                })
                
                console.log('Response status:', response.status)
                console.log('Response headers:', response.headers)
                
                const data = await response.json()
                console.log('Permiss√µes response:', data)
                
                const permissoes = data.data || []
                
                resultDiv.innerHTML = `
                    <h3 class="info">üîë Permiss√µes do Supervisor (Perfil ID: 42)</h3>
                    <p><strong>Status:</strong> ${response.status}</p>
                    <p><strong>Total de permiss√µes:</strong> ${permissoes.length}</p>
                    
                    <h4>Permiss√µes encontradas:</h4>
                    <ul>
                        ${permissoes.map(p => `
                            <li>
                                <strong>${p.nome_permissao}</strong> (ID: ${p.id})
                                <br>Descri√ß√£o: ${p.descricao || 'N/A'}
                            </li>
                        `).join('')}
                    </ul>
                    
                    <h4>Permiss√µes espec√≠ficas de agentes:</h4>
                    <ul>
                        <li><strong>visualizar_status_do_agente:</strong> ${permissoes.some(p => p.nome_permissao === 'visualizar_status_do_agente') ? '‚úÖ' : '‚ùå'}</li>
                        <li><strong>iniciar_agente:</strong> ${permissoes.some(p => p.nome_permissao === 'iniciar_agente') ? '‚úÖ' : '‚ùå'}</li>
                        <li><strong>parar_agente:</strong> ${permissoes.some(p => p.nome_permissao === 'parar_agente') ? '‚úÖ' : '‚ùå'}</li>
                        <li><strong>atribuir_agentes_usuarios:</strong> ${permissoes.some(p => p.nome_permissao === 'atribuir_agentes_usuarios') ? '‚úÖ' : '‚ùå'}</li>
                        <li><strong>administrar_agente_de_outros_usu√°rios:</strong> ${permissoes.some(p => p.nome_permissao === 'administrar_agente_de_outros_usu√°rios') ? '‚úÖ' : '‚ùå'}</li>
                    </ul>
                    
                    <h4>Resposta completa:</h4>
                    <pre>${JSON.stringify(data, null, 2)}</pre>
                `
                
            } catch (error) {
                console.error('Erro ao buscar permiss√µes:', error)
                resultDiv.innerHTML = `
                    <h3 class="error">‚ùå Erro ao buscar permiss√µes</h3>
                    <p><strong>Erro:</strong> ${error.message}</p>
                    <p><strong>Tipo:</strong> ${error.name}</p>
                    <p><strong>Stack:</strong></p>
                    <pre>${error.stack}</pre>
                `
            }
        }

        async function verificarPerfil() {
            const resultDiv = document.getElementById('perfil')
            resultDiv.innerHTML = '<p class="info">üîÑ Verificando perfil...</p>'
            
            try {
                const response = await fetch('https://n8n-lavo-n8n.15gxno.easypanel.host/webhook/list-profile', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ perfil_id: 42 })
                })
                
                const data = await response.json()
                console.log('Perfil response:', data)
                
                resultDiv.innerHTML = `
                    <h3 class="info">üë§ Perfil 42</h3>
                    <p><strong>Status:</strong> ${response.status}</p>
                    <p><strong>Resposta:</strong></p>
                    <pre>${JSON.stringify(data, null, 2)}</pre>
                `
                
            } catch (error) {
                console.error('Erro ao buscar perfil:', error)
                resultDiv.innerHTML = `<p class="error">‚ùå Erro: ${error.message}</p>`
            }
        }

        async function testarFiltroCompleto() {
            const resultDiv = document.getElementById('filtro')
            resultDiv.innerHTML = '<p class="info">üîÑ Testando filtro completo...</p>'
            
            try {
                // 1. Simular login do supervisor
                const userData = {
                    id: "6",
                    name: "Supervisor Elleve Cons√≥rcios",
                    email: "supervisor@teste.com",
                    perfil_id: 42,
                    perfil: "Supervisor Elleve Cons√≥rcios",
                    permissions: []
                }
                
                localStorage.setItem('userData', JSON.stringify(userData))
                
                // 2. Buscar permiss√µes
                const responsePermissoes = await fetch('https://n8n-lavo-n8n.15gxno.easypanel.host/webhook/list-permission', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ perfil_id: 42 })
                })
                
                const dataPermissoes = await responsePermissoes.json()
                const permissoes = dataPermissoes.data || []
                
                // 3. Simular l√≥gica de permiss√µes
                const hasVisualizarStatus = permissoes.some(p => p.nome_permissao === 'visualizar_status_do_agente')
                const hasIniciarAgente = permissoes.some(p => p.nome_permissao === 'iniciar_agente')
                const hasPararAgente = permissoes.some(p => p.nome_permissao === 'parar_agente')
                const hasAdministrarOutros = permissoes.some(p => p.nome_permissao === 'administrar_agente_de_outros_usu√°rios')
                const hasAtribuirAgentes = permissoes.some(p => p.nome_permissao === 'atribuir_agentes_usuarios')
                
                const agentPermissions = {
                    canView: hasVisualizarStatus,
                    canExecute: hasIniciarAgente || hasPararAgente,
                    canManage: hasAdministrarOutros,
                    canViewAll: hasAdministrarOutros,
                    canViewOwn: hasIniciarAgente || hasPararAgente,
                    canAssignAgents: hasAtribuirAgentes
                }
                
                // 4. Buscar agentes
                const responseAgentes = await fetch('https://n8n.code-iq.com.br/webhook/list-agentes', {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' }
                })
                
                const dataAgentes = await responseAgentes.json()
                const agentes = dataAgentes.data || []
                
                // 5. Aplicar filtro
                const userId = parseInt(userData.id)
                const agentesFiltrados = agentes.filter(agente => {
                    console.log(`üîç Filtrando agente: ${agente.nome} (usuario_id: ${agente.usuario_id})`)
                    
                    // Se pode ver todos os agentes, mostrar todos
                    if (agentPermissions.canViewAll || agentPermissions.canManage) {
                        console.log(`‚úÖ ${agente.nome}: Mostrando (canViewAll/canManage)`)
                        return true
                    }
                    
                    // Se pode ver apenas seus pr√≥prios agentes, filtrar por user_id
                    if (agentPermissions.canViewOwn) {
                        const matches = agente.usuario_id === userId
                        console.log(`üîç ${agente.nome}: Comparando ${agente.usuario_id} === ${userId} = ${matches}`)
                        return matches
                    }
                    
                    // Se tem permiss√£o de atribui√ß√£o, verificar atribui√ß√µes espec√≠ficas
                    if (agentPermissions.canAssignAgents) {
                        const matches = agente.atribuido_para_usuario || agente.usuario_id === userId
                        console.log(`üîç ${agente.nome}: Verificando atribui√ß√£o - atribuido_para_usuario=${agente.atribuido_para_usuario}, usuario_id=${agente.usuario_id}, userId=${userId} = ${matches}`)
                        return matches
                    }
                    
                    // Se n√£o tem permiss√£o espec√≠fica, n√£o mostrar nenhum
                    console.log(`‚ùå ${agente.nome}: Sem permiss√£o espec√≠fica`)
                    return false
                })
                
                resultDiv.innerHTML = `
                    <h3 class="info">üîç Resultado do Filtro Completo</h3>
                    <p><strong>Usu√°rio:</strong> ${userData.name} (ID: ${userId}, Perfil: ${userData.perfil_id})</p>
                    
                    <h4>Permiss√µes encontradas:</h4>
                    <ul>
                        <li>visualizar_status_do_agente: ${hasVisualizarStatus ? '‚úÖ' : '‚ùå'}</li>
                        <li>iniciar_agente: ${hasIniciarAgente ? '‚úÖ' : '‚ùå'}</li>
                        <li>parar_agente: ${hasPararAgente ? '‚úÖ' : '‚ùå'}</li>
                        <li>administrar_agente_de_outros_usu√°rios: ${hasAdministrarOutros ? '‚úÖ' : '‚ùå'}</li>
                        <li>atribuir_agentes_usuarios: ${hasAtribuirAgentes ? '‚úÖ' : '‚ùå'}</li>
                    </ul>
                    
                    <h4>Permiss√µes calculadas:</h4>
                    <ul>
                        <li>canView: ${agentPermissions.canView}</li>
                        <li>canExecute: ${agentPermissions.canExecute}</li>
                        <li>canManage: ${agentPermissions.canManage}</li>
                        <li>canViewAll: ${agentPermissions.canViewAll}</li>
                        <li>canViewOwn: ${agentPermissions.canViewOwn}</li>
                        <li>canAssignAgents: ${agentPermissions.canAssignAgents}</li>
                    </ul>
                    
                    <p><strong>Total de agentes:</strong> ${agentes.length}</p>
                    <p><strong>Agentes filtrados:</strong> ${agentesFiltrados.length}</p>
                    
                    <h4>Agentes dispon√≠veis:</h4>
                    <ul>
                        ${agentes.map(agente => `
                            <li>
                                <strong>${agente.nome}</strong> (ID: ${agente.id})
                                <br>Usu√°rio ID: ${agente.usuario_id}
                                <br>Status: ${agente.usuario_id === userId ? '‚úÖ Seu agente' : '‚ùå De outro usu√°rio'}
                            </li>
                        `).join('')}
                    </ul>
                    
                    <h4>Agentes que o supervisor deve ver:</h4>
                    <ul>
                        ${agentesFiltrados.map(agente => `
                            <li>
                                <strong>${agente.nome}</strong> (ID: ${agente.id})
                                <br>Usu√°rio ID: ${agente.usuario_id}
                            </li>
                        `).join('')}
                    </ul>
                    
                    <h4>Conclus√£o:</h4>
                    <p class="${agentesFiltrados.length === 1 ? 'success' : 'error'}">
                        ${agentesFiltrados.length === 1 ? '‚úÖ CORRETO: Supervisor v√™ apenas 1 agente (Jo√£o)' : '‚ùå INCORRETO: Supervisor est√° vendo ' + agentesFiltrados.length + ' agentes'}
                    </p>
                `
                
            } catch (error) {
                console.error('Erro no teste completo:', error)
                resultDiv.innerHTML = `<p class="error">‚ùå Erro: ${error.message}</p>`
            }
        }

        function compararAplicacao() {
            const resultDiv = document.getElementById('comparacao')
            
            resultDiv.innerHTML = `
                <h3 class="info">üîç Compara√ß√£o com Aplica√ß√£o Real</h3>
                
                <h4>Se o teste mostra que o supervisor deve ver apenas Jo√£o:</h4>
                <ul>
                    <li>‚úÖ <strong>Teste est√° correto</strong> - Supervisor tem apenas permiss√£o canViewOwn</li>
                    <li>‚ùå <strong>Aplica√ß√£o real est√° incorreta</strong> - Est√° mostrando todos os agentes</li>
                </ul>
                
                <h4>Se o teste mostra que o supervisor v√™ todos os agentes:</h4>
                <ul>
                    <li>‚ùå <strong>Teste est√° incorreto</strong> - Supervisor n√£o deveria ter permiss√£o canViewAll</li>
                    <li>‚úÖ <strong>Aplica√ß√£o real est√° correta</strong> - Est√° seguindo as permiss√µes do banco</li>
                </ul>
                
                <h4>Pr√≥ximos passos:</h4>
                <ol>
                    <li>Execute o teste completo acima</li>
                    <li>Compare com o que est√° sendo mostrado na aplica√ß√£o real</li>
                    <li>Se houver discrep√¢ncia, verificar se h√° cache ou l√≥gica diferente</li>
                </ol>
            `
        }

        // Auto-executar
        window.onload = function() {
            verificarPermissoes()
            verificarPerfil()
        }
    </script>
</body>
</html>
