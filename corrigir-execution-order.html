<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Corrigir Execution Order</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #1a1a1a; color: #fff; }
        .container { max-width: 1200px; margin: 0 auto; }
        .section { background: #2a2a2a; padding: 20px; margin: 10px 0; border-radius: 8px; }
        .success { color: #4ade80; }
        .error { color: #f87171; }
        .warning { color: #fbbf24; }
        .info { color: #60a5fa; }
        button { background: #3b82f6; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #2563eb; }
        pre { background: #1e1e1e; padding: 15px; border-radius: 5px; overflow-x: auto; }
        .code-block { background: #1e1e1e; padding: 15px; border-radius: 5px; margin: 10px 0; }
        .step { background: #333; padding: 15px; margin: 10px 0; border-radius: 5px; border-left: 4px solid #4ade80; }
        .node { background: #444; padding: 15px; margin: 10px 0; border-radius: 5px; border-left: 4px solid #3b82f6; }
    </style>
</head>
<body>
    <div class="container">
        <h1>‚ö° Corrigir Execution Order para v1</h1>
        
        <div class="section">
            <h2>üéØ N√≥s que Precisam ser Atualizados</h2>
            
            <div class="node">
                <h3>üìã N√≥: "PREPARAR WORKFLOW CLONADO - Start"</h3>
                <p class="info">Localiza√ß√£o: Ap√≥s "Busca atual"</p>
                <p class="warning">‚ö†Ô∏è Este n√≥ clona o workflow de Start</p>
            </div>

            <div class="node">
                <h3>üìã N√≥: "PREPARAR WORKFLOW CLONADO - Status"</h3>
                <p class="info">Localiza√ß√£o: Ap√≥s "Busca atual1"</p>
                <p class="warning">‚ö†Ô∏è Este n√≥ clona o workflow de Status</p>
            </div>

            <div class="node">
                <h3>üìã N√≥: "PREPARAR WORKFLOW CLONADO - Lista-Prospec√ß√£o"</h3>
                <p class="info">Localiza√ß√£o: Ap√≥s "Busca atual2"</p>
                <p class="warning">‚ö†Ô∏è Este n√≥ clona o workflow de Lista</p>
            </div>

            <div class="node">
                <h3>üìã N√≥: "PREPARAR WORKFLOW CLONADO - Stop"</h3>
                <p class="info">Localiza√ß√£o: Ap√≥s "Busca atual3"</p>
                <p class="warning">‚ö†Ô∏è Este n√≥ clona o workflow de Stop</p>
            </div>
        </div>

        <div class="section">
            <h2>üîß C√≥digo Atualizado para Todos os N√≥s</h2>
            
            <div class="step">
                <h3>‚úÖ C√≥digo Corrigido (Substitua em TODOS os 4 n√≥s)</h3>
                <div class="code-block">
                    <pre>// Fun√ß√£o para normalizar nome preservando acentos
function normalizarNomeParaWebhook(nome) {
  return nome
    .toLowerCase()
    .trim()
    .replace(/\s+/g, '') // Remove espa√ßos
    .replace(/[^a-z0-9√°√†√¢√£√©√®√™√≠√¨√Æ√≥√≤√¥√µ√∫√π√ª√ß]/g, '') // Remove caracteres especiais exceto acentos
    .replace(/[√°√†√¢√£]/g, 'a')
    .replace(/[√©√®√™]/g, 'e')
    .replace(/[√≠√¨√Æ]/g, 'i')
    .replace(/[√≥√≤√¥√µ]/g, 'o')
    .replace(/[√∫√π√ª]/g, 'u')
    .replace(/√ß/g, 'c');
}

// Obter contador do Redis GET
const counterData = $('Busca atual').item.json; // ‚ö†Ô∏è ATEN√á√ÉO: Mude para o n√≥ correto
const counter = counterData.propertyName || counterData.agente_counter_global || 1;

// Acessar dados do n√≥ "Normaliza campos" onde est√° o originalWorkflow
const originalWorkflow = $('Normaliza campos').item.json.originalWorkflow; // ‚ö†Ô∏è ATEN√á√ÉO: Mude para o n√≥ correto
const agentData = $('Normaliza√ß√£o1').item.json;

// CORRE√á√ÉO: Normalizar agentType preservando acentos
const agentTypeNormalizado = normalizarNomeParaWebhook(agentData.agentName || agentData.agentType);

const clonedWorkflow = {
  name: \`Agente SDR - Start-\${counter}\`, // ‚ö†Ô∏è ATEN√á√ÉO: Mude o nome conforme o tipo
  settings: {
    ...originalWorkflow.settings,
    // üïê FOR√áAR TIMEZONE
    timezone: 'America/Sao_Paulo',
    // ‚ö° FOR√áAR EXECUTION ORDER V1 (CORRE√á√ÉO PRINCIPAL)
    executionOrder: 'v1'
  },
  nodes: originalWorkflow.nodes.map(node => {
    if (node.type === 'n8n-nodes-base.webhook') {
      return {
        ...node,
        parameters: {
          ...node.parameters,
          path: \`start\${counter}-\${agentTypeNormalizado}\` // ‚ö†Ô∏è ATEN√á√ÉO: Mude o prefixo conforme o tipo
        }
      };
    }
    
    // CORRE√á√ÉO: Atualizar workflow_id nos n√≥s de normaliza√ß√£o
    if (node.name === 'Normalizar Dados') {
      return {
        ...node,
        parameters: {
          ...node.parameters,
          assignments: {
            ...node.parameters.assignments,
            assignments: node.parameters.assignments.assignments.map(assignment => {
              if (assignment.id === 'workflow-id') {
                return {
                  ...assignment,
                  value: \`={{ $json.query.workflow_id || '\${agentData.agentId}' }}\`
                };
              }
              return assignment;
            })
          }
        }
      };
    }
    return node;
  }),
  connections: originalWorkflow.connections || {}
};

return { workflowData: clonedWorkflow, counter: counter, webhookType: 'start' }; // ‚ö†Ô∏è ATEN√á√ÉO: Mude o webhookType</pre>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>üìã Instru√ß√µes Espec√≠ficas por N√≥</h2>
            
            <div class="step">
                <h3>üîß N√≥ 1: "PREPARAR WORKFLOW CLONADO - Start"</h3>
                <div class="code-block">
                    <pre>// Mudan√ßas espec√≠ficas para o n√≥ Start:
const counterData = $('Busca atual').item.json;
const originalWorkflow = $('Normaliza campos').item.json.originalWorkflow;
const name = \`Agente SDR - Start-\${counter}\`;
const path = \`start\${counter}-\${agentTypeNormalizado}\`;
const webhookType = 'start';</pre>
                </div>
            </div>

            <div class="step">
                <h3>üîß N√≥ 2: "PREPARAR WORKFLOW CLONADO - Status"</h3>
                <div class="code-block">
                    <pre>// Mudan√ßas espec√≠ficas para o n√≥ Status:
const counterData = $('Busca atual1').item.json;
const originalWorkflow = $('Normaliza campos1').item.json.originalWorkflow;
const name = \`Agente SDR - Status-\${counter}\`;
const path = \`status\${counter}-\${agentTypeNormalizado}\`;
const webhookType = 'status';</pre>
                </div>
            </div>

            <div class="step">
                <h3>üîß N√≥ 3: "PREPARAR WORKFLOW CLONADO - Lista-Prospec√ß√£o"</h3>
                <div class="code-block">
                    <pre>// Mudan√ßas espec√≠ficas para o n√≥ Lista:
const counterData = $('Busca atual2').item.json;
const originalWorkflow = $('Normaliza campos2').item.json.originalWorkflow;
const name = \`Agente SDR - Lista-Prospecao-\${counter}\`;
const path = \`lista\${counter}-\${agentTypeNormalizado}\`;
const webhookType = 'lista-prospeccao';</pre>
                </div>
            </div>

            <div class="step">
                <h3>üîß N√≥ 4: "PREPARAR WORKFLOW CLONADO - Stop"</h3>
                <div class="code-block">
                    <pre>// Mudan√ßas espec√≠ficas para o n√≥ Stop:
const counterData = $('Busca atual3').item.json;
const originalWorkflow = $('Normaliza campos3').item.json.originalWorkflow;
const name = \`Agente SDR - Stop-\${counter}\`;
const path = \`stop\${counter}-\${agentTypeNormalizado}\`;
const webhookType = 'stop';</pre>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>üß™ Testar Corre√ß√£o</h2>
            <button onclick="testarExecutionOrder()">Testar Execution Order</button>
            <div id="teste-result"></div>
        </div>

        <div class="section">
            <h2>üìã Checklist de Verifica√ß√£o</h2>
            <div class="info">
                <h3>‚úÖ Ap√≥s aplicar as corre√ß√µes, verifique:</h3>
                <ul>
                    <li>‚úÖ Todos os 4 n√≥s foram atualizados</li>
                    <li>‚úÖ <code>executionOrder: 'v1'</code> est√° presente</li>
                    <li>‚úÖ <code>timezone: 'America/Sao_Paulo'</code> est√° presente</li>
                    <li>‚úÖ Nomes dos n√≥s de refer√™ncia est√£o corretos</li>
                    <li>‚úÖ Prefixos dos webhooks est√£o corretos (start, status, lista, stop)</li>
                </ul>
            </div>
        </div>

        <div class="section">
            <h2>üöÄ Pr√≥ximos Passos</h2>
            <div class="success">
                <h3>üìã Ordem de Execu√ß√£o:</h3>
                <ol>
                    <li>1Ô∏è‚É£ Atualizar o n√≥ "PREPARAR WORKFLOW CLONADO - Start"</li>
                    <li>2Ô∏è‚É£ Atualizar o n√≥ "PREPARAR WORKFLOW CLONADO - Status"</li>
                    <li>3Ô∏è‚É£ Atualizar o n√≥ "PREPARAR WORKFLOW CLONADO - Lista-Prospec√ß√£o"</li>
                    <li>4Ô∏è‚É£ Atualizar o n√≥ "PREPARAR WORKFLOW CLONADO - Stop"</li>
                    <li>5Ô∏è‚É£ Testar criando um novo agente</li>
                    <li>6Ô∏è‚É£ Verificar se o execution order est√° como v1</li>
                </ol>
            </div>
        </div>
    </div>

    <script>
        async function testarExecutionOrder() {
            const resultDiv = document.getElementById('teste-result');
            resultDiv.innerHTML = '<p class="info">üîç Testando execution order...</p>';

            try {
                const response = await fetch('https://n8n.code-iq.com.br/api/v1/workflows', {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (response.ok) {
                    const workflows = await response.json();
                    const agentWorkflows = workflows.data?.filter(w => 
                        w.name?.includes('Agente SDR') && 
                        (w.name?.includes('Start-') || w.name?.includes('Status-') || w.name?.includes('Lista-') || w.name?.includes('Stop-'))
                    ) || [];

                    let resultado = '<p class="success">‚úÖ Workflows de Agentes Encontrados:</p>';
                    
                    if (agentWorkflows.length === 0) {
                        resultado += '<p class="warning">‚ö†Ô∏è Nenhum workflow de agente encontrado. Crie um agente para testar.</p>';
                    } else {
                        agentWorkflows.forEach(workflow => {
                            const executionOrder = workflow.settings?.executionOrder || 'n√£o definido';
                            const timezone = workflow.settings?.timezone || 'n√£o definido';
                            const status = executionOrder === 'v1' ? '‚úÖ' : '‚ùå';
                            
                            resultado += `
                                <p class="info">${status} ${workflow.name}</p>
                                <p class="info">   ‚Ä¢ Execution Order: ${executionOrder}</p>
                                <p class="info">   ‚Ä¢ Timezone: ${timezone}</p>
                            `;
                        });
                    }

                    resultado += `
                        <hr>
                        <p class="info">üí° Ap√≥s aplicar as corre√ß√µes, todos os novos workflows devem ter executionOrder: 'v1'</p>
                    `;

                    resultDiv.innerHTML = resultado;
                } else {
                    resultDiv.innerHTML = `<p class="error">‚ùå Erro ao acessar workflows: ${response.status}</p>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">‚ùå Erro: ${error.message}</p>`;
            }
        }
    </script>
</body>
</html>
