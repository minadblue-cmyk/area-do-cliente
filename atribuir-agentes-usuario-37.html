<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atribuir Agentes para Usu√°rio 37</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #1a1a1a; color: #fff; }
        .container { max-width: 800px; margin: 0 auto; }
        .section { background: #2a2a2a; padding: 20px; margin: 10px 0; border-radius: 8px; }
        .success { color: #4ade80; }
        .error { color: #f87171; }
        .warning { color: #fbbf24; }
        .info { color: #60a5fa; }
        button { background: #3b82f6; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #2563eb; }
        pre { background: #1e1e1e; padding: 15px; border-radius: 5px; overflow-x: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîó Atribuir Agentes para Usu√°rio 37</h1>
        
        <div class="section">
            <h2>1. Verificar Agentes Dispon√≠veis</h2>
            <button onclick="verificarAgentes()">Verificar Agentes</button>
            <div id="agentes-result"></div>
        </div>

        <div class="section">
            <h2>2. Atribuir Agentes para Usu√°rio 37</h2>
            <button onclick="atribuirTodosAgentes()">Atribuir Todos os Agentes</button>
            <div id="atribuir-result"></div>
        </div>

        <div class="section">
            <h2>3. Verificar Atribui√ß√µes Ap√≥s A√ß√£o</h2>
            <button onclick="verificarAtribuicoes()">Verificar Atribui√ß√µes</button>
            <div id="atribuicoes-result"></div>
        </div>

        <div class="section">
            <h2>4. Testar Upload Page</h2>
            <button onclick="testarUploadPage()">Abrir Upload Page</button>
            <div id="upload-result"></div>
        </div>
    </div>

    <script>
        const N8N_CODE_IQ_URL = 'https://n8n.code-iq.com.br'
        const N8N_LAVO_URL = 'https://n8n-lavo-n8n.15gxno.easypanel.host'

        let agentesDisponiveis = []

        async function callWebhook(id, options = {}) {
            let url = ''
            
            if (id.startsWith('webhook/')) {
                url = `${N8N_CODE_IQ_URL}/${id}`
            } else if (id.startsWith('webhook-')) {
                url = `${N8N_LAVO_URL}/${id}`
            } else if (id.startsWith('http')) {
                url = id
            } else {
                throw new Error(`Webhook n√£o configurado: ${id}`)
            }

            const config = {
                method: options.method || 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json',
                },
                body: options.data ? JSON.stringify(options.data) : undefined,
            }

            console.log(`üöÄ Chamando webhook: ${url}`)
            console.log(`üì¶ Dados:`, options.data)

            const response = await fetch(url, config)
            
            if (!response.ok) {
                const errorText = await response.text()
                throw new Error(`Erro HTTP: ${response.status} ${response.statusText} - ${errorText}`)
            }

            const text = await response.text()
            if (!text) {
                return { data: null, status: response.status, statusText: response.statusText }
            }

            try {
                const data = JSON.parse(text)
                return { data, status: response.status, statusText: response.statusText }
            } catch (jsonError) {
                return { data: text, status: response.status, statusText: response.statusText }
            }
        }

        async function verificarAgentes() {
            const resultDiv = document.getElementById('agentes-result')
            resultDiv.innerHTML = '<p class="info">üîÑ Verificando agentes...</p>'
            
            try {
                const response = await callWebhook('webhook/list-agentes', {
                    method: 'GET'
                })
                
                let agentes = []
                if (Array.isArray(response.data)) {
                    agentes = response.data.map(item => item.data || item)
                } else if (response.data && response.data.data) {
                    agentes = Array.isArray(response.data.data) ? response.data.data : [response.data.data]
                }
                
                agentesDisponiveis = agentes
                
                resultDiv.innerHTML = `
                    <h3 class="success">‚úÖ Agentes Encontrados</h3>
                    <p><strong>Total de agentes:</strong> ${agentes.length}</p>
                    
                    <h4>Lista de Agentes:</h4>
                    <ul>
                        ${agentes.map(agente => `
                            <li><strong>${agente.nome}</strong> (ID: ${agente.id}) - Usuario ID: ${agente.usuario_id}</li>
                        `).join('')}
                    </ul>
                    
                    <h4>Dados Completos:</h4>
                    <pre>${JSON.stringify(agentes, null, 2)}</pre>
                `
                
            } catch (error) {
                console.error('‚ùå Erro ao verificar agentes:', error)
                resultDiv.innerHTML = `<p class="error">‚ùå Erro: ${error.message}</p>`
            }
        }

        async function atribuirTodosAgentes() {
            const resultDiv = document.getElementById('atribuir-result')
            resultDiv.innerHTML = '<p class="info">üîÑ Atribuindo agentes...</p>'
            
            if (agentesDisponiveis.length === 0) {
                resultDiv.innerHTML = '<p class="error">‚ùå Nenhum agente dispon√≠vel. Verifique os agentes primeiro.</p>'
                return
            }
            
            try {
                const resultados = []
                
                for (const agente of agentesDisponiveis) {
                    try {
                        console.log(`üîó Atribuindo agente ${agente.nome} (ID: ${agente.id}) para usu√°rio 37`)
                        
                        const response = await callWebhook('webhook/atribuir-agente-usuario', {
                            method: 'POST',
                            data: {
                                agente_id: parseInt(agente.id),
                                usuario_id: parseInt('37'),
                                atribuido_por: parseInt('28') // Admin
                            }
                        })
                        
                        resultados.push({
                            agente: agente.nome,
                            id: agente.id,
                            sucesso: response.data && response.data.success,
                            resposta: response.data
                        })
                        
                        console.log(`‚úÖ Resposta para ${agente.nome}:`, response.data)
                        
                    } catch (error) {
                        console.error(`‚ùå Erro ao atribuir ${agente.nome}:`, error)
                        resultados.push({
                            agente: agente.nome,
                            id: agente.id,
                            sucesso: false,
                            erro: error.message
                        })
                    }
                }
                
                const sucessos = resultados.filter(r => r.sucesso).length
                const falhas = resultados.filter(r => !r.sucesso).length
                
                resultDiv.innerHTML = `
                    <h3 class="${sucessos > 0 ? 'success' : 'error'}">${sucessos > 0 ? '‚úÖ' : '‚ùå'} Atribui√ß√£o Conclu√≠da</h3>
                    <p><strong>Sucessos:</strong> ${sucessos}</p>
                    <p><strong>Falhas:</strong> ${falhas}</p>
                    
                    <h4>Resultados Detalhados:</h4>
                    <ul>
                        ${resultados.map(r => `
                            <li class="${r.sucesso ? 'success' : 'error'}">
                                <strong>${r.agente}</strong> (ID: ${r.id}): 
                                ${r.sucesso ? '‚úÖ Sucesso' : `‚ùå Erro: ${r.erro || 'Resposta inesperada'}`}
                            </li>
                        `).join('')}
                    </ul>
                    
                    <h4>Respostas Completas:</h4>
                    <pre>${JSON.stringify(resultados, null, 2)}</pre>
                `
                
            } catch (error) {
                console.error('‚ùå Erro geral na atribui√ß√£o:', error)
                resultDiv.innerHTML = `<p class="error">‚ùå Erro: ${error.message}</p>`
            }
        }

        async function verificarAtribuicoes() {
            const resultDiv = document.getElementById('atribuicoes-result')
            resultDiv.innerHTML = '<p class="info">üîÑ Verificando atribui√ß√µes...</p>'
            
            try {
                const response = await callWebhook('webhook/list-agente-atribuicoes', {
                    method: 'GET'
                })
                
                let atribuicoes = []
                if (Array.isArray(response.data)) {
                    atribuicoes = response.data.map(item => item.data || item)
                } else if (response.data && response.data.data) {
                    atribuicoes = Array.isArray(response.data.data) ? response.data.data : [response.data.data]
                }
                
                const atribuicoesUsuario37 = atribuicoes.filter(attr => attr.usuario_id == 37)
                
                resultDiv.innerHTML = `
                    <h3 class="success">‚úÖ Atribui√ß√µes Verificadas</h3>
                    <p><strong>Total de atribui√ß√µes:</strong> ${atribuicoes.length}</p>
                    <p><strong>Atribui√ß√µes para usu√°rio 37:</strong> ${atribuicoesUsuario37.length}</p>
                    
                    <h4>Atribui√ß√µes para Usu√°rio 37:</h4>
                    <ul>
                        ${atribuicoesUsuario37.map(attr => `
                            <li><strong>${attr.agente_nome}</strong> (Agente ID: ${attr.agente_id}) - Atribu√≠do por: ${attr.atribuido_por_nome}</li>
                        `).join('')}
                    </ul>
                    
                    <h4>Dados Completos das Atribui√ß√µes:</h4>
                    <pre>${JSON.stringify(atribuicoesUsuario37, null, 2)}</pre>
                `
                
            } catch (error) {
                console.error('‚ùå Erro ao verificar atribui√ß√µes:', error)
                resultDiv.innerHTML = `<p class="error">‚ùå Erro: ${error.message}</p>`
            }
        }

        function testarUploadPage() {
            const resultDiv = document.getElementById('upload-result')
            resultDiv.innerHTML = '<p class="info">üîÑ Abrindo p√°gina de upload...</p>'
            
            // Abrir a p√°gina de upload em nova aba
            window.open('http://localhost:5174/upload', '_blank')
            
            resultDiv.innerHTML = `
                <p class="success">‚úÖ P√°gina de upload aberta em nova aba</p>
                <p>Verifique se os agentes agora aparecem na p√°gina de upload.</p>
                <p>Se n√£o aparecerem, verifique o console do navegador para logs de debug.</p>
            `
        }

        // Auto-executar verifica√ß√£o inicial
        window.onload = function() {
            verificarAgentes()
        }
    </script>
</body>
</html>
