<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Webhook Agentes Simples</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #1a1a1a; color: #fff; }
        .container { max-width: 1000px; margin: 0 auto; }
        .section { background: #2a2a2a; padding: 20px; margin: 10px 0; border-radius: 8px; }
        .success { color: #4ade80; }
        .error { color: #f87171; }
        .warning { color: #fbbf24; }
        .info { color: #60a5fa; }
        button { background: #3b82f6; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #2563eb; }
        pre { background: #1e1e1e; padding: 15px; border-radius: 5px; overflow-x: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Debug Webhook Agentes Simples</h1>
        
        <div class="section">
            <h2>1. Testar Webhook Diretamente</h2>
            <button onclick="testarWebhook()">Testar Webhook</button>
            <div id="webhook"></div>
        </div>

        <div class="section">
            <h2>2. Testar com Dados Simulados</h2>
            <button onclick="testarDadosSimulados()">Testar Dados Simulados</button>
            <div id="simulados"></div>
        </div>
    </div>

    <script>
        async function testarWebhook() {
            const resultDiv = document.getElementById('webhook')
            resultDiv.innerHTML = '<p class="info">üîÑ Testando webhook...</p>'
            
            try {
                console.log('üöÄ Iniciando teste do webhook...')
                
                const response = await fetch('https://n8n.code-iq.com.br/webhook/list-agentes', {
                    method: 'GET',
                    headers: { 
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                })
                
                console.log('üì° Response recebida:', response)
                console.log('üìä Status:', response.status)
                console.log('üìã Headers:', response.headers)
                
                const text = await response.text()
                console.log('üìù Texto da resposta:', text)
                
                let data
                try {
                    data = JSON.parse(text)
                    console.log('üì¶ JSON parseado:', data)
                } catch (e) {
                    console.error('‚ùå Erro ao parsear JSON:', e)
                    resultDiv.innerHTML = `
                        <h3 class="error">‚ùå Erro ao parsear JSON</h3>
                        <p><strong>Status:</strong> ${response.status}</p>
                        <p><strong>Status Text:</strong> ${response.statusText}</p>
                        <p><strong>Resposta (texto):</strong></p>
                        <pre>${text}</pre>
                        <p><strong>Erro:</strong> ${e.message}</p>
                    `
                    return
                }
                
                const agentes = data.data || []
                
                resultDiv.innerHTML = `
                    <h3 class="success">‚úÖ Webhook Funcionando</h3>
                    <p><strong>Status:</strong> ${response.status}</p>
                    <p><strong>Success:</strong> ${data.success}</p>
                    <p><strong>Message:</strong> ${data.message}</p>
                    <p><strong>Total:</strong> ${data.total}</p>
                    <p><strong>Agentes encontrados:</strong> ${agentes.length}</p>
                    
                    <h4>Agentes:</h4>
                    <ul>
                        ${agentes.map(agente => `
                            <li>
                                <strong>${agente.nome}</strong> (ID: ${agente.id})
                                <br>Usu√°rio ID: ${agente.usuario_id}
                                <br>Ativo: ${agente.ativo ? 'Sim' : 'N√£o'}
                            </li>
                        `).join('')}
                    </ul>
                    
                    <h4>Resposta completa:</h4>
                    <pre>${JSON.stringify(data, null, 2)}</pre>
                `
                
            } catch (error) {
                console.error('‚ùå Erro no webhook:', error)
                resultDiv.innerHTML = `
                    <h3 class="error">‚ùå Erro na requisi√ß√£o</h3>
                    <p><strong>Erro:</strong> ${error.message}</p>
                    <p><strong>Tipo:</strong> ${error.name}</p>
                    <p><strong>Stack:</strong></p>
                    <pre>${error.stack}</pre>
                `
            }
        }

        function testarDadosSimulados() {
            const resultDiv = document.getElementById('simulados')
            
            // Dados simulados baseados no que sabemos
            const agentesSimulados = [
                {
                    id: 68,
                    nome: 'Joana',
                    usuario_id: 5,
                    ativo: true
                },
                {
                    id: 65,
                    nome: 'Jo√£o',
                    usuario_id: 6,
                    ativo: true
                },
                {
                    id: 74,
                    nome: 'Zeca',
                    usuario_id: 5,
                    ativo: true
                }
            ]
            
            // Simular usu√°rio padr√£o (ID: 6)
            const userData = {
                id: "6",
                name: "Usu√°rio Elleve Padr√£o",
                permissions: ['iniciar_agente', 'visualizar_status_do_agente']
            }
            
            const userId = parseInt(userData.id)
            const hasIniciarAgente = userData.permissions.includes('iniciar_agente')
            const hasVisualizarStatus = userData.permissions.includes('visualizar_status_do_agente')
            
            const agentPermissions = {
                canViewAll: false,
                canManage: false,
                canViewOwn: hasIniciarAgente || hasVisualizarStatus,
                canAssignAgents: false
            }
            
            // Aplicar filtro
            const agentesFiltrados = agentesSimulados.filter(agente => {
                if (agentPermissions.canViewAll || agentPermissions.canManage) {
                    return true
                }
                if (agentPermissions.canViewOwn) {
                    return agente.usuario_id === userId
                }
                if (agentPermissions.canAssignAgents) {
                    return agente.atribuido_para_usuario || agente.usuario_id === userId
                }
                return false
            })
            
            resultDiv.innerHTML = `
                <h3 class="info">üß™ Teste com Dados Simulados</h3>
                <p><strong>Usu√°rio:</strong> ${userData.name} (ID: ${userId})</p>
                <p><strong>Permiss√µes:</strong> ${userData.permissions.join(', ')}</p>
                
                <h4>Permiss√µes calculadas:</h4>
                <ul>
                    <li>canViewAll: ${agentPermissions.canViewAll}</li>
                    <li>canManage: ${agentPermissions.canManage}</li>
                    <li>canViewOwn: ${agentPermissions.canViewOwn}</li>
                    <li>canAssignAgents: ${agentPermissions.canAssignAgents}</li>
                </ul>
                
                <h4>Agentes simulados:</h4>
                <ul>
                    ${agentesSimulados.map(agente => `
                        <li>
                            <strong>${agente.nome}</strong> (ID: ${agente.id})
                            <br>usuario_id: ${agente.usuario_id}
                            <br>Deve mostrar: ${agente.usuario_id === userId ? '‚úÖ SIM' : '‚ùå N√ÉO'}
                        </li>
                    `).join('')}
                </ul>
                
                <h4>Agentes filtrados:</h4>
                <ul>
                    ${agentesFiltrados.map(agente => `
                        <li>
                            <strong>${agente.nome}</strong> (ID: ${agente.id})
                            <br>usuario_id: ${agente.usuario_id}
                        </li>
                    `).join('')}
                </ul>
                
                <h4>Conclus√£o:</h4>
                <p class="${agentesFiltrados.length === 1 && agentesFiltrados[0].nome === 'Jo√£o' ? 'success' : 'error'}">
                    ${agentesFiltrados.length === 1 && agentesFiltrados[0].nome === 'Jo√£o' ? 
                        '‚úÖ CORRETO: L√≥gica funciona com dados simulados' : 
                        '‚ùå INCORRETO: L√≥gica n√£o funciona com dados simulados'}
                </p>
            `
        }

        // Auto-executar
        window.onload = function() {
            testarWebhook()
        }
    </script>
</body>
</html>
